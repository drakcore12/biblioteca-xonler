<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <title>Iniciar Sesi√≥n - Xonler</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/css/main.css">
  <link rel="icon" href="/favicon.ico">
</head>
<body>
  <!-- Header cargado din√°micamente -->
  <div id="guest-header"></div>

  <main class="container flex-grow-1 d-flex align-items-center py-4">
    <div class="row justify-content-center w-100">
      <div class="col-12 col-sm-10 col-md-8 col-lg-6 col-xl-5">
        <div class="card login-card shadow-sm">
          <div class="card-header bg-white border-0 pb-0">
            <ul class="nav nav-tabs card-header-tabs">
              <li class="nav-item flex-fill text-center">
                <a class="nav-link active" id="login-tab" data-bs-toggle="tab" href="#login">Iniciar Sesi√≥n</a>
              </li>
              <li class="nav-item flex-fill text-center">
                <a class="nav-link" id="register-tab" data-bs-toggle="tab" href="#register">Registrarse</a>
              </li>
            </ul>
          </div>
          <div class="card-body">
            <div class="tab-content">
              <div class="tab-pane fade show active" id="login">
                <h3 class="mb-4">Iniciar Sesi√≥n</h3>
                <form id="loginForm" autocomplete="on">
                  <div class="mb-3">
                    <label for="loginEmail" class="form-label">Correo electr√≥nico</label>
                    <input type="email" class="form-control" id="loginEmail" name="email"
                           autocomplete="username" required>
                  </div>
                  <div class="mb-3">
                    <label for="loginPassword" class="form-label">Contrase√±a</label>
                    <input type="password" class="form-control" id="loginPassword" name="password"
                           autocomplete="current-password" required>
                  </div>
                  <div class="mb-3 form-check">
                    <input type="checkbox" class="form-check-input" id="rememberMe" name="remember"
                           autocomplete="off">
                    <label class="form-check-label" for="rememberMe">Recordarme</label>
                  </div>
                  <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                    <button type="submit" class="btn btn-primary flex-fill flex-sm-grow-0">Iniciar sesi√≥n</button>
                    <a href="#" class="text-decoration-none text-center flex-fill flex-sm-grow-0" data-bs-toggle="modal" data-bs-target="#forgotPasswordModal">¬øOlvidaste tu contrase√±a?</a>
                  </div>
                  
                </form>
              </div>

              <div class="tab-pane fade" id="register">
                <h3 class="mb-4">Crear Cuenta</h3>
                <form id="registerForm" autocomplete="on">
                  <div class="mb-3">
                    <label for="registerName" class="form-label">Nombre</label>
                    <input type="text" class="form-control" id="registerName" name="nombre"
                           autocomplete="given-name" required>
                  </div>
                  <div class="mb-3">
                    <label for="registerApellido" class="form-label">Apellido</label>
                    <input type="text" class="form-control" id="registerApellido" name="apellido"
                           autocomplete="family-name" required>
                  </div>
                  <div class="mb-3">
                    <label for="registerEmail" class="form-label">Correo electr√≥nico</label>
                    <input type="email" class="form-control" id="registerEmail" name="email"
                           autocomplete="email" required>
                  </div>
                  <div class="mb-3">
                    <label for="registerPassword" class="form-label">Contrase√±a</label>
                    <input type="password" class="form-control" id="registerPassword" name="password"
                           autocomplete="new-password" required minlength="6">
                  </div>
                  <div class="mb-3">
                    <label for="confirmPassword" class="form-label">Confirmar contrase√±a</label>
                    <input type="password" class="form-control" id="confirmPassword" name="confirmPassword"
                           autocomplete="new-password" required minlength="6">
                  </div>
                  <div class="mb-3 form-check">
                    <input type="checkbox" class="form-check-input" id="acceptTerms" name="acceptTerms"
                           autocomplete="off" required>
                    <label class="form-check-label" for="acceptTerms">Acepto los t√©rminos y condiciones</label>
                  </div>
                  <button type="submit" class="btn btn-primary">Registrarse</button>
                </form>
              </div>
            </div>
          </div>
        </div>

        
        </div>
      </div>
    </div>
  </main>

  <!-- Footer cargado din√°micamente -->
  <div id="guest-footer"></div>

  <!-- JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Scripts de autenticaci√≥n y login -->
  <script type="module">
    import { requireAnon } from '/js/common/guard.js';
    import { initLoginForm } from '/services/login.services.js';
    import { initRegistroForm, initPasswordValidation } from '/services/registro.services.js';
    import { loadGuestLayout } from '/services/component-loader.services.js';
    
    // Funci√≥n para inicializar la validaci√≥n
    function boot() {
      requireAnon(); // si hay sesi√≥n, lo saca del login
    }
    
    // Ejecutar al cargar la p√°gina
    document.addEventListener('DOMContentLoaded', async () => {
      // Cargar componentes de layout
      await loadGuestLayout('login');
      
      // Inicializar validaci√≥n
      boot();
      
      // Inicializar formularios
      initLoginForm(); // engancha el submit del login
      initRegistroForm(); // engancha el submit del registro
      initPasswordValidation(); // valida contrase√±a en tiempo real
      initForgotPassword(); // inicializar recuperaci√≥n de contrase√±a
    });
    
    // Ejecutar cuando la p√°gina vuelve a ser visible (por si usan bot√≥n atr√°s)
    document.addEventListener('visibilitychange', () => {
      if (document.visibilityState === 'visible') {
        requireAnon();
      }
    });
  </script>
  
  <!-- Script para mejorar autocompletado de contrase√±as -->
  <script>
    // Mejorar el reconocimiento de campos de contrase√±a
    document.addEventListener('DOMContentLoaded', function() {
      console.log('üîê Iniciando configuraci√≥n de autocompletado...');
      
      // Esperar un poco m√°s para que Bootstrap termine de inicializar
      setTimeout(() => {
        configurePasswordFields();
      }, 1000);
    });
    
    function configurePasswordFields() {
      console.log('üîê Configurando campos de contrase√±a...');
      
      // Configurar formulario de login
      const loginForm = document.getElementById('loginForm');
      if (loginForm) {
        const emailField = loginForm.querySelector('#loginEmail');
        const passwordField = loginForm.querySelector('#loginPassword');
        
        if (emailField && passwordField) {
          console.log('üîê Configurando campos de login...');
          
          // Configurar email
          emailField.setAttribute('autocomplete', 'username');
          emailField.setAttribute('data-lpignore', 'false');
          
          // Configurar contrase√±a con m√∫ltiples atributos
          passwordField.setAttribute('autocomplete', 'current-password');
          passwordField.setAttribute('data-lpignore', 'false');
          passwordField.setAttribute('data-1p-ignore', 'false');
          passwordField.setAttribute('data-ignore', 'false');
          
          // Agregar atributos espec√≠ficos del navegador
          passwordField.setAttribute('data-form-type', 'login');
          passwordField.setAttribute('data-bwignore', 'false');
          
          console.log('‚úÖ Campos de login configurados');
        }
      }
      
      // Configurar formulario de registro
      const registerForm = document.getElementById('registerForm');
      if (registerForm) {
        const nameField = registerForm.querySelector('#registerName');
        const apellidoField = registerForm.querySelector('#registerApellido');
        const emailField = registerForm.querySelector('#registerEmail');
        const passwordField = registerForm.querySelector('#registerPassword');
        const confirmField = registerForm.querySelector('#confirmPassword');
        
        if (nameField && apellidoField && emailField && passwordField && confirmField) {
          console.log('üîê Configurando campos de registro...');
          
          // Configurar nombre
          nameField.setAttribute('autocomplete', 'given-name');
          nameField.setAttribute('data-lpignore', 'false');
          
          // Configurar apellido
          apellidoField.setAttribute('autocomplete', 'family-name');
          apellidoField.setAttribute('data-lpignore', 'false');
          
          // Configurar email
          emailField.setAttribute('autocomplete', 'email');
          emailField.setAttribute('data-lpignore', 'false');
          
          // Configurar contrase√±as
          passwordField.setAttribute('autocomplete', 'new-password');
          passwordField.setAttribute('data-lpignore', 'false');
          passwordField.setAttribute('data-1p-ignore', 'false');
          passwordField.setAttribute('data-ignore', 'false');
          passwordField.setAttribute('data-form-type', 'register');
          
          confirmField.setAttribute('autocomplete', 'new-password');
          confirmField.setAttribute('data-lpignore', 'false');
          confirmField.setAttribute('data-1p-ignore', 'false');
          confirmField.setAttribute('data-ignore', 'false');
          confirmField.setAttribute('data-form-type', 'register');
          
          console.log('‚úÖ Campos de registro configurados');
        }
      }
      
      // Mejorar el comportamiento de los tabs
      const tabLinks = document.querySelectorAll('[data-bs-toggle="tab"]');
      tabLinks.forEach(tab => {
        tab.addEventListener('shown.bs.tab', function(e) {
          console.log('üîÑ Tab cambiado, reconfigurando campos...');
          
          // Reconfigurar campos despu√©s de cambiar de tab
          setTimeout(() => {
            configurePasswordFields();
          }, 200);
          
          // Enfocar el primer campo
          const targetId = e.target.getAttribute('href');
          const targetPane = document.querySelector(targetId);
          if (targetPane) {
            const firstInput = targetPane.querySelector('input[type="email"], input[type="text"]');
            if (firstInput) {
              setTimeout(() => firstInput.focus(), 100);
            }
          }
        });
      });
      
      console.log('üîê Configuraci√≥n de autocompletado completada');
    }
    
    // Funci√≥n para inicializar recuperaci√≥n de contrase√±a
    function initForgotPassword() {
      const sendResetBtn = document.getElementById('sendResetEmailBtn');
      const forgotForm = document.getElementById('forgotPasswordForm');
      const forgotEmail = document.getElementById('forgotEmail');
      const forgotAlert = document.getElementById('forgotPasswordAlert');
      
      if (!sendResetBtn || !forgotForm || !forgotEmail || !forgotAlert) {
        console.warn('‚ö†Ô∏è Elementos de recuperaci√≥n de contrase√±a no encontrados');
        return;
      }
      
      // Manejar env√≠o de email de recuperaci√≥n
      sendResetBtn.addEventListener('click', async function() {
        const email = forgotEmail.value.trim();
        
        if (!email) {
          showForgotPasswordAlert('Por favor ingresa tu correo electr√≥nico', 'danger');
          return;
        }
        
        if (!isValidEmail(email)) {
          showForgotPasswordAlert('Por favor ingresa un correo electr√≥nico v√°lido', 'danger');
          return;
        }
        
        // Mostrar loading
        setLoadingState(true);
        showForgotPasswordAlert('', 'info');
        
        try {
          const response = await fetch('/api/auth/forgot-password', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ email })
          });
          
          const data = await response.json();
          
          if (response.ok) {
            showForgotPasswordAlert(
              'Se ha enviado un enlace de recuperaci√≥n a tu correo electr√≥nico. Revisa tu bandeja de entrada y spam.',
              'success'
            );
            
            // Limpiar formulario y cerrar modal despu√©s de 3 segundos
            setTimeout(() => {
              forgotForm.reset();
              const modal = bootstrap.Modal.getInstance(document.getElementById('forgotPasswordModal'));
              if (modal) modal.hide();
            }, 3000);
            
          } else {
            showForgotPasswordAlert(
              data.message || 'Error al enviar el enlace de recuperaci√≥n. Intenta de nuevo.',
              'danger'
            );
          }
          
        } catch (error) {
          console.error('Error en recuperaci√≥n de contrase√±a:', error);
          showForgotPasswordAlert(
            'Error de conexi√≥n. Verifica tu internet e intenta de nuevo.',
            'danger'
          );
        } finally {
          setLoadingState(false);
        }
      });
      
      // Limpiar alertas al cambiar el email
      forgotEmail.addEventListener('input', function() {
        if (forgotAlert.classList.contains('d-none') === false) {
          forgotAlert.classList.add('d-none');
        }
      });
      
      // Limpiar formulario al cerrar modal
      const modal = document.getElementById('forgotPasswordModal');
      if (modal) {
        modal.addEventListener('hidden.bs.modal', function() {
          forgotForm.reset();
          forgotAlert.classList.add('d-none');
          setLoadingState(false);
        });
      }
    }
    
    // Funci√≥n para mostrar alertas en el modal
    function showForgotPasswordAlert(message, type) {
      const alert = document.getElementById('forgotPasswordAlert');
      if (!alert) return;
      
      alert.textContent = message;
      alert.className = `alert alert-${type}`;
      alert.classList.remove('d-none');
    }
    
    // Funci√≥n para manejar estado de loading
    function setLoadingState(loading) {
      const btn = document.getElementById('sendResetEmailBtn');
      const btnText = btn.querySelector('.btn-text');
      const spinner = btn.querySelector('.spinner-border');
      
      if (loading) {
        btn.disabled = true;
        btnText.classList.add('d-none');
        spinner.classList.remove('d-none');
      } else {
        btn.disabled = false;
        btnText.classList.remove('d-none');
        spinner.classList.add('d-none');
      }
    }
    
    // Funci√≥n para validar email
    function isValidEmail(email) {
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      return emailRegex.test(email);
    }
  </script>
  
  <!-- Script de debug temporal -->
  <script>
    // Funciones de debug
    function clearSession() {
      localStorage.clear();
      sessionStorage.clear();
      console.log('üóëÔ∏è Sesi√≥n limpiada');
      alert('Sesi√≥n limpiada. Ahora puedes probar el login con 2FA.');
    }
    
    
    document.addEventListener('DOMContentLoaded', function() {
        const debugBtn = document.getElementById('debugAuth');
        const clearSessionBtn = document.getElementById('clearSession');
        const simulateRoleBtn = document.getElementById('simulateRole');
        const debugInfo = document.getElementById('debugInfo');
        
        if (debugBtn && clearSessionBtn && simulateRoleBtn && debugInfo) {
          debugBtn.addEventListener('click', function() {
            const token = localStorage.getItem('token') || sessionStorage.getItem('token');
            const role = localStorage.getItem('role') || sessionStorage.getItem('role');
            const userName = localStorage.getItem('userName') || sessionStorage.getItem('userName');
            const userId = localStorage.getItem('userId') || sessionStorage.getItem('userId');
            
            debugInfo.innerHTML = `
              <strong>Estado de autenticaci√≥n:</strong><br>
              Token: ${token ? '‚úÖ Presente' : '‚ùå No encontrado'}<br>
              Rol: ${role || 'No encontrado'}<br>
              Usuario: ${userName || 'No encontrado'}<br>
              ID: ${userId || 'No encontrado'}<br>
              <br>
              <strong>Storage:</strong><br>
              localStorage: ${localStorage.getItem('token') ? '‚úÖ' : '‚ùå'}<br>
              sessionStorage: ${sessionStorage.getItem('token') ? '‚úÖ' : '‚ùå'}
            `;
            debugInfo.style.display = 'block';
          });
          
          clearSessionBtn.addEventListener('click', function() {
            localStorage.removeItem('token');
            localStorage.removeItem('role');
            localStorage.removeItem('userName');
            localStorage.removeItem('userId');
            sessionStorage.removeItem('token');
            sessionStorage.removeItem('role');
            sessionStorage.removeItem('userName');
            sessionStorage.removeItem('userId');
            console.log('üóëÔ∏è Sesi√≥n limpiada.');
            alert('Sesi√≥n limpiada. Ahora puedes probar desde cero.');
            window.location.reload();
          });
          
          simulateRoleBtn.addEventListener('click', function() {
            const role = prompt('Ingresa el rol a simular (usuario, admin, adminadvanced):', 'usuario');
            if (role) {
              localStorage.setItem('role', role.toLowerCase());
              localStorage.setItem('token', 'simulated-token');
              console.log('üé≠ Rol simulado:', role);
              alert(`Rol simulado como: ${role}. Recarga la p√°gina para ver el efecto.`);
            }
          });
          
          
          // Bot√≥n para verificar roles en la base de datos
          const checkRolesBtn = document.getElementById('checkRoles');
          if (checkRolesBtn) {
            checkRolesBtn.addEventListener('click', async function() {
              console.log('üìä [ROLES] Verificando roles en la base de datos...');
              try {
                const response = await fetch('/api/roles/public');
                if (response.ok) {
                  const roles = await response.json();
                  console.log('üìä [ROLES] Roles encontrados:', roles);
                  
                  // Mostrar en el debugInfo
                  const rolesInfo = roles.map(r => `ID: ${r.id}, Nombre: ${r.name}`).join('<br>');
                  debugInfo.innerHTML = `
                    <strong>Roles en la base de datos:</strong><br>
                    ${rolesInfo}<br><br>
                    <strong>Estado de autenticaci√≥n:</strong><br>
                    Token: ${localStorage.getItem('token') ? '‚úÖ Presente' : '‚ùå No encontrado'}<br>
                    Rol: ${localStorage.getItem('role') || 'No encontrado'}<br>
                    Usuario: ${localStorage.getItem('userName') || 'No encontrado'}<br>
                    ID: ${localStorage.getItem('userId') || 'No encontrado'}
                  `;
                  debugInfo.style.display = 'block';
                } else {
                  console.error('üìä [ROLES] Error obteniendo roles:', response.status);
                }
              } catch (error) {
                console.error('üìä [ROLES] Error:', error);
              }
            });
          }
        }
      });
  </script>
  
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Modal de recuperaci√≥n de contrase√±a -->
  <div class="modal fade" id="forgotPasswordModal" tabindex="-1" aria-labelledby="forgotPasswordModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="forgotPasswordModalLabel">Recuperar Contrase√±a</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <form id="forgotPasswordForm">
            <div class="mb-3">
              <label for="forgotEmail" class="form-label">Correo electr√≥nico</label>
              <input type="email" class="form-control" id="forgotEmail" name="email" 
                     placeholder="Ingresa tu correo electr√≥nico" required>
              <div class="form-text">Te enviaremos un enlace para restablecer tu contrase√±a.</div>
            </div>
            <div id="forgotPasswordAlert" class="alert d-none" role="alert"></div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-primary" id="sendResetEmailBtn">
            <span class="btn-text">Enviar enlace</span>
            <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="toast-container position-fixed top-0 end-0 p-3">
    <div id="loginToast" class="toast align-items-center text-bg-danger border-0" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body" id="loginToastBody">Error</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Cerrar"></button>
      </div>
    </div>
  </div>
</body>
</html>
