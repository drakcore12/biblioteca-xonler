<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <title>Iniciar Sesión - Xonler</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/css/main.css">
  <link rel="icon" href="/favicon.ico">
</head>
<body>
  <header class="bg-dark text-white py-3">
    <div class="container">
      <div class="row align-items-center">
        <div class="col-6 col-md-4">
          <h1 class="m-0 fs-3 fs-md-2">Xonler</h1>
        </div>
        <div class="col-6 col-md-8">
          <nav class="navbar navbar-expand-lg navbar-dark p-0">
            <button class="navbar-toggler ms-auto" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
              aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
              <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse mt-2 mt-lg-0" id="navbarNav">
              <ul class="navbar-nav ms-auto text-center">
                <li class="nav-item"><a class="nav-link px-3" href="/pages/guest/index.html">Inicio</a></li>
                <li class="nav-item"><a class="nav-link px-3" href="/pages/guest/contacto.html">Contacto</a></li>
                <li class="nav-item"><a class="nav-link px-3" href="/pages/guest/bibliotecas.html">Bibliotecas</a></li>
                <li class="nav-item"><a class="nav-link active px-3" href="/pages/guest/login.html">Iniciar Sesión</a></li>
              </ul>
            </div>
          </nav>
        </div>
      </div>
    </div>
  </header>

  <main class="container flex-grow-1 d-flex align-items-center py-4">
    <div class="row justify-content-center w-100">
      <div class="col-11 col-sm-10 col-md-8 col-lg-6">
        <div class="card login-card shadow-sm">
          <div class="card-header bg-white border-0 pb-0">
            <ul class="nav nav-tabs card-header-tabs">
              <li class="nav-item flex-fill text-center">
                <a class="nav-link active" id="login-tab" data-bs-toggle="tab" href="#login">Iniciar Sesión</a>
              </li>
              <li class="nav-item flex-fill text-center">
                <a class="nav-link" id="register-tab" data-bs-toggle="tab" href="#register">Registrarse</a>
              </li>
            </ul>
          </div>
          <div class="card-body">
            <div class="tab-content">
              <div class="tab-pane fade show active" id="login">
                <h3 class="mb-4">Iniciar Sesión</h3>
                <form id="loginForm" autocomplete="on">
                  <div class="mb-3">
                    <label for="loginEmail" class="form-label">Correo electrónico</label>
                    <input type="email" class="form-control" id="loginEmail" name="email"
                           autocomplete="username" required>
                  </div>
                  <div class="mb-3">
                    <label for="loginPassword" class="form-label">Contraseña</label>
                    <input type="password" class="form-control" id="loginPassword" name="password"
                           autocomplete="current-password" required>
                  </div>
                  <div class="mb-3 form-check">
                    <input type="checkbox" class="form-check-input" id="rememberMe" name="remember"
                           autocomplete="off">
                    <label class="form-check-label" for="rememberMe">Recordarme</label>
                  </div>
                  <div class="d-flex justify-content-between align-items-center">
                    <button type="submit" class="btn btn-primary">Iniciar sesión</button>
                    <a href="#" class="text-decoration-none">¿Olvidaste tu contraseña?</a>
                  </div>
                  
                  <!-- Debug temporal -->
                  <div class="mt-3">
                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="clearSession()">Limpiar Sesión</button>
                    <button type="button" class="btn btn-outline-info btn-sm" onclick="testLogin()">Test Login</button>
                  </div>
                </form>
              </div>

              <div class="tab-pane fade" id="register">
                <h3 class="mb-4">Crear Cuenta</h3>
                <form id="registerForm" autocomplete="on">
                  <div class="mb-3">
                    <label for="registerName" class="form-label">Nombre</label>
                    <input type="text" class="form-control" id="registerName" name="nombre"
                           autocomplete="given-name" required>
                  </div>
                  <div class="mb-3">
                    <label for="registerApellido" class="form-label">Apellido</label>
                    <input type="text" class="form-control" id="registerApellido" name="apellido"
                           autocomplete="family-name" required>
                  </div>
                  <div class="mb-3">
                    <label for="registerEmail" class="form-label">Correo electrónico</label>
                    <input type="email" class="form-control" id="registerEmail" name="email"
                           autocomplete="email" required>
                  </div>
                  <div class="mb-3">
                    <label for="registerPassword" class="form-label">Contraseña</label>
                    <input type="password" class="form-control" id="registerPassword" name="password"
                           autocomplete="new-password" required minlength="6">
                  </div>
                  <div class="mb-3">
                    <label for="confirmPassword" class="form-label">Confirmar contraseña</label>
                    <input type="password" class="form-control" id="confirmPassword" name="confirmPassword"
                           autocomplete="new-password" required minlength="6">
                  </div>
                  <div class="mb-3 form-check">
                    <input type="checkbox" class="form-check-input" id="acceptTerms" name="acceptTerms"
                           autocomplete="off" required>
                    <label class="form-check-label" for="acceptTerms">Acepto los términos y condiciones</label>
                  </div>
                  <button type="submit" class="btn btn-primary">Registrarse</button>
                </form>
              </div>
            </div>
          </div>
        </div>

        
        </div>
      </div>
    </div>
  </main>

  <footer class="bg-dark text-white py-4 mt-auto">
    <div class="container">
      <div class="row gy-4">
        <div class="col-12 col-sm-6 col-md-4 text-center text-sm-start">
          <h4 class="h5">Xonler</h4>
          <p class="mb-0">Red de bibliotecas estudiantiles</p>
        </div>
        <div class="col-12 col-sm-6 col-md-4 text-center text-sm-start">
          <h5 class="h6 mb-3">Enlaces</h5>
          <ul class="list-unstyled mb-0">
            <li class="mb-2"><a href="/pages/guest/index.html" class="text-white text-decoration-none">Inicio</a></li>
            <li class="mb-2"><a href="/pages/guest/contacto.html" class="text-white text-decoration-none">Contacto</a></li>
            <li class="mb-2"><a href="/pages/guest/login.html" class="text-white text-decoration-none">Iniciar Sesión</a></li>
          </ul>
        </div>
        <div class="col-12 col-sm-6 col-md-4 text-center text-sm-start">
          <h5 class="h6 mb-3">Contacto</h5>
          <address class="mb-0">
            <a href="mailto:info@xonler.edu" class="text-white text-decoration-none d-block mb-2">info@xonler.edu</a>
            <a href="tel:+1234567890" class="text-white text-decoration-none">(123) 456-7890</a>
          </address>
        </div>
      </div>
      <hr class="my-4">
      <div class="text-center">
        <small class="text-white-50">&copy; 2025 Xonler - Red de Bibliotecas Estudiantiles</small>
      </div>
    </div>
  </footer>

  <!-- JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Scripts de autenticación y login -->
  <script type="module">
    import { requireAnon } from '/js/common/guard.js';
    import { initLoginForm } from '/services/login.services.js';
    import { initRegistroForm, initPasswordValidation } from '/services/registro.services.js';
    
    // Función para inicializar la validación
    function boot() {
      requireAnon(); // si hay sesión, lo saca del login
    }
    
    // Ejecutar al cargar la página
    document.addEventListener('DOMContentLoaded', boot, { once: true });
    
    // Ejecutar cuando la página vuelve a ser visible (por si usan botón atrás)
    document.addEventListener('visibilitychange', () => {
      if (document.visibilityState === 'visible') {
        requireAnon();
      }
    });
    
    // Inicializar formularios
    initLoginForm(); // engancha el submit del login
    initRegistroForm(); // engancha el submit del registro
    initPasswordValidation(); // valida contraseña en tiempo real
  </script>
  
  <!-- Script para mejorar autocompletado de contraseñas -->
  <script>
    // Mejorar el reconocimiento de campos de contraseña
    document.addEventListener('DOMContentLoaded', function() {
      console.log('🔐 Iniciando configuración de autocompletado...');
      
      // Esperar un poco más para que Bootstrap termine de inicializar
      setTimeout(() => {
        configurePasswordFields();
      }, 1000);
    });
    
    function configurePasswordFields() {
      console.log('🔐 Configurando campos de contraseña...');
      
      // Configurar formulario de login
      const loginForm = document.getElementById('loginForm');
      if (loginForm) {
        const emailField = loginForm.querySelector('#loginEmail');
        const passwordField = loginForm.querySelector('#loginPassword');
        
        if (emailField && passwordField) {
          console.log('🔐 Configurando campos de login...');
          
          // Configurar email
          emailField.setAttribute('autocomplete', 'username');
          emailField.setAttribute('data-lpignore', 'false');
          
          // Configurar contraseña con múltiples atributos
          passwordField.setAttribute('autocomplete', 'current-password');
          passwordField.setAttribute('data-lpignore', 'false');
          passwordField.setAttribute('data-1p-ignore', 'false');
          passwordField.setAttribute('data-ignore', 'false');
          
          // Agregar atributos específicos del navegador
          passwordField.setAttribute('data-form-type', 'login');
          passwordField.setAttribute('data-bwignore', 'false');
          
          console.log('✅ Campos de login configurados');
        }
      }
      
      // Configurar formulario de registro
      const registerForm = document.getElementById('registerForm');
      if (registerForm) {
        const nameField = registerForm.querySelector('#registerName');
        const apellidoField = registerForm.querySelector('#registerApellido');
        const emailField = registerForm.querySelector('#registerEmail');
        const passwordField = registerForm.querySelector('#registerPassword');
        const confirmField = registerForm.querySelector('#confirmPassword');
        
        if (nameField && apellidoField && emailField && passwordField && confirmField) {
          console.log('🔐 Configurando campos de registro...');
          
          // Configurar nombre
          nameField.setAttribute('autocomplete', 'given-name');
          nameField.setAttribute('data-lpignore', 'false');
          
          // Configurar apellido
          apellidoField.setAttribute('autocomplete', 'family-name');
          apellidoField.setAttribute('data-lpignore', 'false');
          
          // Configurar email
          emailField.setAttribute('autocomplete', 'email');
          emailField.setAttribute('data-lpignore', 'false');
          
          // Configurar contraseñas
          passwordField.setAttribute('autocomplete', 'new-password');
          passwordField.setAttribute('data-lpignore', 'false');
          passwordField.setAttribute('data-1p-ignore', 'false');
          passwordField.setAttribute('data-ignore', 'false');
          passwordField.setAttribute('data-form-type', 'register');
          
          confirmField.setAttribute('autocomplete', 'new-password');
          confirmField.setAttribute('data-lpignore', 'false');
          confirmField.setAttribute('data-1p-ignore', 'false');
          confirmField.setAttribute('data-ignore', 'false');
          confirmField.setAttribute('data-form-type', 'register');
          
          console.log('✅ Campos de registro configurados');
        }
      }
      
      // Mejorar el comportamiento de los tabs
      const tabLinks = document.querySelectorAll('[data-bs-toggle="tab"]');
      tabLinks.forEach(tab => {
        tab.addEventListener('shown.bs.tab', function(e) {
          console.log('🔄 Tab cambiado, reconfigurando campos...');
          
          // Reconfigurar campos después de cambiar de tab
          setTimeout(() => {
            configurePasswordFields();
          }, 200);
          
          // Enfocar el primer campo
          const targetId = e.target.getAttribute('href');
          const targetPane = document.querySelector(targetId);
          if (targetPane) {
            const firstInput = targetPane.querySelector('input[type="email"], input[type="text"]');
            if (firstInput) {
              setTimeout(() => firstInput.focus(), 100);
            }
          }
        });
      });
      
      console.log('🔐 Configuración de autocompletado completada');
    }
  </script>
  
  <!-- Script de debug temporal -->
  <script>
    // Funciones de debug
    function clearSession() {
      localStorage.clear();
      sessionStorage.clear();
      console.log('🗑️ Sesión limpiada');
      alert('Sesión limpiada. Ahora puedes probar el login con 2FA.');
    }
    
    async function testLogin() {
      try {
        console.log('🧪 [TEST] Probando login con 2FA...');
        const response = await fetch('/api/usuarios/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            email: 'luiseduardo1913@gmail.com', 
            password: 'Ma2004-13' 
          })
        });
        
        const data = await response.json();
        console.log('🧪 [TEST] Respuesta del login:', data);
        
        if (data.pending2faToken) {
          alert('✅ 2FA detectado correctamente! Se requiere código 2FA.');
        } else {
          alert('❌ 2FA NO detectado. Login normal sin 2FA.');
        }
      } catch (error) {
        console.error('🧪 [TEST] Error:', error);
        alert('Error en el test: ' + error.message);
      }
    }
    
    document.addEventListener('DOMContentLoaded', function() {
        const debugBtn = document.getElementById('debugAuth');
        const clearSessionBtn = document.getElementById('clearSession');
        const simulateRoleBtn = document.getElementById('simulateRole');
        const debugInfo = document.getElementById('debugInfo');
        
        if (debugBtn && clearSessionBtn && simulateRoleBtn && debugInfo) {
          debugBtn.addEventListener('click', function() {
            const token = localStorage.getItem('token') || sessionStorage.getItem('token');
            const role = localStorage.getItem('role') || sessionStorage.getItem('role');
            const userName = localStorage.getItem('userName') || sessionStorage.getItem('userName');
            const userId = localStorage.getItem('userId') || sessionStorage.getItem('userId');
            
            debugInfo.innerHTML = `
              <strong>Estado de autenticación:</strong><br>
              Token: ${token ? '✅ Presente' : '❌ No encontrado'}<br>
              Rol: ${role || 'No encontrado'}<br>
              Usuario: ${userName || 'No encontrado'}<br>
              ID: ${userId || 'No encontrado'}<br>
              <br>
              <strong>Storage:</strong><br>
              localStorage: ${localStorage.getItem('token') ? '✅' : '❌'}<br>
              sessionStorage: ${sessionStorage.getItem('token') ? '✅' : '❌'}
            `;
            debugInfo.style.display = 'block';
          });
          
          clearSessionBtn.addEventListener('click', function() {
            localStorage.removeItem('token');
            localStorage.removeItem('role');
            localStorage.removeItem('userName');
            localStorage.removeItem('userId');
            sessionStorage.removeItem('token');
            sessionStorage.removeItem('role');
            sessionStorage.removeItem('userName');
            sessionStorage.removeItem('userId');
            console.log('🗑️ Sesión limpiada.');
            alert('Sesión limpiada. Ahora puedes probar desde cero.');
            window.location.reload();
          });
          
          simulateRoleBtn.addEventListener('click', function() {
            const role = prompt('Ingresa el rol a simular (usuario, admin, adminadvanced):', 'usuario');
            if (role) {
              localStorage.setItem('role', role.toLowerCase());
              localStorage.setItem('token', 'simulated-token');
              console.log('🎭 Rol simulado:', role);
              alert(`Rol simulado como: ${role}. Recarga la página para ver el efecto.`);
            }
          });
          
          // Botón para testear el guard
          const testGuardBtn = document.getElementById('testGuard');
          if (testGuardBtn) {
            testGuardBtn.addEventListener('click', async function() {
              console.log('🧪 [TEST] Probando guard...');
              try {
                const { requireAnon } = await import('/js/common/guard.js');
                console.log('🧪 [TEST] Guard importado, ejecutando requireAnon...');
                await requireAnon();
              } catch (error) {
                console.error('🧪 [TEST] Error ejecutando guard:', error);
              }
            });
          }
          
          // Botón para verificar roles en la base de datos
          const checkRolesBtn = document.getElementById('checkRoles');
          if (checkRolesBtn) {
            checkRolesBtn.addEventListener('click', async function() {
              console.log('📊 [ROLES] Verificando roles en la base de datos...');
              try {
                const response = await fetch('/api/roles/public');
                if (response.ok) {
                  const roles = await response.json();
                  console.log('📊 [ROLES] Roles encontrados:', roles);
                  
                  // Mostrar en el debugInfo
                  const rolesInfo = roles.map(r => `ID: ${r.id}, Nombre: ${r.name}`).join('<br>');
                  debugInfo.innerHTML = `
                    <strong>Roles en la base de datos:</strong><br>
                    ${rolesInfo}<br><br>
                    <strong>Estado de autenticación:</strong><br>
                    Token: ${localStorage.getItem('token') ? '✅ Presente' : '❌ No encontrado'}<br>
                    Rol: ${localStorage.getItem('role') || 'No encontrado'}<br>
                    Usuario: ${localStorage.getItem('userName') || 'No encontrado'}<br>
                    ID: ${localStorage.getItem('userId') || 'No encontrado'}
                  `;
                  debugInfo.style.display = 'block';
                } else {
                  console.error('📊 [ROLES] Error obteniendo roles:', response.status);
                }
              } catch (error) {
                console.error('📊 [ROLES] Error:', error);
              }
            });
          }
        }
      });
  </script>
  
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3/dist/js/bootstrap.bundle.min.js"></script>

  <div class="toast-container position-fixed top-0 end-0 p-3">
    <div id="loginToast" class="toast align-items-center text-bg-danger border-0" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body" id="loginToastBody">Error</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Cerrar"></button>
      </div>
    </div>
  </div>
</body>
</html>
