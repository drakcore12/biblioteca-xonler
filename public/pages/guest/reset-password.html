<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <title>Restablecer Contraseña - Xonler</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/css/main.css">
  <link rel="icon" href="/favicon.ico">
</head>
<body>
      <!-- Header cargado dinámicamente -->
    <div id="guest-header"></div>

  <main class="container flex-grow-1 d-flex align-items-center py-4">
    <div class="row justify-content-center w-100">
      <div class="col-11 col-sm-10 col-md-8 col-lg-6">
        <div class="card shadow-sm">
          <div class="card-body">
            <h3 class="mb-4 text-center">Restablecer Contraseña</h3>
            
            <!-- Estado de carga -->
            <div id="loadingState" class="text-center">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Verificando enlace...</span>
              </div>
              <p class="mt-2">Verificando enlace de recuperación...</p>
            </div>

            <!-- Formulario de reset -->
            <div id="resetForm" class="d-none">
              <form id="passwordResetForm">
                <div class="mb-3">
                  <label for="newPassword" class="form-label">Nueva contraseña</label>
                  <input type="password" class="form-control" id="newPassword" name="password" 
                         autocomplete="new-password" required minlength="6">
                  <div class="form-text">Mínimo 6 caracteres</div>
                </div>
                <div class="mb-3">
                  <label for="confirmPassword" class="form-label">Confirmar nueva contraseña</label>
                  <input type="password" class="form-control" id="confirmPassword" name="confirmPassword" 
                         autocomplete="new-password" required minlength="6">
                </div>
                <div id="passwordAlert" class="alert d-none" role="alert"></div>
                <div class="d-grid">
                  <button type="submit" class="btn btn-primary" id="resetPasswordBtn">
                    <span class="btn-text">Restablecer contraseña</span>
                    <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                  </button>
                </div>
              </form>
            </div>

            <!-- Estado de éxito -->
            <div id="successState" class="d-none text-center">
              <div class="alert alert-success">
                <h5 class="alert-heading">¡Contraseña restablecida!</h5>
                <p class="mb-0">Tu contraseña ha sido actualizada correctamente.</p>
              </div>
              <a href="/pages/guest/login.html" class="btn btn-primary">Iniciar Sesión</a>
            </div>

            <!-- Estado de error -->
            <div id="errorState" class="d-none text-center">
              <div class="alert alert-danger">
                <h5 class="alert-heading">Enlace inválido o expirado</h5>
                <p class="mb-0">Este enlace de recuperación no es válido o ha expirado.</p>
              </div>
              <a href="/pages/guest/login.html" class="btn btn-primary">Volver al Login</a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

      <!-- Footer cargado dinámicamente -->
    <div id="guest-footer"></div>

  <!-- JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

  <script type="module">
        import { loadGuestLayout } from '../../services/component-loader.services.js';
    
    // Inicializar página
    document.addEventListener('DOMContentLoaded', async () => {
      // Cargar componentes de layout
      await loadGuestLayout('reset-password');
      
      // Obtener token de la URL
      const urlParams = new URLSearchParams(window.location.search);
      const token = urlParams.get('token');
      
      if (!token) {
        showErrorState('No se proporcionó token de recuperación');
        return;
      }
      
      // Verificar token y mostrar formulario
      verifyToken(token);
    });
    
    // Función para verificar el token
    async function verifyToken(token) {
      try {
        const response = await fetch('/api/auth/verify-reset-token', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ token })
        });
        
        const data = await response.json();
        
        if (response.ok) {
          showResetForm();
        } else {
          showErrorState(data.message || 'Token inválido o expirado');
        }
        
      } catch (error) {
        console.error('Error verificando token:', error);
        showErrorState('Error de conexión. Intenta de nuevo.');
      }
    }
    
    // Función para mostrar el formulario de reset
    function showResetForm() {
      document.getElementById('loadingState').classList.add('d-none');
      document.getElementById('resetForm').classList.remove('d-none');
      
      // Configurar formulario
      setupResetForm();
    }
    
    // Función para mostrar estado de error
    function showErrorState(message) {
      document.getElementById('loadingState').classList.add('d-none');
      document.getElementById('errorState').classList.remove('d-none');
      
      const errorAlert = document.querySelector('#errorState .alert');
      if (errorAlert) {
        errorAlert.querySelector('p').textContent = message;
      }
    }
    
    // Función para configurar el formulario de reset
    function setupResetForm() {
      const form = document.getElementById('passwordResetForm');
      const resetBtn = document.getElementById('resetPasswordBtn');
      
      form.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const newPassword = document.getElementById('newPassword').value;
        const confirmPassword = document.getElementById('confirmPassword').value;
        
        // Validaciones
        if (newPassword.length < 6) {
          showPasswordAlert('La contraseña debe tener al menos 6 caracteres', 'danger');
          return;
        }
        
        if (newPassword !== confirmPassword) {
          showPasswordAlert('Las contraseñas no coinciden', 'danger');
          return;
        }
        
        // Enviar nueva contraseña
        await resetPassword(token, newPassword);
      });
    }
    
    // Función para resetear la contraseña
    async function resetPassword(token, newPassword) {
      const resetBtn = document.getElementById('resetPasswordBtn');
      const btnText = resetBtn.querySelector('.btn-text');
      const spinner = resetBtn.querySelector('.spinner-border');
      
      // Mostrar loading
      resetBtn.disabled = true;
      btnText.classList.add('d-none');
      spinner.classList.remove('d-none');
      
      try {
        const response = await fetch('/api/auth/reset-password', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ token, password: newPassword })
        });
        
        const data = await response.json();
        
        if (response.ok) {
          // Mostrar estado de éxito
          document.getElementById('resetForm').classList.add('d-none');
          document.getElementById('successState').classList.remove('d-none');
        } else {
          showPasswordAlert(data.message || 'Error al restablecer la contraseña', 'danger');
        }
        
      } catch (error) {
        console.error('Error reseteando contraseña:', error);
        showPasswordAlert('Error de conexión. Intenta de nuevo.', 'danger');
      } finally {
        // Ocultar loading
        resetBtn.disabled = false;
        btnText.classList.remove('d-none');
        spinner.classList.add('d-none');
      }
    }
    
    // Función para mostrar alertas de contraseña
    function showPasswordAlert(message, type) {
      const alert = document.getElementById('passwordAlert');
      alert.textContent = message;
      alert.className = `alert alert-${type}`;
      alert.classList.remove('d-none');
    }
  </script>
</body>
</html>
