<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="../../css/main.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@2.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <title>Estad√≠sticas - Xonler Admin</title>
    
    <style>
        /* Estilos personalizados para los gr√°ficos */
        .chart-container {
            position: relative;
            width: 100%;
        }
        
        .card {
            transition: all 0.3s ease;
            border: 1px solid #e9ecef;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        }
        
        .card:hover {
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
            transform: translateY(-2px);
        }
        
        .card-header {
            background-color: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
            font-weight: 600;
        }
        
        .btn-group .btn {
            transition: all 0.2s ease;
        }
        
        .btn-group .btn.active {
            background-color: #0d6efd;
            border-color: #0d6efd;
            color: white;
        }
        
        /* Animaciones de carga */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .card {
            animation: fadeInUp 0.6s ease-out;
        }
        
        .card:nth-child(1) { animation-delay: 0.1s; }
        .card:nth-child(2) { animation-delay: 0.2s; }
        .card:nth-child(3) { animation-delay: 0.3s; }
        .card:nth-child(4) { animation-delay: 0.4s; }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .chart-container {
                height: 250px !important;
            }
            
            .card-header h5 {
                font-size: 1rem;
            }
        }
        
        /* Loading states */
        .loading-placeholder {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }
        
        @keyframes loading {
            0% {
                background-position: 200% 0;
            }
            100% {
                background-position: -200% 0;
            }
        }
    </style>
</head>
<body>
    <!-- Navbar m√≥vil -->
    <nav class="navbar navbar-dark bg-dark d-md-none mobile-top-nav">
        <div class="container-fluid">
            <a class="navbar-brand" href="index.html">Xonler Admin</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#sidebarMenu" aria-controls="sidebarMenu" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="dropdown ms-auto">
                <button class="btn btn-dark dropdown-toggle" type="button" id="dropdownMenuButton" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="bi bi-person-circle"></i>
                </button>
                <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdownMenuButton">
                    <li><a class="dropdown-item" href="index.html">Dashboard</a></li>
                    <li><a class="dropdown-item" href="libros.html">Libros</a></li>
                    <li><a class="dropdown-item" href="prestamos.html">Pr√©stamos</a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item" href="#" onclick="logout()">Cerrar sesi√≥n</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <nav id="sidebarMenu" class="col-md-3 col-lg-2 d-md-block bg-dark sidebar collapse">
                <div class="position-sticky sidebar-sticky">
                    <div class="p-3 text-white">
                        <h4>Xonler Admin</h4>
                        <p class="small">Panel de administraci√≥n</p>
                    </div>
                    <hr class="text-white">
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link text-white" href="index.html">
                                <i class="bi bi-speedometer2 me-2"></i> Dashboard
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link text-white" href="libros.html">
                                <i class="bi bi-journals me-2"></i> Gesti√≥n de Libros
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link text-white" href="prestamos.html">
                                <i class="bi bi-arrow-left-right me-2"></i> Pr√©stamos
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link text-white active" href="estadisticas.html">
                                <i class="bi bi-graph-up me-2"></i> Estad√≠sticas
                            </a>
                        </li>
                    </ul>
                    <hr class="text-white">
                    <div class="px-3">
                        <a class="btn btn-sm btn-outline-light w-100" href="../index.html">
                            <i class="bi bi-box-arrow-left me-2"></i> Volver al sitio
                        </a>
                    </div>
                </div>
            </nav>

            <!-- Contenido principal -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <!-- Header -->
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">Estad√≠sticas de Biblioteca</h1>
                    <div class="btn-toolbar mb-2 mb-md-0">
                        <button class="btn btn-outline-primary" onclick="exportarEstadisticas()">
                            <i class="bi bi-download me-2"></i>Exportar
                        </button>
                    </div>
                </div>

                <!-- Loading spinner -->
                <div id="loading-spinner" class="text-center py-5" style="display: none;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                    <p class="mt-2">Cargando estad√≠sticas...</p>
                </div>

                <!-- Error message -->
                <div id="error-message" class="alert alert-danger" style="display: none;">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    <span id="error-text"></span>
                </div>

                <!-- Resumen general -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card bg-primary text-white">
                            <div class="card-body">
                                <div class="d-flex justify-content-between">
                                    <div>
                                        <h6 class="card-title">Total Libros</h6>
                                        <h3 id="total-libros">0</h3>
                                    </div>
                                    <i class="bi bi-journals fs-1"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-success text-white">
                            <div class="card-body">
                                <div class="d-flex justify-content-between">
                                    <div>
                                        <h6 class="card-title">Pr√©stamos Activos</h6>
                                        <h3 id="prestamos-activos">0</h3>
                                    </div>
                                    <i class="bi bi-arrow-left-right fs-1"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-warning text-white">
                            <div class="card-body">
                                <div class="d-flex justify-content-between">
                                    <div>
                                        <h6 class="card-title">Total Pr√©stamos</h6>
                                        <h3 id="total-prestamos">0</h3>
                                    </div>
                                    <i class="bi bi-graph-up fs-1"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-info text-white">
                            <div class="card-body">
                                <div class="d-flex justify-content-between">
                                    <div>
                                        <h6 class="card-title">Usuarios √önicos</h6>
                                        <h3 id="usuarios-unicos">0</h3>
                                    </div>
                                    <i class="bi bi-people fs-1"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Gr√°ficos principales - Grid responsive -->
                <div class="row g-4 mb-4">
                    <!-- Gr√°fico de tendencia de pr√©stamos -->
                    <div class="col-12 col-xl-8">
                        <div class="card h-100">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">
                                    <i class="bi bi-graph-up me-2"></i>Tendencia de Pr√©stamos (√öltimos 12 meses)
                                </h5>
                                <div class="btn-group btn-group-sm" role="group">
                                    <button type="button" class="btn btn-outline-primary active" onclick="cambiarVistaGrafico('line')">L√≠nea</button>
                                    <button type="button" class="btn btn-outline-primary" onclick="cambiarVistaGrafico('bar')">Barras</button>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="chart-container" style="position: relative; height: 400px;">
                                    <canvas id="prestamosChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Gr√°fico de distribuci√≥n por categor√≠as -->
                    <div class="col-12 col-xl-4">
                        <div class="card h-100">
                            <div class="card-header">
                                <h5 class="mb-0">
                                    <i class="bi bi-pie-chart me-2"></i>Libros por Categor√≠a
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="chart-container" style="position: relative; height: 300px;">
                                    <canvas id="categoriasChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Segunda fila de gr√°ficos -->
                <div class="row g-4 mb-4">
                    <!-- Estado de pr√©stamos -->
                    <div class="col-12 col-lg-6">
                        <div class="card h-100">
                            <div class="card-header">
                                <h5 class="mb-0">
                                    <i class="bi bi-check-circle me-2"></i>Estado de Pr√©stamos
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="chart-container" style="position: relative; height: 300px;">
                                    <canvas id="estadoPrestamosChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Actividad por d√≠a de la semana -->
                    <div class="col-12 col-lg-6">
                        <div class="card h-100">
                            <div class="card-header">
                                <h5 class="mb-0">
                                    <i class="bi bi-calendar-week me-2"></i>Actividad por D√≠a de la Semana
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="chart-container" style="position: relative; height: 300px;">
                                    <canvas id="actividadSemanalChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tercera fila - Listas y m√©tricas -->
                <div class="row g-4 mb-4">
                    <!-- Libros m√°s populares -->
                    <div class="col-12 col-lg-6">
                        <div class="card h-100">
                            <div class="card-header">
                                <h5 class="mb-0">
                                    <i class="bi bi-star-fill me-2"></i>Libros M√°s Populares
                                </h5>
                            </div>
                            <div class="card-body" id="libros-populares">
                                <div class="text-center py-3">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Cargando...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Usuarios m√°s activos -->
                    <div class="col-12 col-lg-6">
                        <div class="card h-100">
                            <div class="card-header">
                                <h5 class="mb-0">
                                    <i class="bi bi-people-fill me-2"></i>Usuarios M√°s Activos
                                </h5>
                            </div>
                            <div class="card-body" id="usuarios-activos">
                                <div class="text-center py-3">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Cargando...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Cuarta fila - M√©tricas adicionales -->
                <div class="row g-4">
                    <!-- Tiempo promedio de pr√©stamo -->
                    <div class="col-12 col-lg-4">
                        <div class="card h-100">
                            <div class="card-header">
                                <h5 class="mb-0">
                                    <i class="bi bi-clock me-2"></i>Tiempo Promedio de Pr√©stamo
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="chart-container" style="position: relative; height: 250px;">
                                    <canvas id="tiempoPromedioChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Categor√≠as m√°s solicitadas -->
                    <div class="col-12 col-lg-8">
                        <div class="card h-100">
                            <div class="card-header">
                                <h5 class="mb-0">
                                    <i class="bi bi-bar-chart me-2"></i>Categor√≠as M√°s Solicitadas
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="chart-container" style="position: relative; height: 250px;">
                                    <canvas id="categoriasSolicitadasChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../../services/admin-biblioteca.services.js"></script>
    <script src="../../js/admin-functions.js"></script>
    
    <script>
        // Variables globales para los gr√°ficos
        let charts = {
            prestamos: null,
            categorias: null,
            estadoPrestamos: null,
            actividadSemanal: null,
            tiempoPromedio: null,
            categoriasSolicitadas: null
        };

        // Configuraci√≥n global de Chart.js
        Chart.defaults.font.family = "'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif";
        Chart.defaults.font.size = 12;
        Chart.defaults.color = '#6c757d';
        Chart.defaults.responsive = true;
        Chart.defaults.maintainAspectRatio = false;

        // Paleta de colores profesional
        const colorPalette = {
            primary: '#0d6efd',
            secondary: '#6c757d',
            success: '#198754',
            danger: '#dc3545',
            warning: '#ffc107',
            info: '#0dcaf0',
            light: '#f8f9fa',
            dark: '#212529',
            colors: [
                '#0d6efd', '#198754', '#ffc107', '#dc3545', '#0dcaf0',
                '#6f42c1', '#fd7e14', '#20c997', '#e83e8c', '#6c757d'
            ]
        };

        // Funci√≥n de logout
        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('role');
            localStorage.removeItem('userName');
            localStorage.removeItem('userId');
            sessionStorage.removeItem('token');
            sessionStorage.removeItem('role');
            sessionStorage.removeItem('userName');
            sessionStorage.removeItem('userId');
            window.location.replace('/pages/guest/login.html');
        }

        // Mostrar/ocultar loading
        function mostrarLoading(mostrar = true) {
            document.getElementById('loading-spinner').style.display = mostrar ? 'block' : 'none';
        }

        // Mostrar error
        function mostrarError(mensaje) {
            document.getElementById('error-text').textContent = mensaje;
            document.getElementById('error-message').style.display = 'block';
            setTimeout(() => {
                document.getElementById('error-message').style.display = 'none';
            }, 5000);
        }

        // Cargar estad√≠sticas con fetch real
        async function cargarEstadisticas() {
            try {
                mostrarLoading(true);
                
                // Obtener token de autenticaci√≥n
                const token = localStorage.getItem('token') || sessionStorage.getItem('token');
                if (!token) {
                    throw new Error('No hay token de autenticaci√≥n');
                }

                // Hacer petici√≥n a la API
                const response = await fetch('/api/admin/estadisticas', {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`Error ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                console.log('üìä Datos recibidos:', data);
                
                // Actualizar resumen general
                actualizarResumenGeneral(data.estadisticas || {});
                
                // Crear todos los gr√°ficos
                await crearTodosLosGraficos(data);
                
                // Mostrar listas
                mostrarLibrosPopulares(data.libros_populares || []);
                mostrarUsuariosActivos(data.usuarios_activos || []);

            } catch (error) {
                console.error('‚ùå Error cargando estad√≠sticas:', error);
                mostrarError('Error cargando estad√≠sticas: ' + error.message);
            } finally {
                mostrarLoading(false);
            }
        }

        // Actualizar resumen general
        function actualizarResumenGeneral(stats) {
            document.getElementById('total-libros').textContent = stats.total_libros || 0;
            document.getElementById('prestamos-activos').textContent = stats.prestamos_activos || 0;
            document.getElementById('total-prestamos').textContent = stats.total_prestamos || 0;
            document.getElementById('usuarios-unicos').textContent = stats.usuarios_unicos || 0;
        }

        // Crear todos los gr√°ficos
        async function crearTodosLosGraficos(data) {
            // Gr√°fico principal de pr√©stamos
            crearGraficoPrestamos(data.prestamos_mensuales || []);
            
            // Gr√°fico de categor√≠as
            crearGraficoCategorias(data.libros_populares || []);
            
            // Gr√°fico de estado de pr√©stamos
            crearGraficoEstadoPrestamos(data.estadisticas || {});
            
            // Gr√°fico de actividad semanal (simulado)
            crearGraficoActividadSemanal();
            
            // Gr√°fico de tiempo promedio (simulado)
            crearGraficoTiempoPromedio();
            
            // Gr√°fico de categor√≠as solicitadas
            crearGraficoCategoriasSolicitadas(data.libros_populares || []);
        }

        // Crear gr√°fico principal de pr√©stamos
        function crearGraficoPrestamos(datos) {
            const ctx = document.getElementById('prestamosChart').getContext('2d');
            
            if (charts.prestamos) {
                charts.prestamos.destroy();
            }

            // Procesar datos para los √∫ltimos 12 meses
            const ultimos12Meses = procesarDatosMensuales(datos);
            const labels = ultimos12Meses.map(d => d.mes);
            const values = ultimos12Meses.map(d => d.cantidad);

            charts.prestamos = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Pr√©stamos',
                        data: values,
                        borderColor: colorPalette.primary,
                        backgroundColor: `${colorPalette.primary}20`,
                        borderWidth: 3,
                        tension: 0.4,
                        fill: true,
                        pointBackgroundColor: colorPalette.primary,
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointRadius: 6,
                        pointHoverRadius: 8
                    }]
                },
                options: {
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0,0,0,0.8)',
                            titleColor: '#fff',
                            bodyColor: '#fff',
                            borderColor: colorPalette.primary,
                            borderWidth: 1,
                            cornerRadius: 8
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                color: '#6c757d',
                                font: {
                                    size: 11
                                }
                            }
                        },
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0,0,0,0.1)'
                            },
                            ticks: {
                                color: '#6c757d',
                                font: {
                                    size: 11
                                }
                            }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    }
                }
            });
        }

        // Crear gr√°fico de categor√≠as
        function crearGraficoCategorias(librosPopulares) {
            const ctx = document.getElementById('categoriasChart').getContext('2d');
            
            if (charts.categorias) {
                charts.categorias.destroy();
            }

            // Agrupar por categor√≠as
            const categorias = {};
            librosPopulares.forEach(libro => {
                categorias[libro.categoria] = (categorias[libro.categoria] || 0) + (libro.total_prestamos || 0);
            });

            const labels = Object.keys(categorias);
            const values = Object.values(categorias);

            charts.categorias = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: values,
                        backgroundColor: colorPalette.colors.slice(0, labels.length),
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                usePointStyle: true,
                                font: {
                                    size: 11
                                }
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0,0,0,0.8)',
                            titleColor: '#fff',
                            bodyColor: '#fff',
                            cornerRadius: 8
                        }
                    },
                    cutout: '60%'
                }
            });
        }

        // Crear gr√°fico de estado de pr√©stamos
        function crearGraficoEstadoPrestamos(stats) {
            const ctx = document.getElementById('estadoPrestamosChart').getContext('2d');
            
            if (charts.estadoPrestamos) {
                charts.estadoPrestamos.destroy();
            }

            const activos = stats.prestamos_activos || 0;
            const devueltos = (stats.total_prestamos || 0) - activos;

            charts.estadoPrestamos = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: ['Activos', 'Devueltos'],
                    datasets: [{
                        data: [activos, devueltos],
                        backgroundColor: [colorPalette.success, colorPalette.info],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                usePointStyle: true,
                                font: {
                                    size: 11
                                }
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0,0,0,0.8)',
                            titleColor: '#fff',
                            bodyColor: '#fff',
                            cornerRadius: 8
                        }
                    }
                }
            });
        }

        // Crear gr√°fico de actividad semanal (simulado)
        function crearGraficoActividadSemanal() {
            const ctx = document.getElementById('actividadSemanalChart').getContext('2d');
            
            if (charts.actividadSemanal) {
                charts.actividadSemanal.destroy();
            }

            const diasSemana = ['Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b', 'Dom'];
            const actividad = [12, 19, 15, 25, 22, 8, 5]; // Datos simulados

            charts.actividadSemanal = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: diasSemana,
                    datasets: [{
                        label: 'Pr√©stamos',
                        data: actividad,
                        backgroundColor: colorPalette.colors[0],
                        borderColor: colorPalette.colors[0],
                        borderWidth: 1,
                        borderRadius: 4,
                        borderSkipped: false
                    }]
                },
                options: {
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0,0,0,0.8)',
                            titleColor: '#fff',
                            bodyColor: '#fff',
                            cornerRadius: 8
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                color: '#6c757d',
                                font: {
                                    size: 11
                                }
                            }
                        },
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0,0,0,0.1)'
                            },
                            ticks: {
                                color: '#6c757d',
                                font: {
                                    size: 11
                                }
                            }
                        }
                    }
                }
            });
        }

        // Crear gr√°fico de tiempo promedio (simulado)
        function crearGraficoTiempoPromedio() {
            const ctx = document.getElementById('tiempoPromedioChart').getContext('2d');
            
            if (charts.tiempoPromedio) {
                charts.tiempoPromedio.destroy();
            }

            const rangos = ['1-3 d√≠as', '4-7 d√≠as', '8-14 d√≠as', '15-30 d√≠as', '30+ d√≠as'];
            const distribucion = [25, 35, 20, 15, 5]; // Datos simulados

            charts.tiempoPromedio = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: rangos,
                    datasets: [{
                        data: distribucion,
                        backgroundColor: colorPalette.colors.slice(0, 5),
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 15,
                                usePointStyle: true,
                                font: {
                                    size: 10
                                }
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0,0,0,0.8)',
                            titleColor: '#fff',
                            bodyColor: '#fff',
                            cornerRadius: 8
                        }
                    },
                    cutout: '50%'
                }
            });
        }

        // Crear gr√°fico de categor√≠as solicitadas
        function crearGraficoCategoriasSolicitadas(librosPopulares) {
            const ctx = document.getElementById('categoriasSolicitadasChart').getContext('2d');
            
            if (charts.categoriasSolicitadas) {
                charts.categoriasSolicitadas.destroy();
            }

            // Agrupar por categor√≠as y contar pr√©stamos
            const categorias = {};
            librosPopulares.forEach(libro => {
                categorias[libro.categoria] = (categorias[libro.categoria] || 0) + (libro.total_prestamos || 0);
            });

            const labels = Object.keys(categorias).slice(0, 8); // Top 8 categor√≠as
            const values = Object.values(categorias).slice(0, 8);

            charts.categoriasSolicitadas = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Pr√©stamos',
                        data: values,
                        backgroundColor: colorPalette.colors[1],
                        borderColor: colorPalette.colors[1],
                        borderWidth: 1,
                        borderRadius: 4,
                        borderSkipped: false
                    }]
                },
                options: {
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0,0,0,0.8)',
                            titleColor: '#fff',
                            bodyColor: '#fff',
                            cornerRadius: 8
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                color: '#6c757d',
                                font: {
                                    size: 10
                                },
                                maxRotation: 45
                            }
                        },
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0,0,0,0.1)'
                            },
                            ticks: {
                                color: '#6c757d',
                                font: {
                                    size: 11
                                }
                            }
                        }
                    }
                }
            });
        }

        // Procesar datos mensuales para los √∫ltimos 12 meses
        function procesarDatosMensuales(datos) {
            const ultimos12Meses = [];
            const hoy = new Date();
            
            for (let i = 11; i >= 0; i--) {
                const fecha = new Date(hoy.getFullYear(), hoy.getMonth() - i, 1);
                const mesKey = fecha.toISOString().substring(0, 7);
                
                const datoExistente = datos.find(d => d.mes && d.mes.startsWith(mesKey));
                
                ultimos12Meses.push({
                    mes: fecha.toLocaleDateString('es-ES', { month: 'short', year: '2-digit' }),
                    cantidad: datoExistente ? datoExistente.cantidad : 0
                });
            }
            
            return ultimos12Meses;
        }

        // Cambiar vista del gr√°fico principal
        function cambiarVistaGrafico(tipo) {
            if (charts.prestamos) {
                charts.prestamos.config.type = tipo;
                charts.prestamos.update();
                
                // Actualizar botones
                document.querySelectorAll('.btn-group .btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                event.target.classList.add('active');
            }
        }

        // Mostrar libros populares
        function mostrarLibrosPopulares(libros) {
            const container = document.getElementById('libros-populares');
            
            if (libros.length === 0) {
                container.innerHTML = '<div class="text-center py-4"><i class="bi bi-book text-muted fs-1"></i><p class="text-muted mt-2">No hay datos disponibles</p></div>';
                return;
            }

            container.innerHTML = libros.slice(0, 5).map((libro, index) => `
                <div class="d-flex justify-content-between align-items-center mb-3 p-2 rounded" style="background-color: #f8f9fa;">
                    <div class="flex-grow-1">
                        <div class="d-flex align-items-center">
                            <span class="badge bg-primary me-2">${index + 1}</span>
                    <div>
                                <h6 class="mb-1 text-truncate" style="max-width: 200px;" title="${libro.titulo}">${libro.titulo}</h6>
                        <small class="text-muted">${libro.autor} ‚Ä¢ ${libro.categoria}</small>
                            </div>
                        </div>
                    </div>
                    <div class="text-end">
                        <span class="badge bg-success fs-6">${libro.total_prestamos}</span>
                        <small class="d-block text-muted">pr√©stamos</small>
                    </div>
                </div>
            `).join('');
        }

        // Mostrar usuarios activos
        function mostrarUsuariosActivos(usuarios) {
            const container = document.getElementById('usuarios-activos');
            
            if (usuarios.length === 0) {
                container.innerHTML = '<div class="text-center py-4"><i class="bi bi-people text-muted fs-1"></i><p class="text-muted mt-2">No hay datos disponibles</p></div>';
                return;
            }

            // Simular datos de usuarios activos si no vienen del backend
            const usuariosSimulados = usuarios.length > 0 ? usuarios : [
                { nombre: 'Usuario 1', email: 'user1@example.com', total_prestamos: 15 },
                { nombre: 'Usuario 2', email: 'user2@example.com', total_prestamos: 12 },
                { nombre: 'Usuario 3', email: 'user3@example.com', total_prestamos: 8 },
                { nombre: 'Usuario 4', email: 'user4@example.com', total_prestamos: 6 },
                { nombre: 'Usuario 5', email: 'user5@example.com', total_prestamos: 4 }
            ];

            container.innerHTML = usuariosSimulados.slice(0, 5).map((usuario, index) => `
                <div class="d-flex justify-content-between align-items-center mb-3 p-2 rounded" style="background-color: #f8f9fa;">
                    <div class="flex-grow-1">
                        <div class="d-flex align-items-center">
                            <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-2" style="width: 32px; height: 32px; font-size: 12px; font-weight: bold;">
                                ${usuario.nombre.charAt(0).toUpperCase()}
                            </div>
                    <div>
                                <h6 class="mb-1">${usuario.nombre}</h6>
                                <small class="text-muted text-truncate d-block" style="max-width: 150px;" title="${usuario.email}">${usuario.email}</small>
                            </div>
                        </div>
                    </div>
                    <div class="text-end">
                        <span class="badge bg-success fs-6">${usuario.total_prestamos}</span>
                        <small class="d-block text-muted">pr√©stamos</small>
                    </div>
                </div>
            `).join('');
        }

        // Exportar estad√≠sticas
        function exportarEstadisticas() {
            const stats = {
                totalLibros: document.getElementById('total-libros').textContent,
                prestamosActivos: document.getElementById('prestamos-activos').textContent,
                totalPrestamos: document.getElementById('total-prestamos').textContent,
                usuariosUnicos: document.getElementById('usuarios-unicos').textContent,
                fechaExportacion: new Date().toLocaleString('es-ES'),
                graficos: Object.keys(charts).filter(key => charts[key] !== null).length
            };

            const dataStr = JSON.stringify(stats, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `estadisticas-biblioteca-${new Date().toISOString().split('T')[0]}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
        }

        // Redimensionar gr√°ficos al cambiar tama√±o de ventana
        window.addEventListener('resize', () => {
            Object.values(charts).forEach(chart => {
                if (chart) {
                    chart.resize();
                }
            });
        });

        // Verificar que Chart.js est√© disponible
        function verificarChartJS() {
            if (typeof Chart === 'undefined') {
                console.error('‚ùå Chart.js no est√° disponible');
                mostrarError('Error: Chart.js no se pudo cargar. Recarga la p√°gina.');
                return false;
            }
            console.log('‚úÖ Chart.js cargado correctamente, versi√≥n:', Chart.version);
            return true;
        }

        // Inicializar aplicaci√≥n
        async function inicializar() {
            try {
                // Verificar Chart.js primero
                if (!verificarChartJS()) {
                    return;
                }

                const token = localStorage.getItem('token') || sessionStorage.getItem('token');
                const role = localStorage.getItem('role') || sessionStorage.getItem('role');
                
                if (!token || role !== 'admin') {
                    window.location.replace('/pages/guest/login.html');
                    return;
                }

                await cargarEstadisticas();
                
            } catch (error) {
                console.error('‚ùå Error inicializando aplicaci√≥n:', error);
                mostrarError('Error inicializando la aplicaci√≥n: ' + error.message);
            }
        }

        // Inicializar cuando se carga la p√°gina
        document.addEventListener('DOMContentLoaded', inicializar);
    </script>
</body>
</html>
