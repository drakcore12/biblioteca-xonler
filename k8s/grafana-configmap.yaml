apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-datasources
  namespace: biblioteca-xonler
data:
  prometheus.yml: |
    apiVersion: 1

    datasources:
      - name: Prometheus
        type: prometheus
        access: proxy
        url: http://prometheus-service:9090
        isDefault: true
        editable: true
        jsonData:
          timeInterval: "15s"
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-dashboards
  namespace: biblioteca-xonler
data:
  dashboard.yml: |
    apiVersion: 1

    providers:
      - name: 'Default'
        orgId: 1
        folder: ''
        type: file
        disableDeletion: false
        updateIntervalSeconds: 10
        allowUiUpdates: true
        options:
          path: /etc/grafana/provisioning/dashboards
  nodejs-dashboard.json: |
    {
      "dashboard": {
        "title": "Node.js Application Metrics",
        "tags": ["nodejs", "application"],
        "timezone": "browser",
        "schemaVersion": 27,
        "version": 1,
        "refresh": "10s",
        "panels": [
          {
            "id": 1,
            "title": "HTTP Requests Rate",
            "type": "stat",
            "gridPos": {"h": 4, "w": 6, "x": 0, "y": 0},
            "targets": [
              {
                "expr": "rate(http_requests_total[5m])",
                "refId": "A",
                "legendFormat": "{{method}} {{route}}"
              }
            ],
            "fieldConfig": {
              "defaults": {
                "unit": "reqps",
                "decimals": 2
              }
            }
          },
          {
            "id": 2,
            "title": "HTTP Request Duration (p95)",
            "type": "stat",
            "gridPos": {"h": 4, "w": 6, "x": 6, "y": 0},
            "targets": [
              {
                "expr": "histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m]))",
                "refId": "A"
              }
            ],
            "fieldConfig": {
              "defaults": {
                "unit": "s",
                "decimals": 3
              }
            }
          },
          {
            "id": 3,
            "title": "HTTP Status Codes",
            "type": "stat",
            "gridPos": {"h": 4, "w": 6, "x": 12, "y": 0},
            "targets": [
              {
                "expr": "sum(rate(http_requests_total[5m])) by (status)",
                "refId": "A",
                "legendFormat": "{{status}}"
              }
            ],
            "fieldConfig": {
              "defaults": {
                "unit": "reqps",
                "decimals": 2
              }
            }
          },
          {
            "id": 4,
            "title": "Active Connections",
            "type": "stat",
            "gridPos": {"h": 4, "w": 6, "x": 18, "y": 0},
            "targets": [
              {
                "expr": "active_connections",
                "refId": "A"
              }
            ],
            "fieldConfig": {
              "defaults": {
                "unit": "short",
                "decimals": 0
              }
            }
          },
          {
            "id": 5,
            "title": "HTTP Requests Over Time",
            "type": "timeseries",
            "gridPos": {"h": 8, "w": 12, "x": 0, "y": 4},
            "targets": [
              {
                "expr": "rate(http_requests_total[5m])",
                "refId": "A",
                "legendFormat": "{{method}} {{route}} {{status}}"
              }
            ],
            "fieldConfig": {
              "defaults": {
                "unit": "reqps",
                "decimals": 2
              }
            }
          },
          {
            "id": 6,
            "title": "HTTP Request Duration",
            "type": "timeseries",
            "gridPos": {"h": 8, "w": 12, "x": 12, "y": 4},
            "targets": [
              {
                "expr": "histogram_quantile(0.50, rate(http_request_duration_seconds_bucket[5m]))",
                "refId": "A",
                "legendFormat": "p50"
              },
              {
                "expr": "histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m]))",
                "refId": "B",
                "legendFormat": "p95"
              },
              {
                "expr": "histogram_quantile(0.99, rate(http_request_duration_seconds_bucket[5m]))",
                "refId": "C",
                "legendFormat": "p99"
              }
            ],
            "fieldConfig": {
              "defaults": {
                "unit": "s",
                "decimals": 3
              }
            }
          },
          {
            "id": 7,
            "title": "Database Queries Rate",
            "type": "timeseries",
            "gridPos": {"h": 8, "w": 12, "x": 0, "y": 12},
            "targets": [
              {
                "expr": "rate(db_queries_total[5m])",
                "refId": "A",
                "legendFormat": "{{query_type}} {{table}}"
              }
            ],
            "fieldConfig": {
              "defaults": {
                "unit": "reqps",
                "decimals": 2
              }
            }
          },
          {
            "id": 8,
            "title": "Database Query Duration",
            "type": "timeseries",
            "gridPos": {"h": 8, "w": 12, "x": 12, "y": 12},
            "targets": [
              {
                "expr": "histogram_quantile(0.95, rate(db_query_duration_seconds_bucket[5m]))",
                "refId": "A",
                "legendFormat": "p95"
              }
            ],
            "fieldConfig": {
              "defaults": {
                "unit": "s",
                "decimals": 3
              }
            }
          },
          {
            "id": 9,
            "title": "CPU Usage",
            "type": "timeseries",
            "gridPos": {"h": 8, "w": 12, "x": 0, "y": 20},
            "targets": [
              {
                "expr": "rate(process_cpu_user_seconds_total[5m]) * 100",
                "refId": "A",
                "legendFormat": "CPU %"
              }
            ],
            "fieldConfig": {
              "defaults": {
                "unit": "percent",
                "decimals": 2
              }
            }
          },
          {
            "id": 10,
            "title": "Memory Usage",
            "type": "timeseries",
            "gridPos": {"h": 8, "w": 12, "x": 12, "y": 20},
            "targets": [
              {
                "expr": "process_resident_memory_bytes",
                "refId": "A",
                "legendFormat": "Memory"
              }
            ],
            "fieldConfig": {
              "defaults": {
                "unit": "bytes",
                "decimals": 2
              }
            }
          }
        ],
        "time": {
          "from": "now-15m",
          "to": "now"
        },
        "timepicker": {},
        "templating": {
          "list": []
        },
        "annotations": {
          "list": []
        }
      }
    }
  postgresql-dashboard.json: |
    {
      "dashboard": {
        "title": "PostgreSQL Database Metrics",
        "tags": ["postgresql", "database"],
        "timezone": "browser",
        "schemaVersion": 27,
        "version": 1,
        "refresh": "10s",
        "panels": [
          {
            "id": 1,
            "title": "Active Connections",
            "type": "stat",
            "gridPos": {"h": 4, "w": 6, "x": 0, "y": 0},
            "targets": [
              {
                "expr": "pg_stat_activity_count{state=\"active\"}",
                "refId": "A"
              }
            ],
            "fieldConfig": {
              "defaults": {
                "unit": "short",
                "decimals": 0
              }
            }
          },
          {
            "id": 2,
            "title": "Idle Connections",
            "type": "stat",
            "gridPos": {"h": 4, "w": 6, "x": 6, "y": 0},
            "targets": [
              {
                "expr": "pg_stat_activity_count{state=\"idle\"}",
                "refId": "A"
              }
            ],
            "fieldConfig": {
              "defaults": {
                "unit": "short",
                "decimals": 0
              }
            }
          },
          {
            "id": 3,
            "title": "Cache Hit Ratio",
            "type": "stat",
            "gridPos": {"h": 4, "w": 6, "x": 12, "y": 0},
            "targets": [
              {
                "expr": "sum(rate(pg_stat_database_blks_hit[5m])) / (sum(rate(pg_stat_database_blks_hit[5m])) + sum(rate(pg_stat_database_blks_read[5m]))) * 100",
                "refId": "A"
              }
            ],
            "fieldConfig": {
              "defaults": {
                "unit": "percent",
                "decimals": 2,
                "min": 0,
                "max": 100
              }
            }
          },
          {
            "id": 4,
            "title": "Transactions per Second",
            "type": "stat",
            "gridPos": {"h": 4, "w": 6, "x": 18, "y": 0},
            "targets": [
              {
                "expr": "sum(rate(pg_stat_database_xact_commit[5m]) + rate(pg_stat_database_xact_rollback[5m]))",
                "refId": "A"
              }
            ],
            "fieldConfig": {
              "defaults": {
                "unit": "ops",
                "decimals": 2
              }
            }
          },
          {
            "id": 5,
            "title": "Connections Over Time",
            "type": "timeseries",
            "gridPos": {"h": 8, "w": 12, "x": 0, "y": 4},
            "targets": [
              {
                "expr": "pg_stat_activity_count",
                "refId": "A",
                "legendFormat": "{{state}}"
              }
            ],
            "fieldConfig": {
              "defaults": {
                "unit": "short",
                "decimals": 0
              }
            }
          },
          {
            "id": 6,
            "title": "Queries per Second",
            "type": "timeseries",
            "gridPos": {"h": 8, "w": 12, "x": 12, "y": 4},
            "targets": [
              {
                "expr": "sum(rate(pg_stat_database_tup_fetched[5m]) + rate(pg_stat_database_tup_returned[5m]))",
                "refId": "A",
                "legendFormat": "Queries/sec"
              }
            ],
            "fieldConfig": {
              "defaults": {
                "unit": "ops",
                "decimals": 2
              }
            }
          },
          {
            "id": 7,
            "title": "Database Size",
            "type": "timeseries",
            "gridPos": {"h": 8, "w": 12, "x": 0, "y": 12},
            "targets": [
              {
                "expr": "pg_database_size_bytes",
                "refId": "A",
                "legendFormat": "{{datname}}"
              }
            ],
            "fieldConfig": {
              "defaults": {
                "unit": "bytes",
                "decimals": 2
              }
            }
          },
          {
            "id": 8,
            "title": "Table Sizes",
            "type": "timeseries",
            "gridPos": {"h": 8, "w": 12, "x": 12, "y": 12},
            "targets": [
              {
                "expr": "pg_stat_user_tables_n_tup_ins - pg_stat_user_tables_n_tup_del",
                "refId": "A",
                "legendFormat": "{{schemaname}}.{{relname}}"
              }
            ],
            "fieldConfig": {
              "defaults": {
                "unit": "short",
                "decimals": 0
              }
            }
          },
          {
            "id": 9,
            "title": "Locks",
            "type": "timeseries",
            "gridPos": {"h": 8, "w": 12, "x": 0, "y": 20},
            "targets": [
              {
                "expr": "pg_locks_count",
                "refId": "A",
                "legendFormat": "{{mode}}"
              }
            ],
            "fieldConfig": {
              "defaults": {
                "unit": "short",
                "decimals": 0
              }
            }
          },
          {
            "id": 10,
            "title": "WAL Activity",
            "type": "timeseries",
            "gridPos": {"h": 8, "w": 12, "x": 12, "y": 20},
            "targets": [
              {
                "expr": "rate(pg_stat_bgwriter_buffers_checkpoint[5m])",
                "refId": "A",
                "legendFormat": "Checkpoints"
              },
              {
                "expr": "rate(pg_stat_bgwriter_buffers_clean[5m])",
                "refId": "B",
                "legendFormat": "Clean"
              }
            ],
            "fieldConfig": {
              "defaults": {
                "unit": "short",
                "decimals": 2
              }
            }
          }
        ],
        "time": {
          "from": "now-15m",
          "to": "now"
        },
        "timepicker": {},
        "templating": {
          "list": []
        },
        "annotations": {
          "list": []
        }
      }
    }
  containers-dashboard.json: |
    {
      "dashboard": {
        "title": "Container Metrics",
        "tags": ["containers", "docker", "cadvisor"],
        "timezone": "browser",
        "schemaVersion": 27,
        "version": 1,
        "refresh": "10s",
        "panels": [
          {
            "id": 1,
            "title": "CPU Usage (All Containers)",
            "type": "stat",
            "gridPos": {"h": 4, "w": 6, "x": 0, "y": 0},
            "targets": [
              {
                "expr": "sum(rate(container_cpu_usage_seconds_total[5m])) * 100",
                "refId": "A"
              }
            ],
            "fieldConfig": {
              "defaults": {
                "unit": "percent",
                "decimals": 2
              }
            }
          },
          {
            "id": 2,
            "title": "Memory Usage (All Containers)",
            "type": "stat",
            "gridPos": {"h": 4, "w": 6, "x": 6, "y": 0},
            "targets": [
              {
                "expr": "sum(container_memory_usage_bytes)",
                "refId": "A"
              }
            ],
            "fieldConfig": {
              "defaults": {
                "unit": "bytes",
                "decimals": 2
              }
            }
          },
          {
            "id": 3,
            "title": "Network Receive",
            "type": "stat",
            "gridPos": {"h": 4, "w": 6, "x": 12, "y": 0},
            "targets": [
              {
                "expr": "sum(rate(container_network_receive_bytes_total[5m]))",
                "refId": "A"
              }
            ],
            "fieldConfig": {
              "defaults": {
                "unit": "Bps",
                "decimals": 2
              }
            }
          },
          {
            "id": 4,
            "title": "Network Transmit",
            "type": "stat",
            "gridPos": {"h": 4, "w": 6, "x": 18, "y": 0},
            "targets": [
              {
                "expr": "sum(rate(container_network_transmit_bytes_total[5m]))",
                "refId": "A"
              }
            ],
            "fieldConfig": {
              "defaults": {
                "unit": "Bps",
                "decimals": 2
              }
            }
          },
          {
            "id": 5,
            "title": "CPU Usage by Container",
            "type": "timeseries",
            "gridPos": {"h": 8, "w": 12, "x": 0, "y": 4},
            "targets": [
              {
                "expr": "rate(container_cpu_usage_seconds_total[5m]) * 100",
                "refId": "A",
                "legendFormat": "{{name}}"
              }
            ],
            "fieldConfig": {
              "defaults": {
                "unit": "percent",
                "decimals": 2
              }
            }
          },
          {
            "id": 6,
            "title": "Memory Usage by Container",
            "type": "timeseries",
            "gridPos": {"h": 8, "w": 12, "x": 12, "y": 4},
            "targets": [
              {
                "expr": "container_memory_usage_bytes",
                "refId": "A",
                "legendFormat": "{{name}}"
              }
            ],
            "fieldConfig": {
              "defaults": {
                "unit": "bytes",
                "decimals": 2
              }
            }
          },
          {
            "id": 7,
            "title": "Network I/O",
            "type": "timeseries",
            "gridPos": {"h": 8, "w": 12, "x": 0, "y": 12},
            "targets": [
              {
                "expr": "rate(container_network_receive_bytes_total[5m])",
                "refId": "A",
                "legendFormat": "{{name}} - RX"
              },
              {
                "expr": "rate(container_network_transmit_bytes_total[5m])",
                "refId": "B",
                "legendFormat": "{{name}} - TX"
              }
            ],
            "fieldConfig": {
              "defaults": {
                "unit": "Bps",
                "decimals": 2
              }
            }
          },
          {
            "id": 8,
            "title": "Disk I/O",
            "type": "timeseries",
            "gridPos": {"h": 8, "w": 12, "x": 12, "y": 12},
            "targets": [
              {
                "expr": "rate(container_fs_reads_bytes_total[5m])",
                "refId": "A",
                "legendFormat": "{{name}} - Read"
              },
              {
                "expr": "rate(container_fs_writes_bytes_total[5m])",
                "refId": "B",
                "legendFormat": "{{name}} - Write"
              }
            ],
            "fieldConfig": {
              "defaults": {
                "unit": "Bps",
                "decimals": 2
              }
            }
          },
          {
            "id": 9,
            "title": "Container Restarts",
            "type": "timeseries",
            "gridPos": {"h": 8, "w": 12, "x": 0, "y": 20},
            "targets": [
              {
                "expr": "rate(container_start_time_seconds[5m])",
                "refId": "A",
                "legendFormat": "{{name}}"
              }
            ],
            "fieldConfig": {
              "defaults": {
                "unit": "short",
                "decimals": 0
              }
            }
          },
          {
            "id": 10,
            "title": "Memory Limit Usage",
            "type": "timeseries",
            "gridPos": {"h": 8, "w": 12, "x": 12, "y": 20},
            "targets": [
              {
                "expr": "(container_memory_usage_bytes / container_spec_memory_limit_bytes) * 100",
                "refId": "A",
                "legendFormat": "{{name}}"
              }
            ],
            "fieldConfig": {
              "defaults": {
                "unit": "percent",
                "decimals": 2,
                "min": 0,
                "max": 100
              }
            }
          }
        ],
        "time": {
          "from": "now-15m",
          "to": "now"
        },
        "timepicker": {},
        "templating": {
          "list": []
        },
        "annotations": {
          "list": []
        }
      }
    }

