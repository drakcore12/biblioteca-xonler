apiVersion: v1
kind: ConfigMap
metadata:
  name: postgresql-init-script
  namespace: biblioteca-xonler
data:
  init.sql: |
    --
    -- PostgreSQL database initialization script
    -- This script creates tables, functions, and inserts initial data
    --
    
    SET statement_timeout = 0;
    SET lock_timeout = 0;
    SET idle_in_transaction_session_timeout = 0;
    SET client_encoding = 'UTF8';
    SET standard_conforming_strings = on;
    SELECT pg_catalog.set_config('search_path', '', false);
    SET check_function_bodies = false;
    SET xmloption = content;
    SET client_min_messages = warning;
    SET row_security = off;
    
    -- La base de datos xonler ya fue creada por POSTGRES_DB
    -- Solo necesitamos crear las tablas dentro de ella

    -- Crear usuario y base de datos para SonarQube si no existen
    DO $$
    BEGIN
      IF NOT EXISTS (SELECT 1 FROM pg_roles WHERE rolname = 'sonar') THEN
        CREATE ROLE sonar LOGIN PASSWORD 'sonar';
      END IF;
    END
    $$;

    DO $$
    BEGIN
      IF NOT EXISTS (SELECT 1 FROM pg_database WHERE datname = 'sonarqube') THEN
        CREATE DATABASE sonarqube OWNER sonar;
      END IF;
    END
    $$;

    GRANT ALL PRIVILEGES ON DATABASE sonarqube TO sonar;
    
    CREATE SCHEMA IF NOT EXISTS public;
    ALTER SCHEMA public OWNER TO pg_database_owner;
    COMMENT ON SCHEMA public IS 'standard public schema';
    
    CREATE FUNCTION public._ensure_role_is_admin_cliente() RETURNS trigger
        LANGUAGE plpgsql
        AS $$
    DECLARE v_rol bigint;
    BEGIN
      SELECT rol_id INTO v_rol FROM public.usuarios WHERE id = NEW.usuario_id;
      IF v_rol IS DISTINCT FROM 2 THEN
        RAISE EXCEPTION 'admin_bibliotecas solo admite usuarios con rol_id = 2 (recibido=%)', v_rol
          USING ERRCODE = 'check_violation';
      END IF;
      RETURN NEW;
    END;
    $$;
    
    ALTER FUNCTION public._ensure_role_is_admin_cliente() OWNER TO postgres;
    
    SET default_tablespace = '';
    SET default_table_access_method = heap;
    
    CREATE TABLE IF NOT EXISTS public.admin_bibliotecas (
        usuario_id bigint NOT NULL,
        biblioteca_id bigint NOT NULL,
        can_manage boolean DEFAULT true NOT NULL,
        created_at timestamp without time zone DEFAULT now() NOT NULL
    );
    ALTER TABLE public.admin_bibliotecas OWNER TO postgres;
    
    CREATE TABLE IF NOT EXISTS public.biblioteca_libros (
        id bigint NOT NULL,
        biblioteca_id bigint NOT NULL,
        libro_id bigint NOT NULL
    );
    ALTER TABLE public.biblioteca_libros OWNER TO postgres;
    ALTER TABLE public.biblioteca_libros ALTER COLUMN id ADD GENERATED ALWAYS AS IDENTITY (
        SEQUENCE NAME public.biblioteca_libros_id_seq
        START WITH 1
        INCREMENT BY 1
        NO MINVALUE
        NO MAXVALUE
        CACHE 1
    );
    
    CREATE TABLE IF NOT EXISTS public.bibliotecas (
        id bigint NOT NULL,
        nombre text NOT NULL,
        direccion text,
        colegio_id bigint NOT NULL
    );
    ALTER TABLE public.bibliotecas OWNER TO postgres;
    ALTER TABLE public.bibliotecas ALTER COLUMN id ADD GENERATED ALWAYS AS IDENTITY (
        SEQUENCE NAME public.bibliotecas_id_seq
        START WITH 1
        INCREMENT BY 1
        NO MINVALUE
        NO MAXVALUE
        CACHE 1
    );
    
    CREATE TABLE IF NOT EXISTS public.colegios (
        id bigint NOT NULL,
        nombre text NOT NULL,
        direccion text
    );
    ALTER TABLE public.colegios OWNER TO postgres;
    ALTER TABLE public.colegios ALTER COLUMN id ADD GENERATED ALWAYS AS IDENTITY (
        SEQUENCE NAME public.colegios_id_seq
        START WITH 1
        INCREMENT BY 1
        NO MINVALUE
        NO MAXVALUE
        CACHE 1
    );
    
    CREATE TABLE IF NOT EXISTS public.libros (
        id bigint NOT NULL,
        titulo text NOT NULL,
        autor text NOT NULL,
        isbn text,
        imagen_url text,
        descripcion text,
        categoria text DEFAULT 'Otros'::text,
        disponibilidad boolean DEFAULT true
    );
    ALTER TABLE public.libros OWNER TO postgres;
    ALTER TABLE public.libros ALTER COLUMN id ADD GENERATED ALWAYS AS IDENTITY (
        SEQUENCE NAME public.libros_id_seq
        START WITH 1
        INCREMENT BY 1
        NO MINVALUE
        NO MAXVALUE
        CACHE 1
    );
    
    CREATE TABLE IF NOT EXISTS public.prestamos (
        id bigint NOT NULL,
        usuario_id bigint NOT NULL,
        biblioteca_libro_id bigint NOT NULL,
        fecha_prestamo date NOT NULL,
        fecha_devolucion date
    );
    ALTER TABLE public.prestamos OWNER TO postgres;
    ALTER TABLE public.prestamos ALTER COLUMN id ADD GENERATED ALWAYS AS IDENTITY (
        SEQUENCE NAME public.prestamos_id_seq
        START WITH 1
        INCREMENT BY 1
        NO MINVALUE
        NO MAXVALUE
        CACHE 1
    );
    
    CREATE TABLE IF NOT EXISTS public.roles (
        id bigint NOT NULL,
        name text NOT NULL
    );
    ALTER TABLE public.roles OWNER TO postgres;
    ALTER TABLE public.roles ALTER COLUMN id ADD GENERATED ALWAYS AS IDENTITY (
        SEQUENCE NAME public.roles_id_seq
        START WITH 1
        INCREMENT BY 1
        NO MINVALUE
        NO MAXVALUE
        CACHE 1
    );
    
    CREATE TABLE IF NOT EXISTS public.usuario_biblioteca (
        usuario_id bigint NOT NULL,
        biblioteca_id bigint NOT NULL
    );
    ALTER TABLE public.usuario_biblioteca OWNER TO postgres;
    
    CREATE TABLE IF NOT EXISTS public.usuarios (
        id bigint NOT NULL,
        nombre text NOT NULL,
        email text NOT NULL,
        password_hash text NOT NULL,
        rol_id bigint NOT NULL,
        created_at timestamp without time zone DEFAULT now() NOT NULL,
        updated_at timestamp without time zone DEFAULT now() NOT NULL,
        telefono text,
        fecha_nacimiento date,
        genero text,
        direccion text,
        ciudad text,
        codigo_postal text,
        apellido text,
        preferencias jsonb DEFAULT '{}'::jsonb NOT NULL,
        dobleautenticacion boolean DEFAULT false NOT NULL
    );
    ALTER TABLE public.usuarios OWNER TO postgres;
    ALTER TABLE public.usuarios ALTER COLUMN id ADD GENERATED ALWAYS AS IDENTITY (
        SEQUENCE NAME public.usuarios_id_seq
        START WITH 1
        INCREMENT BY 1
        NO MINVALUE
        NO MAXVALUE
        CACHE 1
    );
    
    -- Insertar datos iniciales solo si las tablas están vacías
    INSERT INTO public.roles (id, name) VALUES (1, 'usuario'), (2, 'admin'), (3, 'supadmin')
    ON CONFLICT (id) DO NOTHING;
    
    INSERT INTO public.colegios (id, nombre, direccion) VALUES
    (1, 'Universidad de Antioquia', 'Calle 67 #53-108, Medellín'),
    (2, 'Universidad EAFIT', 'Carrera 49 #7 Sur-50, Medellín'),
    (3, 'Politécnico Colombiano Jaime Isaza Cadavid', 'Carrera 65 #59A-110, Medellín'),
    (4, 'Biblioteca Pública Piloto', 'Calle 53 #48-23, Medellín'),
    (5, 'Biblioteca Pública El Salvador', 'Transversal 92 #37-25, Medellín'),
    (6, 'hola', '# 62-86 Carrera 141')
    ON CONFLICT (id) DO NOTHING;
    
    INSERT INTO public.bibliotecas (id, nombre, direccion, colegio_id) VALUES
    (1, 'Biblioteca Central UdeA', 'Calle 67 #53-108, Bloque B', 1),
    (2, 'Biblioteca Luis Echavarría Villegas (EAFIT)', 'Carrera 49 #7 Sur-50, Ed. 47A', 2),
    (3, 'Biblioteca PoliJaime', 'Carrera 65 #59A-110, Sótano 1', 3),
    (4, 'Biblioteca Pública Piloto', 'Calle 53 #48-23', 4),
    (5, 'Biblioteca El Salvador', 'Transversal 92 #37-25', 5),
    (8, 'Biblioteca San Cristóbal', 'carrera 141#62-86', 4)
    ON CONFLICT (id) DO NOTHING;
    
    -- Constraints y Foreign Keys
    ALTER TABLE ONLY public.admin_bibliotecas
        ADD CONSTRAINT admin_bibliotecas_pkey PRIMARY KEY (usuario_id, biblioteca_id);
    
    ALTER TABLE ONLY public.biblioteca_libros
        ADD CONSTRAINT biblioteca_libros_biblioteca_id_libro_id_key UNIQUE (biblioteca_id, libro_id);
    ALTER TABLE ONLY public.biblioteca_libros
        ADD CONSTRAINT biblioteca_libros_pkey PRIMARY KEY (id);
    
    ALTER TABLE ONLY public.bibliotecas
        ADD CONSTRAINT bibliotecas_pkey PRIMARY KEY (id);
    
    ALTER TABLE ONLY public.colegios
        ADD CONSTRAINT colegios_pkey PRIMARY KEY (id);
    
    ALTER TABLE ONLY public.libros
        ADD CONSTRAINT libros_isbn_key UNIQUE (isbn);
    ALTER TABLE ONLY public.libros
        ADD CONSTRAINT libros_pkey PRIMARY KEY (id);
    
    ALTER TABLE ONLY public.prestamos
        ADD CONSTRAINT prestamos_pkey PRIMARY KEY (id);
    
    ALTER TABLE ONLY public.roles
        ADD CONSTRAINT roles_pkey PRIMARY KEY (id);
    
    ALTER TABLE ONLY public.usuario_biblioteca
        ADD CONSTRAINT usuario_biblioteca_pkey PRIMARY KEY (usuario_id);
    
    ALTER TABLE ONLY public.usuarios
        ADD CONSTRAINT usuarios_email_key UNIQUE (email);
    ALTER TABLE ONLY public.usuarios
        ADD CONSTRAINT usuarios_pkey PRIMARY KEY (id);
    
    -- Foreign Keys
    ALTER TABLE ONLY public.admin_bibliotecas
        ADD CONSTRAINT admin_bibliotecas_biblioteca_id_fkey FOREIGN KEY (biblioteca_id) REFERENCES public.bibliotecas(id) ON DELETE CASCADE;
    ALTER TABLE ONLY public.admin_bibliotecas
        ADD CONSTRAINT admin_bibliotecas_usuario_id_fkey FOREIGN KEY (usuario_id) REFERENCES public.usuarios(id) ON DELETE CASCADE;
    
    ALTER TABLE ONLY public.biblioteca_libros
        ADD CONSTRAINT biblioteca_libros_biblioteca_id_fkey FOREIGN KEY (biblioteca_id) REFERENCES public.bibliotecas(id);
    ALTER TABLE ONLY public.biblioteca_libros
        ADD CONSTRAINT biblioteca_libros_libro_id_fkey FOREIGN KEY (libro_id) REFERENCES public.libros(id);
    
    ALTER TABLE ONLY public.bibliotecas
        ADD CONSTRAINT bibliotecas_colegio_id_fkey FOREIGN KEY (colegio_id) REFERENCES public.colegios(id);
    
    ALTER TABLE ONLY public.prestamos
        ADD CONSTRAINT prestamos_biblioteca_libro_id_fkey FOREIGN KEY (biblioteca_libro_id) REFERENCES public.biblioteca_libros(id);
    ALTER TABLE ONLY public.prestamos
        ADD CONSTRAINT prestamos_usuario_id_fkey FOREIGN KEY (usuario_id) REFERENCES public.usuarios(id);
    
    ALTER TABLE ONLY public.usuario_biblioteca
        ADD CONSTRAINT usuario_biblioteca_biblioteca_id_fkey FOREIGN KEY (biblioteca_id) REFERENCES public.bibliotecas(id) ON DELETE CASCADE;
    ALTER TABLE ONLY public.usuario_biblioteca
        ADD CONSTRAINT usuario_biblioteca_usuario_id_fkey FOREIGN KEY (usuario_id) REFERENCES public.usuarios(id) ON DELETE CASCADE;
    
    ALTER TABLE ONLY public.usuarios
        ADD CONSTRAINT usuarios_rol_id_fkey FOREIGN KEY (rol_id) REFERENCES public.roles(id);
    
    -- Índices
    CREATE INDEX IF NOT EXISTS idx_admin_bibliotecas_biblioteca ON public.admin_bibliotecas USING btree (biblioteca_id);
    CREATE INDEX IF NOT EXISTS idx_admin_bibliotecas_usuario ON public.admin_bibliotecas USING btree (usuario_id);
    CREATE INDEX IF NOT EXISTS idx_bibliotecas_colegio ON public.bibliotecas USING btree (colegio_id);
    CREATE INDEX IF NOT EXISTS idx_bllibros_biblioteca ON public.biblioteca_libros USING btree (biblioteca_id);
    CREATE INDEX IF NOT EXISTS idx_prestamos_bllibro_fecha ON public.prestamos USING btree (biblioteca_libro_id, fecha_prestamo);
    CREATE INDEX IF NOT EXISTS ix_usuario_biblioteca__biblio ON public.usuario_biblioteca USING btree (biblioteca_id);
    CREATE INDEX IF NOT EXISTS ix_usuario_biblioteca__usuario ON public.usuario_biblioteca USING btree (usuario_id);
    CREATE INDEX IF NOT EXISTS ix_usuarios_prefs_gin ON public.usuarios USING gin (preferencias);
    
    -- Trigger
    DROP TRIGGER IF EXISTS trg_admin_bibliotecas_only_role2 ON public.admin_bibliotecas;
    CREATE TRIGGER trg_admin_bibliotecas_only_role2 BEFORE INSERT OR UPDATE ON public.admin_bibliotecas FOR EACH ROW EXECUTE FUNCTION public._ensure_role_is_admin_cliente();
    
    -- Tabla para tokens de recuperación de contraseña
    CREATE TABLE IF NOT EXISTS public.password_reset_tokens (
        id SERIAL PRIMARY KEY,
        user_id INTEGER NOT NULL REFERENCES usuarios(id) ON DELETE CASCADE,
        token TEXT NOT NULL UNIQUE,
        expires_at TIMESTAMP NOT NULL,
        used BOOLEAN DEFAULT FALSE,
        created_at TIMESTAMP DEFAULT NOW()
    );
    
    CREATE INDEX IF NOT EXISTS idx_password_reset_tokens_user_id ON public.password_reset_tokens(user_id);
    CREATE INDEX IF NOT EXISTS idx_password_reset_tokens_token ON public.password_reset_tokens(token);
    CREATE INDEX IF NOT EXISTS idx_password_reset_tokens_expires_at ON public.password_reset_tokens(expires_at);
    
    -- Actualizar secuencias
    SELECT pg_catalog.setval('public.biblioteca_libros_id_seq', 35, true);
    SELECT pg_catalog.setval('public.bibliotecas_id_seq', 8, true);
    SELECT pg_catalog.setval('public.colegios_id_seq', 6, true);
    SELECT pg_catalog.setval('public.libros_id_seq', 32, true);
    SELECT pg_catalog.setval('public.prestamos_id_seq', 11, true);
    SELECT pg_catalog.setval('public.roles_id_seq', 3, true);
    SELECT pg_catalog.setval('public.usuarios_id_seq', 12, true);

