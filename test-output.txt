
> biblioteca-xonler-main@1.0.0 test
> jest --ci --reporters=default --reporters=jest-junit

PASS Biblioteca Xonler tests/unit/routes/usuarios.routes.test.js (5.22 s)
  usuarios.routes
    Ã”ÃªÃœ debe tener ruta GET / configurada (41 ms)
    Ã”ÃªÃœ debe tener ruta GET /me configurada (3 ms)
    Ã”ÃªÃœ debe tener ruta PUT /me configurada (1 ms)
    Ã”ÃªÃœ debe tener ruta GET /:id configurada (1 ms)
    Ã”ÃªÃœ debe tener ruta POST / configurada (1 ms)
    Ã”ÃªÃœ debe tener ruta PUT /:id configurada (1 ms)
    Ã”ÃªÃœ debe tener ruta DELETE /:id configurada

  console.log
    Â­Æ’Ã¶Ã¦ [ENCRYPTION] Clave maestra cargada exitosamente

      at SimpleEncryption.log [as initializeEncryption] (src/utils/simple-encryption.js:32:17)

  console.log
    Â­Æ’Ã¶Ã¦ [ENCRYPTION] Clave maestra cargada exitosamente

      at SimpleEncryption.log [as initializeEncryption] (src/utils/simple-encryption.js:32:17)

  console.log
    Â­Æ’Ã¶Ã¦ [ENCRYPTION] Clave maestra cargada exitosamente

      at SimpleEncryption.log [as initializeEncryption] (src/utils/simple-encryption.js:32:17)

  console.log
    [dotenv@17.2.3] injecting env (58) from .env -- tip: Â­Æ’Ã¶Ã‰ encrypt with Dotenvx: https://dotenvx.com

      at _log (node_modules/dotenv/lib/main.js:142:11)

PASS Biblioteca Xonler tests/unit/controllers/auth.controller.refresh.test.js (5.821 s)
  auth.controller - refresh y logout
    refresh - casos edge
      Ã”ÃªÃœ debe retornar 401 si no hay token (24 ms)
      Ã”ÃªÃœ debe usar token de cookie si estâ”œÃ­ disponible (2 ms)
      Ã”ÃªÃœ debe usar token de header si no hay cookie (2 ms)
      Ã”ÃªÃœ debe retornar 401 si el token es invâ”œÃ­lido (3 ms)
      Ã”ÃªÃœ debe retornar 404 si el usuario no existe (4 ms)
    logout - casos edge
      Ã”ÃªÃœ debe limpiar cookies de autenticaciâ”œâ”‚n (5 ms)

PASS Biblioteca Xonler tests/unit/utils/preferencias-helpers.complete.test.js (5.763 s)
  preferencias-helpers - cobertura completa
    validatePreferences - casos edge
      Ã”ÃªÃœ debe validar todos los campos opcionales (102 ms)
      Ã”ÃªÃœ debe retornar error para valores invâ”œÃ­lidos (3 ms)
    upsertPreferences - casos edge
      Ã”ÃªÃœ debe usar nullish coalescing para booleanos correctamente (3 ms)
      Ã”ÃªÃœ debe actualizar preferencias existentes con valores parciales (3 ms)

PASS Biblioteca Xonler tests/unit/controllers/auth.controller.password.test.js (5.788 s)
  auth.controller - password recovery
    forgotPassword - casos edge
      Ã”ÃªÃœ debe retornar mensaje genâ”œÂ®rico si el email no existe (28 ms)
      Ã”ÃªÃœ debe retornar token en desarrollo (4 ms)
      Ã”ÃªÃœ debe retornar mensaje genâ”œÂ®rico en producciâ”œâ”‚n (3 ms)
    verifyResetToken - casos edge
      Ã”ÃªÃœ debe retornar error si el token no tiene type correcto (1 ms)
      Ã”ÃªÃœ debe retornar error si el token no existe en BD (2 ms)
      Ã”ÃªÃœ debe retornar error si el token expirâ”œâ”‚ (2 ms)
      Ã”ÃªÃœ debe retornar error si el token ya fue usado (1 ms)
      Ã”ÃªÃœ debe manejar JsonWebTokenError (5 ms)
      Ã”ÃªÃœ debe manejar TokenExpiredError (1 ms)
    resetPassword - casos edge
      Ã”ÃªÃœ debe retornar error si la contraseâ”œâ–’a es muy corta (3 ms)
      Ã”ÃªÃœ debe actualizar contraseâ”œâ–’a y marcar token como usado (5 ms)
      Ã”ÃªÃœ debe usar BCRYPT_ROUNDS de env si estâ”œÃ­ configurado (2 ms)

PASS Biblioteca Xonler tests/unit/routes/index.routes.test.js (6.254 s)
  index.routes
    GET /api/health
      Ã”ÃªÃœ debe retornar estado de salud (385 ms)
    GET /api/
      Ã”ÃªÃœ debe retornar informaciâ”œâ”‚n de la API (75 ms)
    Rutas registradas
      Ã”ÃªÃœ debe tener ruta /api/auth (2 ms)
      Ã”ÃªÃœ debe tener ruta /api/usuarios (3 ms)
      Ã”ÃªÃœ debe tener ruta /api/libros (3 ms)

PASS Biblioteca Xonler tests/unit/src/utils/metrics.test.js
  src/utils/metrics.js
    Ã”ÃªÃœ debe exportar register (69 ms)
    Ã”ÃªÃœ debe exportar httpRequestDuration (6 ms)
    Ã”ÃªÃœ debe exportar httpRequestTotal (2 ms)
    Ã”ÃªÃœ debe exportar dbQueryDuration (2 ms)
    Ã”ÃªÃœ debe exportar dbQueryTotal (5 ms)
    Ã”ÃªÃœ debe exportar activeConnections (7 ms)

PASS Biblioteca Xonler tests/unit/utils/helpers.test.js
  Funciones Helper
    Ã”ÃªÃœ suma de dos nâ”œâ•‘meros (35 ms)
    Ã”ÃªÃœ validaciâ”œâ”‚n de email (2 ms)
    Ã”ÃªÃœ formateo de fecha (2 ms)
    Ã”ÃªÃœ normalizaciâ”œâ”‚n de string a objeto (2 ms)

  console.log
    Â­Æ’Ã¶Ã¦ [ENCRYPTION] Clave maestra cargada exitosamente

      at SimpleEncryption.log [as initializeEncryption] (src/utils/simple-encryption.js:32:17)

PASS Biblioteca Xonler tests/unit/config/database.direct.test.js
  database.js - test directo
    Ã”ÃªÃœ debe crear pool y exportar funciones (13 ms)
    Ã”ÃªÃœ debe probar conexiâ”œâ”‚n exitosamente (2 ms)
    Ã”ÃªÃœ debe manejar error en testConnection (1 ms)
    Ã”ÃªÃœ debe cerrar pool correctamente (1 ms)

  console.log
    Â­Æ’Ã¶Ã¦ [JWT] Nueva clave generada: 71d483c9-a46e-4b4b-8ea5-ef8db2314aff

      at JWTRotation.log [as generateNewKey] (src/utils/jwt-rotation.js:34:13)

  console.log
    Ã”Ã…â–‘ [JWT] Rotaciâ”œâ”‚n automâ”œÃ­tica configurada cada 1440 minutos

      at JWTRotation.log [as startKeyRotation] (src/utils/jwt-rotation.js:78:13)

  console.log
    Â­Æ’Ã´Ã¨ [MONITORING] Monitoreo en tiempo real iniciado (intervalo: 30000ms)

      at RealtimeMonitoring.log [as startMonitoring] (src/utils/realtime-monitoring.js:58:13)

  console.log
    [dotenv@17.2.3] injecting env (58) from .env -- tip: Ã”ÃœÃ–Â´Â©Ã…  enable debug logging with { debug: true }

      at _log (node_modules/dotenv/lib/main.js:142:11)

PASS Biblioteca Xonler tests/unit/routes/usuarios.routes.inline.test.js
  usuarios.routes - rutas inline
    GET /test
      Ã”ÃªÃœ debe tener ruta configurada (1 ms)
    GET /check/:id
      Ã”ÃªÃœ debe tener ruta configurada (3 ms)
    DELETE /test-delete/:id
      Ã”ÃªÃœ debe tener ruta configurada (1 ms)

  console.log
    Â­Æ’Ã¶Ã¦ [ENCRYPTION] Clave maestra cargada exitosamente

      at SimpleEncryption.log [as initializeEncryption] (src/utils/simple-encryption.js:32:17)

PASS Biblioteca Xonler tests/unit/controllers/supadmin.controller.additional.test.js
  supadmin.controller - casos adicionales
    obtenerLogs - casos edge
      Ã”ÃªÃœ debe procesar logs de tipo application (4 ms)
      Ã”ÃªÃœ debe procesar logs de tipo security (3 ms)
      Ã”ÃªÃœ debe procesar logs de tipo audit (1 ms)
      Ã”ÃªÃœ debe procesar logs de tipo error (1 ms)
      Ã”ÃªÃœ debe filtrar por nivel (1 ms)
      Ã”ÃªÃœ debe filtrar por fecha_desde (1 ms)
      Ã”ÃªÃœ debe filtrar por fecha_hasta (2 ms)
      Ã”ÃªÃœ debe aplicar paginaciâ”œâ”‚n (3 ms)

PASS Biblioteca Xonler tests/unit/bootstrap/register-base-middleware.test.js (7.067 s)
  register-base-middleware
    registerBaseMiddleware
      Ã”ÃªÃœ debe registrar middleware base (38 ms)

PASS Biblioteca Xonler tests/unit/routes/metrics.test.js
  metrics.routes
    GET /metrics
      Ã”ÃªÃœ debe retornar mâ”œÂ®tricas en formato Prometheus (25 ms)
      Ã”ÃªÃœ debe manejar errores (15 ms)

PASS Biblioteca Xonler tests/unit/routes/supadmin.routes.test.js
  supadmin.routes
    Ã”ÃªÃœ debe tener ruta GET /estadisticas configurada (1 ms)
    Ã”ÃªÃœ debe tener ruta GET /actividad configurada
    Ã”ÃªÃœ debe tener ruta GET /logs configurada (1 ms)

  console.log
    Â­Æ’Ã´Ã¨ [MONITORING] Monitoreo en tiempo real iniciado (intervalo: 30000ms)

      at RealtimeMonitoring.log [as startMonitoring] (src/utils/realtime-monitoring.js:58:13)

PASS Biblioteca Xonler tests/unit/bootstrap/register-routes.test.js (7.641 s)
  register-routes
    registerRoutes
      Ã”ÃªÃœ debe registrar rutas (70 ms)

PASS Biblioteca Xonler tests/unit/routes/colegios.routes.test.js
  colegios.routes
    Ã”ÃªÃœ debe tener ruta GET / configurada (2 ms)
    Ã”ÃªÃœ debe tener ruta GET /:id configurada
    Ã”ÃªÃœ debe tener ruta POST / configurada (5 ms)
    Ã”ÃªÃœ debe tener ruta PUT /:id configurada (1 ms)
    Ã”ÃªÃœ debe tener ruta DELETE /:id configurada (2 ms)

PASS Biblioteca Xonler tests/unit/routes/prestamos.routes.test.js
  prestamos.routes
    Ã”ÃªÃœ debe tener ruta GET /test configurada (1 ms)
    Ã”ÃªÃœ debe tener ruta GET /test-db configurada (1 ms)
    Ã”ÃªÃœ debe tener ruta GET /usuario/actual configurada
    Ã”ÃªÃœ debe tener ruta GET / configurada
    Ã”ÃªÃœ debe tener ruta GET /:id configurada
    Ã”ÃªÃœ debe tener ruta POST / configurada (1 ms)
    Ã”ÃªÃœ debe tener ruta POST /:id/devolucion configurada (1 ms)
    Ã”ÃªÃœ debe tener ruta POST /:id/renovar configurada (1 ms)

  console.log
    Â­Æ’Ã¶Ã¦ [ENCRYPTION] Clave maestra cargada exitosamente

      at SimpleEncryption.log [as initializeEncryption] (src/utils/simple-encryption.js:32:17)

PASS Biblioteca Xonler tests/unit/routes/biblioteca-libros.routes.test.js
  biblioteca-libros.routes
    Ã”ÃªÃœ debe tener ruta GET / configurada (2 ms)
    Ã”ÃªÃœ debe tener ruta GET /:id configurada
    Ã”ÃªÃœ debe tener ruta POST / configurada
    Ã”ÃªÃœ debe tener ruta DELETE /:id configurada (35 ms)
    Ã”ÃªÃœ debe tener ruta GET /:id/disponibilidad configurada (1 ms)

PASS Biblioteca Xonler tests/unit/routes/metrics.direct.test.js
  metrics.js - test directo
    Ã”ÃªÃœ debe tener ruta GET /metrics (93 ms)
    Ã”ÃªÃœ debe manejar errores en /metrics (25 ms)

PASS Biblioteca Xonler tests/unit/controllers/auth.controller.additional.test.js
  auth.controller - funciones adicionales
    forgotPassword
      Ã”ÃªÃœ debe generar token de reset si el usuario existe (6 ms)
      Ã”ÃªÃœ debe retornar 400 si falta el email (4 ms)
      Ã”ÃªÃœ debe retornar mensaje genâ”œÂ®rico si el usuario no existe (2 ms)
      Ã”ÃªÃœ debe manejar errores (2 ms)
    verifyResetToken
      Ã”ÃªÃœ debe verificar token vâ”œÃ­lido (5 ms)
      Ã”ÃªÃœ debe retornar 400 si falta el token (1 ms)
      Ã”ÃªÃœ debe retornar 400 si el token es invâ”œÃ­lido
      Ã”ÃªÃœ debe retornar 400 si el token no existe en DB
      Ã”ÃªÃœ debe retornar 400 si el token expirâ”œâ”‚ (2 ms)
      Ã”ÃªÃœ debe retornar 400 si el token ya fue usado (1 ms)
      Ã”ÃªÃœ debe manejar errores de JWT (1 ms)
    resetPassword
      Ã”ÃªÃœ debe restablecer contraseâ”œâ–’a exitosamente (2 ms)
      Ã”ÃªÃœ debe retornar 400 si faltan datos (1 ms)
      Ã”ÃªÃœ debe retornar 400 si la contraseâ”œâ–’a es muy corta
      Ã”ÃªÃœ debe retornar 400 si el token es invâ”œÃ­lido
      Ã”ÃªÃœ debe manejar errores (5 ms)

PASS Biblioteca Xonler tests/unit/controllers/auth.controller.test.js
  auth.controller
    register
      Ã”ÃªÃœ debe retornar error 400 si faltan campos obligatorios (2 ms)
      Ã”ÃªÃœ debe retornar error 409 si el email ya existe (1 ms)
      Ã”ÃªÃœ debe registrar un usuario exitosamente (2 ms)
      Ã”ÃªÃœ debe manejar errores internos (2 ms)
    login
      Ã”ÃªÃœ debe retornar error 400 si faltan email o password (1 ms)
      Ã”ÃªÃœ debe retornar error 401 si el usuario no existe (1 ms)
      Ã”ÃªÃœ debe retornar error 401 si la contraseâ”œâ–’a es incorrecta (2 ms)
      Ã”ÃªÃœ debe hacer login exitoso sin 2FA (2 ms)
      Ã”ÃªÃœ debe requerir 2FA si estâ”œÃ­ habilitado (2 ms)
      Ã”ÃªÃœ debe manejar errores internos (2 ms)
    me
      Ã”ÃªÃœ debe retornar informaciâ”œâ”‚n del usuario autenticado (2 ms)
      Ã”ÃªÃœ debe manejar errores internos (1 ms)
    refresh
      Ã”ÃªÃœ debe refrescar el token si es vâ”œÃ­lido (1 ms)
      Ã”ÃªÃœ debe retornar error 404 si el usuario no existe (9 ms)
    logout
      Ã”ÃªÃœ debe limpiar las cookies y retornar â”œÂ®xito (30 ms)

PASS Biblioteca Xonler tests/unit/services/libros.service.test.js
  libros.service
    searchLibros
      Ã”ÃªÃœ debe buscar libros sin filtros (4 ms)
      Ã”ÃªÃœ debe buscar libros con tâ”œÂ®rmino de bâ”œâ•‘squeda (2 ms)
      Ã”ÃªÃœ debe filtrar por categorâ”œÂ¡as (4 ms)
      Ã”ÃªÃœ debe filtrar por disponibilidad (1 ms)
      Ã”ÃªÃœ debe filtrar por biblioteca_id (incluyendo 0 como valor vâ”œÃ­lido) (2 ms)
      Ã”ÃªÃœ debe filtrar por biblioteca_id como string "0" (19 ms)
      Ã”ÃªÃœ debe ignorar biblioteca_id cuando es "todas"
      Ã”ÃªÃœ debe manejar paginaciâ”œâ”‚n (2 ms)
      Ã”ÃªÃœ debe manejar errores (33 ms)
    findLibroById
      Ã”ÃªÃœ debe encontrar un libro por ID (25 ms)
      Ã”ÃªÃœ debe retornar null si el libro no existe (1 ms)
      Ã”ÃªÃœ debe manejar errores (2 ms)
    createLibro
      Ã”ÃªÃœ debe crear un libro exitosamente (3 ms)
      Ã”ÃªÃœ debe lanzar error si falta tâ”œÂ¡tulo o autor (17 ms)
      Ã”ÃªÃœ debe manejar errores (1 ms)
    updateLibro
      Ã”ÃªÃœ debe actualizar un libro exitosamente (1 ms)
      Ã”ÃªÃœ debe lanzar AppError si el libro no existe (4 ms)
      Ã”ÃªÃœ debe manejar errores (2 ms)
    deleteLibro
      Ã”ÃªÃœ debe eliminar un libro exitosamente (2 ms)
      Ã”ÃªÃœ debe lanzar AppError si el libro no existe (1 ms)
      Ã”ÃªÃœ debe lanzar AppError si tiene prâ”œÂ®stamos asociados (1 ms)
      Ã”ÃªÃœ debe manejar errores (2 ms)
    updateLibroImage
      Ã”ÃªÃœ debe actualizar la imagen de un libro (1 ms)
      Ã”ÃªÃœ debe lanzar AppError si el libro no existe (1 ms)
    obtenerRecomendaciones
      Ã”ÃªÃœ debe obtener recomendaciones para usuario (26 ms)
      Ã”ÃªÃœ debe manejar usuario sin preferencias (4 ms)
      Ã”ÃªÃœ debe filtrar categorâ”œÂ¡as invâ”œÃ­lidas (1 ms)
      Ã”ÃªÃœ debe lanzar error si no hay usuario (2 ms)
      Ã”ÃªÃœ debe lanzar error si el usuario no existe
      Ã”ÃªÃœ debe manejar errores (3 ms)
    normalizeLibroFilters - casos edge
      Ã”ÃªÃœ searchLibros debe normalizar lâ”œÂ¡mite mâ”œÃ­ximo (1 ms)
      Ã”ÃªÃœ searchLibros debe normalizar offset negativo
      Ã”ÃªÃœ searchLibros debe parsear categorâ”œÂ¡as como string (1 ms)
      Ã”ÃªÃœ searchLibros debe filtrar por biblioteca_id (1 ms)

PASS Biblioteca Xonler tests/unit/controllers/colegios.controller.test.js
  colegios.controller
    obtenerColegios
      Ã”ÃªÃœ debe obtener colegios sin filtros (4 ms)
      Ã”ÃªÃœ debe filtrar por nombre (1 ms)
    obtenerColegioPorId
      Ã”ÃªÃœ debe obtener colegio por ID (1 ms)
      Ã”ÃªÃœ debe retornar 404 si no existe (4 ms)
    crearColegio
      Ã”ÃªÃœ debe exportar la funciâ”œâ”‚n crearColegio (4 ms)

PASS Biblioteca Xonler tests/unit/routes/prestamos.routes.inline.test.js
  prestamos.routes - rutas inline
    GET /test
      Ã”ÃªÃœ debe tener ruta configurada (4 ms)
    GET /test-db
      Ã”ÃªÃœ debe tener ruta configurada (2 ms)

PASS Biblioteca Xonler tests/unit/controllers/admin-biblioteca.controller.additional.test.js
  admin-biblioteca.controller - casos adicionales
    obtenerPrestamosBiblioteca - casos edge
      Ã”ÃªÃœ debe filtrar por estado=activos (3 ms)
      Ã”ÃªÃœ debe filtrar por estado=devueltos (1 ms)
      Ã”ÃªÃœ debe filtrar por estado=vencidos (1 ms)
      Ã”ÃªÃœ debe manejar estado desconocido (1 ms)
    marcarPrestamoDevuelto - casos edge
      Ã”ÃªÃœ debe retornar 404 si no hay biblioteca asignada (1 ms)
      Ã”ÃªÃœ debe retornar 400 si el prâ”œÂ®stamo ya fue devuelto (1 ms)
    crearLibro - casos edge
      Ã”ÃªÃœ debe crear libro sin agregar a biblioteca si agregar_a_biblioteca=false (2 ms)
      Ã”ÃªÃœ debe usar valores por defecto para campos opcionales (2 ms)

PASS Biblioteca Xonler tests/unit/controllers/auth.controller.me.test.js
  auth.controller - me
    me - casos edge
      Ã”ÃªÃœ debe retornar usuario si existe (7 ms)
      Ã”ÃªÃœ debe retornar 404 si el usuario no existe (3 ms)
      Ã”ÃªÃœ debe retornar 500 si hay error en la base de datos (1 ms)
      Ã”ÃªÃœ debe retornar 500 si req.user no existe (1 ms)

PASS Biblioteca Xonler tests/unit/routes/auth.routes.test.js
  auth.routes
    Ã”ÃªÃœ debe tener ruta POST /register configurada (4 ms)
    Ã”ÃªÃœ debe tener ruta POST /login configurada (1 ms)
    Ã”ÃªÃœ debe tener ruta GET /me configurada (1 ms)
    Ã”ÃªÃœ debe tener ruta POST /refresh configurada (1 ms)
    Ã”ÃªÃœ debe tener ruta POST /logout configurada (1 ms)
    Ã”ÃªÃœ debe tener ruta POST /forgot-password configurada (2 ms)
    Ã”ÃªÃœ debe tener ruta POST /verify-reset-token configurada (1 ms)
    Ã”ÃªÃœ debe tener ruta POST /reset-password configurada (1 ms)

PASS Biblioteca Xonler tests/unit/controllers/auth.controller.complete.test.js
  auth.controller - cobertura completa
    register - casos edge
      Ã”ÃªÃœ debe manejar error al obtener rol (3 ms)
      Ã”ÃªÃœ debe manejar error en inserciâ”œâ”‚n (2 ms)
    login - casos edge
      Ã”ÃªÃœ debe manejar error al verificar contraseâ”œâ–’a (2 ms)
      Ã”ÃªÃœ debe manejar error al generar token (1 ms)
    me - casos edge
      Ã”ÃªÃœ debe manejar error al obtener usuario (1 ms)
    refresh - casos edge
      Ã”ÃªÃœ debe manejar error al obtener usuario (1 ms)
    logout - casos edge
      Ã”ÃªÃœ debe manejar errores (1 ms)

PASS Biblioteca Xonler tests/unit/routes/libros.routes.test.js
  libros.routes
    Ã”ÃªÃœ debe tener ruta GET /test-db configurada (2 ms)
    Ã”ÃªÃœ debe tener ruta GET /test-table configurada (1 ms)
    Ã”ÃªÃœ debe tener ruta GET /recomendaciones configurada (1 ms)
    Ã”ÃªÃœ debe tener ruta GET / configurada
    Ã”ÃªÃœ debe tener ruta GET /:id configurada (1 ms)

  console.error
    Error al obtener ID del recurso: Error: Extractor error
        at extractor (C:\Users\MIGUEL\Documents\Proyectos-Cursor\biblioteca-xonler-main\tests\unit\utils\auth-helpers.test.js:263:39)
        at resourceIdExtractor (C:\Users\MIGUEL\Documents\Proyectos-Cursor\biblioteca-xonler-main\src\utils\auth-helpers.js:200:20)
        at Object.middleware (C:\Users\MIGUEL\Documents\Proyectos-Cursor\biblioteca-xonler-main\tests\unit\utils\auth-helpers.test.js:265:7)
        at Promise.then.completed (C:\Users\MIGUEL\Documents\Proyectos-Cursor\biblioteca-xonler-main\node_modules\jest-circus\build\utils.js:298:28)
        at new Promise (<anonymous>)
        at callAsyncCircusFn (C:\Users\MIGUEL\Documents\Proyectos-Cursor\biblioteca-xonler-main\node_modules\jest-circus\build\utils.js:231:10)
        at _callCircusTest (C:\Users\MIGUEL\Documents\Proyectos-Cursor\biblioteca-xonler-main\node_modules\jest-circus\build\run.js:316:40)
        at processTicksAndRejections (node:internal/process/task_queues:105:5)
        at _runTest (C:\Users\MIGUEL\Documents\Proyectos-Cursor\biblioteca-xonler-main\node_modules\jest-circus\build\run.js:252:3)
        at _runTestsForDescribeBlock (C:\Users\MIGUEL\Documents\Proyectos-Cursor\biblioteca-xonler-main\node_modules\jest-circus\build\run.js:126:9)
        at _runTestsForDescribeBlock (C:\Users\MIGUEL\Documents\Proyectos-Cursor\biblioteca-xonler-main\node_modules\jest-circus\build\run.js:121:9)
        at _runTestsForDescribeBlock (C:\Users\MIGUEL\Documents\Proyectos-Cursor\biblioteca-xonler-main\node_modules\jest-circus\build\run.js:121:9)
        at run (C:\Users\MIGUEL\Documents\Proyectos-Cursor\biblioteca-xonler-main\node_modules\jest-circus\build\run.js:71:3)
        at runAndTransformResultsToJestFormat (C:\Users\MIGUEL\Documents\Proyectos-Cursor\biblioteca-xonler-main\node_modules\jest-circus\build\legacy-code-todo-rewrite\jestAdapterInit.js:122:21)
        at jestAdapter (C:\Users\MIGUEL\Documents\Proyectos-Cursor\biblioteca-xonler-main\node_modules\jest-circus\build\legacy-code-todo-rewrite\jestAdapter.js:79:19)
        at runTestInternal (C:\Users\MIGUEL\Documents\Proyectos-Cursor\biblioteca-xonler-main\node_modules\jest-runner\build\runTest.js:367:16)
        at runTest (C:\Users\MIGUEL\Documents\Proyectos-Cursor\biblioteca-xonler-main\node_modules\jest-runner\build\runTest.js:444:34)
        at Object.worker (C:\Users\MIGUEL\Documents\Proyectos-Cursor\biblioteca-xonler-main\node_modules\jest-runner\build\testWorker.js:106:12)

    [0m [90m 200 |[39m       resourceId [33m=[39m resourceIdExtractor(req)[33m;[39m
     [90m 201 |[39m     } [36mcatch[39m (err) {
    [31m[1m>[22m[39m[90m 202 |[39m       console[33m.[39merror([32m'Error al obtener ID del recurso:'[39m[33m,[39m err)[33m;[39m
     [90m     |[39m               [31m[1m^[22m[39m
     [90m 203 |[39m       [36mreturn[39m forbidden(res[33m,[39m [32m'Error al obtener ID del recurso'[39m)[33m;[39m
     [90m 204 |[39m     }
     [90m 205 |[39m     [0m

      at error (src/utils/auth-helpers.js:202:15)
      at Object.middleware (tests/unit/utils/auth-helpers.test.js:265:7)

PASS Biblioteca Xonler tests/unit/utils/auth-helpers.test.js
  auth-helpers
    getUserId
      Ã”ÃªÃœ debe retornar null si req no es vâ”œÃ­lido (25 ms)
      Ã”ÃªÃœ debe obtener ID de req.user (1 ms)
      Ã”ÃªÃœ debe obtener ID de req.auth.sub (1 ms)
      Ã”ÃªÃœ debe obtener ID de req.userId (4 ms)
      Ã”ÃªÃœ debe priorizar req.user sobre req.auth (5 ms)
    getUserRole
      Ã”ÃªÃœ debe retornar null si req no es vâ”œÃ­lido (1 ms)
      Ã”ÃªÃœ debe obtener rol de req.user.role (1 ms)
      Ã”ÃªÃœ debe obtener rol de req.user.rol (alternativo) (1 ms)
      Ã”ÃªÃœ debe retornar null si no hay rol (1 ms)
    isAuthenticated
      Ã”ÃªÃœ debe retornar false si no hay usuario (1 ms)
      Ã”ÃªÃœ debe retornar true si hay usuario (1 ms)
    hasRole
      Ã”ÃªÃœ debe retornar false si role no es string vâ”œÃ­lido (1 ms)
      Ã”ÃªÃœ debe retornar true si el usuario tiene el rol (1 ms)
      Ã”ÃªÃœ debe retornar false si el usuario no tiene el rol (1 ms)
      Ã”ÃªÃœ debe hacer trim del rol
    isAdmin
      Ã”ÃªÃœ debe retornar true para admin (1 ms)
      Ã”ÃªÃœ debe retornar true para supadmin
      Ã”ÃªÃœ debe retornar false para otros roles (1 ms)
    requireAuth
      Ã”ÃªÃœ debe llamar unauthorized si req no es vâ”œÃ­lido (2 ms)
      Ã”ÃªÃœ debe llamar unauthorized si no estâ”œÃ­ autenticado (1 ms)
      Ã”ÃªÃœ debe llamar next si estâ”œÃ­ autenticado (1 ms)
    requireRole
      Ã”ÃªÃœ debe lanzar error si role no es string vâ”œÃ­lido (89 ms)
      Ã”ÃªÃœ debe llamar unauthorized si no estâ”œÃ­ autenticado (1 ms)
      Ã”ÃªÃœ debe llamar forbidden si no tiene el rol requerido (2 ms)
      Ã”ÃªÃœ debe permitir acceso a admin aunque no tenga el rol especâ”œÂ¡fico (1 ms)
      Ã”ÃªÃœ debe llamar next si tiene el rol requerido
    canAccessResource
      Ã”ÃªÃœ debe retornar false si req no es vâ”œÃ­lido
      Ã”ÃªÃœ debe retornar false si no estâ”œÃ­ autenticado (1 ms)
      Ã”ÃªÃœ debe retornar true si es admin
      Ã”ÃªÃœ debe retornar true si es propietario (1 ms)
      Ã”ÃªÃœ debe retornar false si no es propietario ni admin
      Ã”ÃªÃœ debe manejar resourceUserId como string
      Ã”ÃªÃœ debe retornar false para string invâ”œÃ­lido (1 ms)
    requireResourceAccess
      Ã”ÃªÃœ debe lanzar error si extractor no es funciâ”œâ”‚n (2 ms)
      Ã”ÃªÃœ debe llamar unauthorized si no estâ”œÃ­ autenticado (2 ms)
      Ã”ÃªÃœ debe llamar forbidden si no puede acceder al recurso (1 ms)
      Ã”ÃªÃœ debe llamar next si puede acceder al recurso (11 ms)
      Ã”ÃªÃœ debe manejar errores del extractor (45 ms)

  console.log
    Â­Æ’Ã¶Ã† Acceso autorizado para usuario 1 con rol admin

      at log (src/utils/auth-middleware-helpers.js:58:13)

  console.log
    Â­Æ’Ã¶Ã† Acceso autorizado para usuario 1 con rol admin

      at log (src/utils/auth-middleware-helpers.js:78:13)

  console.log
    Â­Æ’Ã¶Ã† admin 1 accediendo a recurso 999

      at log (src/utils/auth-middleware-helpers.js:98:15)

PASS Biblioteca Xonler tests/unit/config/database-ssl.test.js
  database-ssl
    createSecurePool
      Ã”ÃªÃœ debe crear pool con SSL en producciâ”œâ”‚n (5 ms)
      Ã”ÃªÃœ debe crear pool sin SSL en desarrollo (3 ms)
    getSSLConfig
      Ã”ÃªÃœ debe retornar configuraciâ”œâ”‚n para development (1 ms)
      Ã”ÃªÃœ debe retornar configuraciâ”œâ”‚n para production (5 ms)
    validateSSLConfig
      Ã”ÃªÃœ debe validar configuraciâ”œâ”‚n SSL (10 ms)
      Ã”ÃªÃœ debe retornar false si faltan variables SSL en producciâ”œâ”‚n (1 ms)

  console.log
    Â­Æ’Ã¶Ã† supadmin 1 accediendo a recurso 999

      at log (src/utils/auth-middleware-helpers.js:98:15)

  console.log
    Â­Æ’Ã¶Ã† Usuario 1 accediendo a su propio recurso 1

      at log (src/utils/auth-middleware-helpers.js:110:13)

  console.log
    Â­Æ’Ã¶Ã† Usuario 1 accediendo a su propio recurso 1

      at log (src/utils/auth-middleware-helpers.js:110:13)

  console.log
    Â­Æ’Ã¶Ã† Permiso manage_users concedido para usuario 1

      at log (src/utils/auth-middleware-helpers.js:247:13)

PASS Biblioteca Xonler tests/unit/utils/auth-middleware-helpers.test.js
  auth-middleware-helpers
    checkAuthentication
      Ã”ÃªÃœ debe retornar false y llamar unauthorized si no hay usuario (2 ms)
      Ã”ÃªÃœ debe retornar true si hay usuario (1 ms)
    hasRoleAccess
      Ã”ÃªÃœ debe retornar true si el usuario es admin (1 ms)
      Ã”ÃªÃœ debe retornar true si el usuario es supadmin
      Ã”ÃªÃœ debe retornar true si el rol coincide con string requerido (1 ms)
      Ã”ÃªÃœ debe retornar false si el rol no coincide (1 ms)
      Ã”ÃªÃœ debe retornar true si el rol estâ”œÃ­ en el array requerido (2 ms)
      Ã”ÃªÃœ debe retornar false si el rol no estâ”œÃ­ en el array requerido (1 ms)
    requireRole
      Ã”ÃªÃœ debe llamar unauthorized si no hay usuario (21 ms)
      Ã”ÃªÃœ debe llamar forbidden si el usuario no tiene el rol requerido (4 ms)
      Ã”ÃªÃœ debe llamar next si el usuario tiene el rol requerido (17 ms)
    requireAnyRole
      Ã”ÃªÃœ debe llamar unauthorized si no hay usuario (1 ms)
      Ã”ÃªÃœ debe llamar forbidden si el usuario no tiene ninguno de los roles (1 ms)
      Ã”ÃªÃœ debe llamar next si el usuario tiene uno de los roles (4 ms)
    requireOwnershipOrAdmin
      Ã”ÃªÃœ debe llamar unauthorized si no hay usuario (1 ms)
      Ã”ÃªÃœ debe permitir acceso a admin (7 ms)
      Ã”ÃªÃœ debe permitir acceso a supadmin (38 ms)
      Ã”ÃªÃœ debe permitir acceso si el usuario es propietario (3 ms)
      Ã”ÃªÃœ debe llamar forbidden si el usuario no es propietario ni admin (1 ms)
      Ã”ÃªÃœ debe usar el parâ”œÃ­metro personalizado (5 ms)
    extractTokenFromHeader
      Ã”ÃªÃœ debe retornar null si no hay header authorization
      Ã”ÃªÃœ debe retornar null si el header no empieza con Bearer (1 ms)
      Ã”ÃªÃœ debe extraer el token correctamente (1 ms)
      Ã”ÃªÃœ debe retornar null si el token estâ”œÃ­ vacâ”œÂ¡o (1 ms)
    setUserFromDecoded
      Ã”ÃªÃœ debe configurar req.user con informaciâ”œâ”‚n del token (1 ms)
      Ã”ÃªÃœ debe usar id si user_id no existe (1 ms)
      Ã”ÃªÃœ debe agregar authSource si se proporciona (1 ms)
    handleAuthError
      Ã”ÃªÃœ debe manejar JsonWebTokenError (31 ms)
      Ã”ÃªÃœ debe manejar TokenExpiredError (2 ms)
      Ã”ÃªÃœ debe retornar false para errores no reconocidos (2 ms)
      Ã”ÃªÃœ debe agregar authSource a la respuesta si se proporciona (3 ms)
    handleAuthServerError
      Ã”ÃªÃœ debe retornar respuesta 500 (3 ms)
      Ã”ÃªÃœ debe incluir authSource si se proporciona (4 ms)
    checkPermission
      Ã”ÃªÃœ debe llamar unauthorized si no hay usuario (5 ms)
      Ã”ÃªÃœ debe llamar forbidden si el usuario no tiene el permiso (3 ms)
      Ã”ÃªÃœ debe llamar next si el usuario tiene el permiso (7 ms)

  console.warn
    Error en conversiâ”œâ”‚n de tipo, usando valor por defecto: Error

    [0m [90m 23 |[39m       [36mreturn[39m converterFn(value[33m,[39m customDefault)[33m;[39m
     [90m 24 |[39m     } [36mcatch[39m (err) {
    [31m[1m>[22m[39m[90m 25 |[39m       console[33m.[39mwarn([32m'Error en conversiâ”œâ”‚n de tipo, usando valor por defecto:'[39m[33m,[39m err[33m.[39mmessage)[33m;[39m
     [90m    |[39m               [31m[1m^[22m[39m
     [90m 26 |[39m       [36mif[39m (customDefault [33m===[39m undefined) {
     [90m 27 |[39m         [36mreturn[39m defaultValue[33m;[39m
     [90m 28 |[39m       }[0m

      at warn (src/utils/data-helpers.js:25:15)
      at Object.converter (tests/unit/utils/data-helpers.test.js:47:14)

PASS Biblioteca Xonler tests/unit/routes/bibliotecas.routes.test.js
  bibliotecas.routes
    Ã”ÃªÃœ debe tener ruta GET / configurada (1 ms)
    Ã”ÃªÃœ debe tener ruta GET /:id configurada
    Ã”ÃªÃœ debe tener ruta GET /:id/libros configurada (1 ms)
    Ã”ÃªÃœ debe tener ruta POST / configurada (1 ms)
    Ã”ÃªÃœ debe tener ruta PUT /:id configurada
    Ã”ÃªÃœ debe tener ruta DELETE /:id configurada

  console.warn
    Error en conversiâ”œâ”‚n de tipo, usando valor por defecto: Error

    [0m [90m 23 |[39m       [36mreturn[39m converterFn(value[33m,[39m customDefault)[33m;[39m
     [90m 24 |[39m     } [36mcatch[39m (err) {
    [31m[1m>[22m[39m[90m 25 |[39m       console[33m.[39mwarn([32m'Error en conversiâ”œâ”‚n de tipo, usando valor por defecto:'[39m[33m,[39m err[33m.[39mmessage)[33m;[39m
     [90m    |[39m               [31m[1m^[22m[39m
     [90m 26 |[39m       [36mif[39m (customDefault [33m===[39m undefined) {
     [90m 27 |[39m         [36mreturn[39m defaultValue[33m;[39m
     [90m 28 |[39m       }[0m

      at warn (src/utils/data-helpers.js:25:15)
      at Object.converter (tests/unit/utils/data-helpers.test.js:54:14)

PASS Biblioteca Xonler tests/unit/controllers/preferencias.controller.test.js
  preferencias.controller
    getPreferenciasMe
      Ã”ÃªÃœ debe obtener preferencias del usuario actual (5 ms)
      Ã”ÃªÃœ debe crear preferencias por defecto si no existen (1 ms)
    putPreferenciasMe
      Ã”ÃªÃœ debe actualizar preferencias del usuario actual (1 ms)
      Ã”ÃªÃœ debe retornar error si la validaciâ”œâ”‚n falla (2 ms)
    getPreferenciasById
      Ã”ÃªÃœ debe obtener preferencias por ID si es admin (3 ms)
      Ã”ÃªÃœ debe permitir al usuario ver sus propias preferencias (1 ms)
      Ã”ÃªÃœ debe retornar 403 si no tiene permisos (1 ms)
      Ã”ÃªÃœ debe retornar 404 si las preferencias no existen (1 ms)
    putPreferenciasById
      Ã”ÃªÃœ debe actualizar preferencias por ID si es admin (1 ms)
      Ã”ÃªÃœ debe retornar 403 si no tiene permisos

  console.warn
    Error parseando JSON, retornando objeto vacâ”œÂ¡o: Unexpected token 'i', "invalid json" is not valid JSON

    [0m [90m 64 |[39m     } [36mcatch[39m (error) {
     [90m 65 |[39m       [90m// Error de parsing JSON - retornar objeto vacâ”œÂ¡o[39m
    [31m[1m>[22m[39m[90m 66 |[39m       console[33m.[39mwarn([32m'Error parseando JSON, retornando objeto vacâ”œÂ¡o:'[39m[33m,[39m error[33m.[39mmessage)[33m;[39m
     [90m    |[39m               [31m[1m^[22m[39m
     [90m 67 |[39m       [36mreturn[39m {}[33m;[39m
     [90m 68 |[39m     }
     [90m 69 |[39m   }[0m

      at warn (src/utils/data-helpers.js:66:15)
      at Object.asObject (tests/unit/utils/data-helpers.test.js:83:14)

PASS Biblioteca Xonler tests/unit/routes/libros.routes.inline.test.js
  libros.routes - rutas inline
    GET /test-db
      Ã”ÃªÃœ debe tener ruta configurada (2 ms)
    GET /test-table
      Ã”ÃªÃœ debe tener ruta configurada (2 ms)

PASS Biblioteca Xonler tests/unit/bootstrap/register-base-middleware.complete.test.js
  register-base-middleware - cobertura completa
    Ã”ÃªÃœ debe registrar todos los middlewares (4 ms)
    Ã”ÃªÃœ debe registrar helmetConfig (1 ms)
    Ã”ÃªÃœ debe registrar requestLogger (1 ms)
    Ã”ÃªÃœ debe registrar securityLogger (1 ms)
    Ã”ÃªÃœ debe adjuntar encryptedLogger (1 ms)
    Ã”ÃªÃœ debe registrar inputValidator (1 ms)
    Ã”ÃªÃœ debe registrar security monitoring middlewares (27 ms)
    Ã”ÃªÃœ debe registrar performance monitoring (6 ms)
    Ã”ÃªÃœ debe registrar express.json (3 ms)
    Ã”ÃªÃœ debe registrar cookieParser (3 ms)
    Ã”ÃªÃœ debe registrar CORS con configuraciâ”œâ”‚n correcta (1 ms)
    Ã”ÃªÃœ debe registrar debug logging (3 ms)

PASS Biblioteca Xonler tests/unit/utils/data-helpers.test.js
  data-helpers
    isFiniteNumber
      Ã”ÃªÃœ debe retornar true para nâ”œâ•‘meros finitos vâ”œÃ­lidos (2 ms)
      Ã”ÃªÃœ debe retornar false para valores no numâ”œÂ®ricos (17 ms)
      Ã”ÃªÃœ debe retornar false para NaN e Infinity (1 ms)
    createTypeConverter
      Ã”ÃªÃœ debe crear un convertidor que ejecuta la funciâ”œâ”‚n (1 ms)
      Ã”ÃªÃœ debe retornar valor por defecto cuando falla (39 ms)
      Ã”ÃªÃœ debe usar customDefault si se proporciona (34 ms)
    asObject
      Ã”ÃªÃœ debe retornar objeto vacâ”œÂ¡o para null/undefined (3 ms)
      Ã”ÃªÃœ debe retornar el objeto si ya es un objeto (5 ms)
      Ã”ÃªÃœ debe parsear string JSON vâ”œÃ­lido (2 ms)
      Ã”ÃªÃœ debe retornar objeto vacâ”œÂ¡o para string vacâ”œÂ¡o (5 ms)
      Ã”ÃªÃœ debe retornar objeto vacâ”œÂ¡o para arrays (2 ms)
      Ã”ÃªÃœ debe retornar objeto vacâ”œÂ¡o para JSON invâ”œÃ­lido (7 ms)
    asBoolean
      Ã”ÃªÃœ debe retornar false para null/undefined
      Ã”ÃªÃœ debe retornar el valor para booleanos (1 ms)
      Ã”ÃªÃœ debe convertir strings a boolean (47 ms)
      Ã”ÃªÃœ debe convertir nâ”œâ•‘meros a boolean (1 ms)
    asNumber
      Ã”ÃªÃœ debe convertir strings numâ”œÂ®ricos (1 ms)
      Ã”ÃªÃœ debe retornar valor por defecto para valores invâ”œÃ­lidos (1 ms)
      Ã”ÃªÃœ debe retornar el nâ”œâ•‘mero si ya es un nâ”œâ•‘mero
      Ã”ÃªÃœ debe retornar default para NaN
    asInteger
      Ã”ÃªÃœ debe convertir strings a enteros (1 ms)
      Ã”ÃªÃœ debe retornar valor por defecto para valores invâ”œÃ­lidos (1 ms)
      Ã”ÃªÃœ debe convertir nâ”œâ•‘meros a enteros (2 ms)
    sanitizeString
      Ã”ÃªÃœ debe eliminar tags HTML (1 ms)
      Ã”ÃªÃœ debe escapar caracteres especiales (1 ms)
      Ã”ÃªÃœ debe eliminar caracteres de control (1 ms)
      Ã”ÃªÃœ debe trim espacios
      Ã”ÃªÃœ debe retornar string vacâ”œÂ¡o para valores no string (1 ms)
    cleanObject
      Ã”ÃªÃœ debe eliminar propiedades undefined/null/vacâ”œÂ¡as (2 ms)
      Ã”ÃªÃœ debe retornar objeto vacâ”œÂ¡o para objeto vacâ”œÂ¡o
    getValue
      Ã”ÃªÃœ debe obtener valor de objeto (1 ms)
      Ã”ÃªÃœ debe retornar default si no existe
      Ã”ÃªÃœ debe retornar default para objeto invâ”œÃ­lido (1 ms)
    indexBy
      Ã”ÃªÃœ debe indexar array por clave (1 ms)
      Ã”ÃªÃœ debe retornar objeto vacâ”œÂ¡o para array vacâ”œÂ¡o
      Ã”ÃªÃœ debe retornar objeto vacâ”œÂ¡o para clave invâ”œÃ­lida

  console.log
    Â­Æ’Ã¶Ã¦ [ENCRYPTION] Clave maestra cargada exitosamente

      at SimpleEncryption.log [as initializeEncryption] (src/utils/simple-encryption.js:32:17)

PASS Biblioteca Xonler tests/unit/utils/error-handler.test.js
  error-handler
    getPostgresErrorMessage
      Ã”ÃªÃœ debe retornar mensaje para câ”œâ”‚digo conocido (2 ms)
      Ã”ÃªÃœ debe retornar mensaje por defecto para câ”œâ”‚digo desconocido (1 ms)
      Ã”ÃªÃœ debe retornar mensaje por defecto para câ”œâ”‚digo invâ”œÃ­lido
    getPostgresErrorStatusCode
      Ã”ÃªÃœ debe retornar câ”œâ”‚digo HTTP para câ”œâ”‚digo conocido
      Ã”ÃªÃœ debe retornar 500 para câ”œâ”‚digo desconocido (1 ms)
    validateResponse
      Ã”ÃªÃœ debe lanzar error si res no es vâ”œÃ­lido (45 ms)
      Ã”ÃªÃœ no debe lanzar error si res es vâ”œÃ­lido (2 ms)
    validateError
      Ã”ÃªÃœ debe retornar el error si existe (1 ms)
      Ã”ÃªÃœ debe retornar nuevo error si no existe (1 ms)
    handleError
      Ã”ÃªÃœ debe manejar errores de PostgreSQL (11 ms)
      Ã”ÃªÃœ debe manejar errores genâ”œÂ®ricos (1 ms)
      Ã”ÃªÃœ debe usar mensaje por defecto si no hay mensaje (2 ms)
    asyncHandler
      Ã”ÃªÃœ debe envolver funciâ”œâ”‚n async y manejar errores (2 ms)
      Ã”ÃªÃœ debe ejecutar funciâ”œâ”‚n exitosamente (1 ms)
    promiseHandler
      Ã”ÃªÃœ debe manejar promesa exitosa (1 ms)
      Ã”ÃªÃœ debe manejar promesa rechazada (4 ms)
      Ã”ÃªÃœ debe lanzar error si no es promesa (20 ms)

[33mwarn[39m: Intento de autenticaciâ”œâ”‚n fallido {"attempts":1,"body":{},"ip":"192.168.1.1","timestamp":"2025-11-13T19:38:37.294Z","type":"security"}
[33mwarn[39m: Intento de autenticaciâ”œâ”‚n fallido {"attempts":1,"body":{},"ip":"192.168.1.1","timestamp":"2025-11-13T19:38:37.356Z","type":"security"}
[33mwarn[39m: Intento de autenticaciâ”œâ”‚n fallido {"attempts":2,"body":{},"ip":"192.168.1.1","timestamp":"2025-11-13T19:38:37.357Z","type":"security"}
[33mwarn[39m: Intento de autenticaciâ”œâ”‚n fallido {"attempts":3,"body":{},"ip":"192.168.1.1","timestamp":"2025-11-13T19:38:37.358Z","type":"security"}
[33mwarn[39m: Intento de autenticaciâ”œâ”‚n fallido {"attempts":4,"body":{},"ip":"192.168.1.1","timestamp":"2025-11-13T19:38:37.359Z","type":"security"}
[33mwarn[39m: Intento de autenticaciâ”œâ”‚n fallido {"attempts":5,"body":{},"ip":"192.168.1.1","timestamp":"2025-11-13T19:38:37.360Z","type":"security"}
[31merror[39m: IP bloqueada por intentos excesivos {"attempts":5,"blockedUntil":"2025-11-13T20:38:37.357Z","ip":"192.168.1.1","timestamp":"2025-11-13T19:38:37.361Z","type":"security"}
[33mwarn[39m: Intento de autenticaciâ”œâ”‚n fallido {"attempts":6,"body":{},"ip":"192.168.1.1","timestamp":"2025-11-13T19:38:37.362Z","type":"security"}
[31merror[39m: IP bloqueada por intentos excesivos {"attempts":6,"blockedUntil":"2025-11-13T20:38:37.356Z","ip":"192.168.1.1","timestamp":"2025-11-13T19:38:37.364Z","type":"security"}
[33mwarn[39m: Acceso bloqueado desde IP {"ip":"192.168.1.1","reason":"IP bloqueada por intentos fallidos","timestamp":"2025-11-13T19:38:37.366Z","type":"security","url":"/api/test"}
[33mwarn[39m: Intento de autenticaciâ”œâ”‚n fallido {"attempts":7,"body":{},"ip":"192.168.1.1","timestamp":"2025-11-13T19:38:37.376Z","type":"security"}
[31merror[39m: IP bloqueada por intentos excesivos {"attempts":7,"blockedUntil":"2025-11-13T20:38:37.359Z","ip":"192.168.1.1","timestamp":"2025-11-13T19:38:37.379Z","type":"security"}
[33mwarn[39m: Intento de autenticaciâ”œâ”‚n fallido {"attempts":8,"body":{},"ip":"192.168.1.1","timestamp":"2025-11-13T19:38:37.381Z","type":"security"}
[31merror[39m: IP bloqueada por intentos excesivos {"attempts":8,"blockedUntil":"2025-11-13T20:38:37.357Z","ip":"192.168.1.1","timestamp":"2025-11-13T19:38:37.382Z","type":"security"}
[33mwarn[39m: Intento de autenticaciâ”œâ”‚n fallido {"attempts":9,"body":{},"ip":"192.168.1.1","timestamp":"2025-11-13T19:38:37.383Z","type":"security"}
[31merror[39m: IP bloqueada por intentos excesivos {"attempts":9,"blockedUntil":"2025-11-13T20:38:37.356Z","ip":"192.168.1.1","timestamp":"2025-11-13T19:38:37.383Z","type":"security"}
[33mwarn[39m: Acceso bloqueado desde IP {"ip":"192.168.1.1","reason":"IP bloqueada por intentos fallidos","timestamp":"2025-11-13T19:38:37.384Z","type":"security","url":"/api/test"}
[33mwarn[39m: Intento de autenticaciâ”œâ”‚n fallido {"attempts":10,"body":{},"ip":"192.168.1.1","timestamp":"2025-11-13T19:38:37.384Z","type":"security"}
[31merror[39m: IP bloqueada por intentos excesivos {"attempts":10,"blockedUntil":"2025-11-13T20:38:37.359Z","ip":"192.168.1.1","timestamp":"2025-11-13T19:38:37.385Z","type":"security"}
[33mwarn[39m: Intento de autenticaciâ”œâ”‚n fallido {"attempts":11,"body":{},"ip":"192.168.1.1","timestamp":"2025-11-13T19:38:37.385Z","type":"security"}
[31merror[39m: IP bloqueada por intentos excesivos {"attempts":11,"blockedUntil":"2025-11-13T20:38:37.357Z","ip":"192.168.1.1","timestamp":"2025-11-13T19:38:37.386Z","type":"security"}
[33mwarn[39m: Intento de autenticaciâ”œâ”‚n fallido {"attempts":12,"body":{},"ip":"192.168.1.1","timestamp":"2025-11-13T19:38:37.386Z","type":"security"}
[31merror[39m: IP bloqueada por intentos excesivos {"attempts":12,"blockedUntil":"2025-11-13T20:38:37.356Z","ip":"192.168.1.1","timestamp":"2025-11-13T19:38:37.388Z","type":"security"}
[32minfo[39m: Audit Event {"action":"DATA_CHANGE","details":{"body":{},"ip":"192.168.1.1","method":"GET","query":{},"statusCode":201,"url":"/api/test"},"ip":"192.168.1.1","timestamp":"2025-11-13T19:38:37.395Z","type":"audit","userId":1}
PASS Biblioteca Xonler tests/unit/middleware/security-monitoring.complete.test.js
  security-monitoring - cobertura completa
    monitorAuthAttempts - casos edge
      Ã”ÃªÃœ debe limpiar intentos antiguos (9 ms)
      Ã”ÃªÃœ debe registrar intento fallido en respuesta 401 (63 ms)
      Ã”ÃªÃœ debe bloquear IP despuâ”œÂ®s de maxAttempts (34 ms)
    monitorSuspiciousActivity - casos edge
      Ã”ÃªÃœ debe detectar mâ”œâ•‘ltiples patrones (3 ms)
      Ã”ÃªÃœ debe detectar headers sospechosos
    monitorDataChanges - casos edge
      Ã”ÃªÃœ debe registrar cambios en endpoints sensibles (5 ms)
      Ã”ÃªÃœ no debe registrar si no es endpoint sensible

PASS Biblioteca Xonler tests/unit/controllers/admin-biblioteca.controller.test.js
  admin-biblioteca.controller
    obtenerBibliotecaAsignada
      Ã”ÃªÃœ debe obtener la biblioteca asignada (7 ms)
      Ã”ÃªÃœ debe retornar 404 si no hay biblioteca asignada (5 ms)
      Ã”ÃªÃœ debe manejar errores (2 ms)
    obtenerEstadisticasBiblioteca
      Ã”ÃªÃœ debe obtener estadâ”œÂ¡sticas de la biblioteca (2 ms)
      Ã”ÃªÃœ debe retornar 404 si no hay biblioteca asignada (1 ms)
      Ã”ÃªÃœ debe manejar errores (2 ms)
    obtenerLibrosBiblioteca
      Ã”ÃªÃœ debe obtener libros de la biblioteca (3 ms)
      Ã”ÃªÃœ debe filtrar por tâ”œÂ®rmino de bâ”œâ•‘squeda
      Ã”ÃªÃœ debe filtrar por categorâ”œÂ¡a (1 ms)
      Ã”ÃªÃœ debe retornar 404 si no hay biblioteca asignada
      Ã”ÃªÃœ debe manejar errores (1 ms)
    agregarLibroABiblioteca
      Ã”ÃªÃœ debe agregar libro a la biblioteca (4 ms)
      Ã”ÃªÃœ debe retornar 409 si el libro ya estâ”œÃ­ en la biblioteca (1 ms)
      Ã”ÃªÃœ debe retornar 404 si el libro no existe
      Ã”ÃªÃœ debe retornar 400 si falta libro_id (1 ms)
      Ã”ÃªÃœ debe retornar 404 si no hay biblioteca asignada (1 ms)
      Ã”ÃªÃœ debe manejar errores (1 ms)
    removerLibroDeBiblioteca
      Ã”ÃªÃœ debe remover libro de la biblioteca (1 ms)
      Ã”ÃªÃœ debe retornar 400 si tiene prâ”œÂ®stamos activos (1 ms)
      Ã”ÃªÃœ debe retornar 404 si el libro no estâ”œÃ­ en la biblioteca (1 ms)
      Ã”ÃªÃœ debe retornar 404 si no hay biblioteca asignada
      Ã”ÃªÃœ debe manejar errores
    crearLibro
      Ã”ÃªÃœ debe crear un libro exitosamente (1 ms)
      Ã”ÃªÃœ debe retornar 400 si faltan campos requeridos (1 ms)
      Ã”ÃªÃœ debe retornar 404 si no hay biblioteca asignada
      Ã”ÃªÃœ debe manejar errores (1 ms)
    obtenerPrestamosBiblioteca
      Ã”ÃªÃœ debe obtener prâ”œÂ®stamos de la biblioteca (2 ms)
      Ã”ÃªÃœ debe retornar 404 si no hay biblioteca asignada (1 ms)
      Ã”ÃªÃœ debe manejar errores (1 ms)
    marcarPrestamoDevuelto
      Ã”ÃªÃœ debe marcar prâ”œÂ®stamo como devuelto (1 ms)
      Ã”ÃªÃœ debe retornar 400 si el prâ”œÂ®stamo ya fue devuelto (1 ms)
      Ã”ÃªÃœ debe retornar 404 si no hay biblioteca asignada (2 ms)
      Ã”ÃªÃœ debe retornar 404 si el prâ”œÂ®stamo no existe (1 ms)
      Ã”ÃªÃœ debe manejar errores (2 ms)

PASS Biblioteca Xonler tests/unit/utils/http-response.test.js
  http-response
    validateResponse
      Ã”ÃªÃœ debe lanzar error si res no es vâ”œÃ­lido (69 ms)
      Ã”ÃªÃœ no debe lanzar error si res es vâ”œÃ­lido (1 ms)
    validateStatusCode
      Ã”ÃªÃœ debe retornar el câ”œâ”‚digo si es vâ”œÃ­lido (2 ms)
      Ã”ÃªÃœ debe retornar 500 para câ”œâ”‚digos invâ”œÃ­lidos (2 ms)
    validateMessage
      Ã”ÃªÃœ debe retornar el mensaje si es vâ”œÃ­lido
      Ã”ÃªÃœ debe retornar valor por defecto para mensajes invâ”œÃ­lidos (6 ms)
    success
      Ã”ÃªÃœ debe retornar respuesta exitosa con datos (7 ms)
      Ã”ÃªÃœ debe retornar respuesta exitosa sin mensaje
    error
      Ã”ÃªÃœ debe retornar respuesta de error (1 ms)
      Ã”ÃªÃœ debe usar câ”œâ”‚digo 500 por defecto (2 ms)
    badRequest
      Ã”ÃªÃœ debe retornar 400
    notFound
      Ã”ÃªÃœ debe retornar 404
    unauthorized
      Ã”ÃªÃœ debe retornar 401 (1 ms)
    forbidden
      Ã”ÃªÃœ debe retornar 403
    conflict
      Ã”ÃªÃœ debe retornar 409 (1 ms)
    created
      Ã”ÃªÃœ debe retornar 201
    noContent
      Ã”ÃªÃœ debe retornar 204 (1 ms)
    paginated
      Ã”ÃªÃœ debe retornar respuesta paginada (1 ms)
    json
      Ã”ÃªÃœ debe retornar JSON directo (1 ms)
    createResponse
      Ã”ÃªÃœ debe crear respuesta con statusCode y datos (1 ms)

PASS Biblioteca Xonler tests/unit/utils/error-handler.additional.test.js
  error-handler - casos adicionales
    handleError - casos edge
      Ã”ÃªÃœ debe manejar AppError con statusCode invâ”œÃ­lido (5 ms)
      Ã”ÃªÃœ debe manejar AppError con details (1 ms)
      Ã”ÃªÃœ debe manejar AppError sin message (1 ms)
      Ã”ÃªÃœ debe manejar todos los câ”œâ”‚digos de error de PostgreSQL (5 ms)
      Ã”ÃªÃœ debe manejar error con câ”œâ”‚digo no string (1 ms)
      Ã”ÃªÃœ debe manejar fallbackMessage vacâ”œÂ¡o (1 ms)
      Ã”ÃªÃœ debe manejar context no string (1 ms)
    asyncHandler - casos edge
      Ã”ÃªÃœ debe lanzar error si fn no es funciâ”œâ”‚n (36 ms)
      Ã”ÃªÃœ debe manejar errorMessage vacâ”œÂ¡o (2 ms)
      Ã”ÃªÃœ debe usar nombre de funciâ”œâ”‚n si estâ”œÃ­ disponible (1 ms)
    promiseHandler - casos edge
      Ã”ÃªÃœ debe manejar AppError en promesa (2 ms)
      Ã”ÃªÃœ debe manejar errorMessage vacâ”œÂ¡o (1 ms)
      Ã”ÃªÃœ debe lanzar error si promise es null (2 ms)
      Ã”ÃªÃœ debe lanzar error si promise es undefined (3 ms)
      Ã”ÃªÃœ debe lanzar error si no es promesa (1 ms)

  console.error
    Error verificando token JWT: JsonWebTokenError {
      name: 'JsonWebTokenError',
      message: 'invalid token'
    }

    [0m [90m 30 |[39m       })[33m;[39m
     [90m 31 |[39m     } [36mcatch[39m (error) {
    [31m[1m>[22m[39m[90m 32 |[39m       console[33m.[39merror([32m'Error verificando token JWT:'[39m[33m,[39m error)[33m;[39m
     [90m    |[39m               [31m[1m^[22m[39m
     [90m 33 |[39m       [36mthrow[39m [36mnew[39m [33mError[39m([32m'Token invâ”œÃ­lido'[39m)[33m;[39m
     [90m 34 |[39m     }
     [90m 35 |[39m   }[0m

      at SimpleJWT.error [as verifyToken] (src/utils/simple-jwt.js:32:15)
      at verifyToken (tests/unit/utils/simple-jwt.test.js:29:11)
      at Object.<anonymous> (node_modules/expect/build/toThrowMatchers.js:74:11)
      at Object.throwingMatcher [as toThrow] (node_modules/expect/build/index.js:320:21)
      at Object.toThrow (tests/unit/utils/simple-jwt.test.js:30:8)

PASS Biblioteca Xonler tests/unit/utils/simple-jwt.test.js
  SimpleJWT
    Ã”ÃªÃœ debe generar un token JWT vâ”œÃ­lido (16 ms)
    Ã”ÃªÃœ debe verificar un token vâ”œÃ­lido correctamente (38 ms)
    Ã”ÃªÃœ debe lanzar error al verificar token invâ”œÃ­lido (59 ms)
    Ã”ÃªÃœ debe generar token con expiraciâ”œâ”‚n personalizada (5 ms)

PASS Biblioteca Xonler tests/unit/controllers/supadmin.controller.test.js
  supadmin.controller
    obtenerEstadisticasGlobales
      Ã”ÃªÃœ debe obtener estadâ”œÂ¡sticas globales exitosamente (5 ms)
      Ã”ÃªÃœ debe manejar errores (19 ms)
    obtenerLogs
      Ã”ÃªÃœ debe obtener logs de aplicaciâ”œâ”‚n (4 ms)
      Ã”ÃªÃœ debe obtener logs de seguridad (1 ms)
      Ã”ÃªÃœ debe obtener logs de auditorâ”œÂ¡a (7 ms)
      Ã”ÃªÃœ debe obtener logs de error (2 ms)
      Ã”ÃªÃœ debe filtrar logs por nivel (3 ms)
      Ã”ÃªÃœ debe aplicar paginaciâ”œâ”‚n (1 ms)
      Ã”ÃªÃœ debe manejar errores (2 ms)
    obtenerActividadReciente
      Ã”ÃªÃœ debe obtener actividad reciente exitosamente (4 ms)
      Ã”ÃªÃœ debe filtrar por tipo (4 ms)
      Ã”ÃªÃœ debe manejar errores (4 ms)

PASS Biblioteca Xonler tests/unit/utils/query-builder.test.js
  QueryBuilder
    constructor
      Ã”ÃªÃœ debe inicializar con query base (5 ms)
    where
      Ã”ÃªÃœ debe agregar condiciâ”œâ”‚n WHERE simple (4 ms)
      Ã”ÃªÃœ debe ignorar valores null/undefined/vacâ”œÂ¡os
      Ã”ÃªÃœ debe soportar operador ILIKE (2 ms)
      Ã”ÃªÃœ debe soportar operador IN con array (3 ms)
      Ã”ÃªÃœ debe ignorar array vacâ”œÂ¡o en IN (2 ms)
    whereRaw
      Ã”ÃªÃœ debe agregar condiciâ”œâ”‚n raw sin parâ”œÃ­metros
      Ã”ÃªÃœ debe reemplazar placeholders ? con parâ”œÃ­metros numerados (2 ms)
    orderBy
      Ã”ÃªÃœ debe agregar ORDER BY (2 ms)
      Ã”ÃªÃœ debe usar ASC por defecto (2 ms)
    paginate
      Ã”ÃªÃœ debe establecer limit y offset (1 ms)
      Ã”ÃªÃœ debe validar limit mâ”œÂ¡nimo
      Ã”ÃªÃœ debe validar offset mâ”œÂ¡nimo (1 ms)
    build
      Ã”ÃªÃœ debe construir query completa (5 ms)
      Ã”ÃªÃœ debe construir query sin WHERE si no hay condiciones

PASS Biblioteca Xonler tests/unit/utils/http-response.additional.test.js
  http-response - casos adicionales
    success - casos edge
      Ã”ÃªÃœ debe manejar data null (2 ms)
      Ã”ÃªÃœ debe manejar message vacâ”œÂ¡o (11 ms)
      Ã”ÃªÃœ debe manejar message con espacios
      Ã”ÃªÃœ debe manejar statusCode personalizado
    error - casos edge
      Ã”ÃªÃœ debe manejar details null (1 ms)
      Ã”ÃªÃœ debe manejar details undefined
    notFound - casos edge
      Ã”ÃªÃœ debe manejar resource vacâ”œÂ¡o (1 ms)
      Ã”ÃªÃœ debe manejar resource con espacios (3 ms)
    paginated - casos edge
      Ã”ÃªÃœ debe manejar data no array
      Ã”ÃªÃœ debe manejar total negativo (3 ms)
      Ã”ÃªÃœ debe manejar limit negativo (1 ms)
      Ã”ÃªÃœ debe manejar offset negativo (1 ms)
      Ã”ÃªÃœ debe manejar valores decimales (10 ms)
      Ã”ÃªÃœ debe manejar statusCode personalizado (2 ms)
    validateMessage - casos edge
      Ã”ÃªÃœ debe manejar mensaje con solo espacios
      Ã”ÃªÃœ debe manejar mensaje undefined (1 ms)
    validateStatusCode - casos edge
      Ã”ÃªÃœ debe manejar câ”œâ”‚digos en lâ”œÂ¡mites (1 ms)
      Ã”ÃªÃœ debe manejar câ”œâ”‚digos fuera de lâ”œÂ¡mites (1 ms)

PASS Biblioteca Xonler tests/unit/routes/admin-biblioteca.routes.test.js
  admin-biblioteca.routes
    Ã”ÃªÃœ debe tener ruta GET /biblioteca configurada (1 ms)
    Ã”ÃªÃœ debe tener ruta GET /estadisticas configurada
    Ã”ÃªÃœ debe tener ruta GET /libros configurada (1 ms)
    Ã”ÃªÃœ debe tener ruta POST /libros configurada
    Ã”ÃªÃœ debe tener ruta POST /libros/crear configurada (1 ms)
    Ã”ÃªÃœ debe tener ruta DELETE /libros/:biblioteca_libro_id configurada
    Ã”ÃªÃœ debe tener ruta GET /prestamos configurada (1 ms)
    Ã”ÃªÃœ debe tener ruta PATCH /prestamos/:prestamo_id/devolver configurada

PASS Biblioteca Xonler tests/unit/controllers/prestamos.controller.complete.test.js
  prestamos.controller - cobertura completa
    buildPrestamosFilters
      Ã”ÃªÃœ debe construir filtros con todos los parâ”œÃ­metros (13 ms)
      Ã”ÃªÃœ debe manejar activo=false (3 ms)
    crearPrestamo - casos edge
      Ã”ÃªÃœ debe manejar error en transacciâ”œâ”‚n (23 ms)
    marcarDevolucion - casos edge
      Ã”ÃªÃœ debe manejar error al actualizar (10 ms)
    renovarPrestamo - casos edge
      Ã”ÃªÃœ debe manejar error al actualizar (1 ms)

PASS Biblioteca Xonler tests/unit/utils/cookie-utils.test.js
  cookie-utils
    setSecureCookie
      Ã”ÃªÃœ debe establecer cookie con opciones por defecto (31 ms)
      Ã”ÃªÃœ debe establecer cookie en producciâ”œâ”‚n con secure=true (2 ms)
      Ã”ÃªÃœ debe usar dominio si estâ”œÃ­ configurado (5 ms)
      Ã”ÃªÃœ debe sobrescribir opciones por defecto (1 ms)
      Ã”ÃªÃœ debe truncar valores muy largos (3 ms)
      Ã”ÃªÃœ debe manejar valores null o undefined
    clearSecureCookie
      Ã”ÃªÃœ debe limpiar cookie con opciones correctas (3 ms)
      Ã”ÃªÃœ debe usar dominio si estâ”œÃ­ configurado
    setAuthCookies
      Ã”ÃªÃœ debe establecer cookies de autenticaciâ”œâ”‚n (1 ms)
      Ã”ÃªÃœ debe retornar false si no hay token
      Ã”ÃªÃœ debe usar remember para extender duraciâ”œâ”‚n
      Ã”ÃªÃœ debe manejar user con rol o role (1 ms)
      Ã”ÃªÃœ debe manejar user con nombre o name (1 ms)
      Ã”ÃªÃœ debe establecer solo token si no hay user (2 ms)
    clearAuthCookies
      Ã”ÃªÃœ debe limpiar todas las cookies de autenticaciâ”œâ”‚n (2 ms)
    checkCookieStatus
      Ã”ÃªÃœ debe verificar estado de cookies cuando existen (1 ms)
      Ã”ÃªÃœ debe verificar estado cuando no hay cookies (1 ms)
      Ã”ÃªÃœ debe manejar req sin cookies (1 ms)
      Ã”ÃªÃœ debe verificar estado parcial (1 ms)

PASS Biblioteca Xonler tests/unit/middleware/hybrid-auth.test.js
  hybrid-auth middleware
    hybridAuth
      Ã”ÃªÃœ debe usar token de cookie si estâ”œÃ­ disponible (2 ms)
      Ã”ÃªÃœ debe usar token de header Authorization como fallback (6 ms)
      Ã”ÃªÃœ debe retornar 401 si no hay token (1 ms)
      Ã”ÃªÃœ debe manejar errores de autenticaciâ”œâ”‚n (1 ms)
    debugAuth
      Ã”ÃªÃœ debe ejecutar next sin modificar request (1 ms)
      Ã”ÃªÃœ debe mostrar informaciâ”œâ”‚n de usuario si estâ”œÃ­ presente (50 ms)

PASS Biblioteca Xonler tests/unit/controllers/usuarios.controller.test.js
  usuarios.controller
    obtenerUsuarios
      Ã”ÃªÃœ debe obtener todos los usuarios sin filtros (5 ms)
      Ã”ÃªÃœ debe filtrar por rol (3 ms)
      Ã”ÃªÃœ debe buscar por texto (1 ms)
      Ã”ÃªÃœ debe manejar paginaciâ”œâ”‚n (2 ms)
      Ã”ÃªÃœ debe manejar errores (5 ms)
    obtenerUsuarioActual
      Ã”ÃªÃœ debe retornar error 401 si no hay usuario autenticado (1 ms)
      Ã”ÃªÃœ debe obtener el usuario actual desde req.user (5 ms)
      Ã”ÃªÃœ debe obtener el usuario actual desde req.userId (1 ms)
      Ã”ÃªÃœ debe manejar errores (1 ms)
    obtenerUsuarioPorId
      Ã”ÃªÃœ debe obtener un usuario por ID (2 ms)
      Ã”ÃªÃœ debe retornar 404 si el usuario no existe (4 ms)
      Ã”ÃªÃœ debe manejar errores (1 ms)
    crearUsuario
      Ã”ÃªÃœ debe retornar error 400 si faltan campos obligatorios (1 ms)
      Ã”ÃªÃœ debe retornar error 400 si el email ya existe (1 ms)
      Ã”ÃªÃœ debe crear un usuario exitosamente (2 ms)
      Ã”ÃªÃœ debe manejar errores (2 ms)
    loginUsuario
      Ã”ÃªÃœ debe retornar error 400 si faltan datos (1 ms)
      Ã”ÃªÃœ debe retornar error 401 si las credenciales son incorrectas (1 ms)
      Ã”ÃªÃœ debe retornar error 401 si la contraseâ”œâ–’a es incorrecta (1 ms)
      Ã”ÃªÃœ debe hacer login exitoso y generar token (2 ms)
      Ã”ÃªÃœ debe manejar errores (1 ms)

PASS Biblioteca Xonler tests/unit/controllers/bibliotecas.controller.test.js
  bibliotecas.controller
    obtenerBibliotecas
      Ã”ÃªÃœ debe obtener todas las bibliotecas sin filtros (3 ms)
      Ã”ÃªÃœ debe filtrar por tâ”œÂ®rmino de bâ”œâ•‘squeda (1 ms)
      Ã”ÃªÃœ debe filtrar por colegio_id
      Ã”ÃªÃœ debe manejar paginaciâ”œâ”‚n (24 ms)
      Ã”ÃªÃœ debe limitar el lâ”œÂ¡mite mâ”œÃ­ximo a 100 (2 ms)
      Ã”ÃªÃœ debe manejar errores (14 ms)

PASS Biblioteca Xonler tests/unit/controllers/supadmin.controller.complete.test.js
  supadmin.controller - cobertura completa
    obtenerEstadisticasGlobales - casos edge
      Ã”ÃªÃœ debe procesar datos vacâ”œÂ¡os correctamente (3 ms)
      Ã”ÃªÃœ debe manejar error en consultas (1 ms)
      Ã”ÃªÃœ debe procesar categorâ”œÂ¡as null como "Sin categorâ”œÂ¡a" (1 ms)
    obtenerActividadReciente - casos edge
      Ã”ÃªÃœ debe filtrar por tipo si se proporciona (1 ms)
      Ã”ÃªÃœ debe manejar error de base de datos
    obtenerLogs - casos edge
      Ã”ÃªÃœ debe manejar error en processApplicationLogs

PASS Biblioteca Xonler tests/unit/controllers/prestamos.controller.additional.test.js
  prestamos.controller - casos adicionales
    buildPrestamosFilters - casos edge
      Ã”ÃªÃœ debe filtrar por activo=false (5 ms)
      Ã”ÃªÃœ debe filtrar por fecha_desde (1 ms)
      Ã”ÃªÃœ debe filtrar por fecha_hasta (1 ms)
      Ã”ÃªÃœ debe filtrar por mâ”œâ•‘ltiples filtros
      Ã”ÃªÃœ debe manejar errores

PASS Biblioteca Xonler tests/unit/controllers/prestamos.controller.test.js
  prestamos.controller
    obtenerPrestamos
      Ã”ÃªÃœ debe obtener todos los prâ”œÂ®stamos sin filtros (10 ms)
      Ã”ÃªÃœ debe filtrar por usuario_id (2 ms)
      Ã”ÃªÃœ debe filtrar por biblioteca_id (1 ms)
      Ã”ÃªÃœ debe filtrar por activo=true (1 ms)
      Ã”ÃªÃœ debe filtrar por activo=false (1 ms)
      Ã”ÃªÃœ debe manejar paginaciâ”œâ”‚n (1 ms)
      Ã”ÃªÃœ debe manejar errores (1 ms)
    obtenerPrestamoPorId
      Ã”ÃªÃœ debe obtener un prâ”œÂ®stamo por ID (1 ms)
      Ã”ÃªÃœ debe retornar 404 si el prâ”œÂ®stamo no existe (1 ms)
      Ã”ÃªÃœ debe manejar errores (1 ms)
    crearPrestamo
      Ã”ÃªÃœ debe retornar 401 si no hay usuario autenticado (2 ms)
      Ã”ÃªÃœ debe retornar 400 si falta libro_id (1 ms)
      Ã”ÃªÃœ debe retornar 404 si el libro no existe (1 ms)
      Ã”ÃªÃœ debe retornar 409 si el libro no estâ”œÃ­ disponible (1 ms)
      Ã”ÃªÃœ debe retornar 404 si no hay copias disponibles
      Ã”ÃªÃœ debe retornar 409 si el usuario ya tiene un prâ”œÂ®stamo activo (1 ms)
      Ã”ÃªÃœ debe crear un prâ”œÂ®stamo exitosamente (2 ms)
      Ã”ÃªÃœ debe manejar errores en transacciâ”œâ”‚n (2 ms)
    marcarDevolucion
      Ã”ÃªÃœ debe retornar 404 si el prâ”œÂ®stamo no existe (1 ms)
      Ã”ÃªÃœ debe retornar 400 si el prâ”œÂ®stamo ya fue devuelto (1 ms)
      Ã”ÃªÃœ debe retornar 403 si no tiene permisos (1 ms)
      Ã”ÃªÃœ debe permitir a admin devolver cualquier prâ”œÂ®stamo (1 ms)
      Ã”ÃªÃœ debe marcar devoluciâ”œâ”‚n exitosamente (3 ms)
      Ã”ÃªÃœ debe manejar errores (1 ms)
    renovarPrestamo
      Ã”ÃªÃœ debe retornar 404 si el prâ”œÂ®stamo no existe (1 ms)
      Ã”ÃªÃœ debe retornar 400 si el prâ”œÂ®stamo ya fue devuelto (1 ms)
      Ã”ÃªÃœ debe retornar 403 si no tiene permisos (1 ms)
      Ã”ÃªÃœ debe retornar 400 si el prâ”œÂ®stamo estâ”œÃ­ vencido (1 ms)
      Ã”ÃªÃœ debe renovar prâ”œÂ®stamo exitosamente (2 ms)
      Ã”ÃªÃœ debe manejar errores (1 ms)
    obtenerPrestamosUsuarioActual
      Ã”ÃªÃœ debe manejar error si no hay usuario autenticado (1 ms)
      Ã”ÃªÃœ debe obtener prâ”œÂ®stamos del usuario actual (1 ms)
      Ã”ÃªÃœ debe manejar errores

PASS Biblioteca Xonler tests/unit/routes/twofa.routes.test.js
  twofa.routes
    Ã”ÃªÃœ debe tener ruta POST /login/2fa configurada (2 ms)
    Ã”ÃªÃœ debe tener ruta POST /2fa/setup configurada (1 ms)
    Ã”ÃªÃœ debe tener ruta POST /2fa/verify configurada (1 ms)
    Ã”ÃªÃœ debe tener ruta POST /2fa/disable configurada
    Ã”ÃªÃœ debe tener ruta GET /2fa/status configurada (1 ms)

PASS Biblioteca Xonler tests/unit/controllers/prestamos.controller.additional2.test.js
  prestamos.controller - casos adicionales 2
    crearPrestamo - casos edge
      Ã”ÃªÃœ debe retornar 401 si no estâ”œÃ­ autenticado (2 ms)
      Ã”ÃªÃœ debe retornar 404 si el libro no existe (6 ms)
      Ã”ÃªÃœ debe retornar 409 si el libro no estâ”œÃ­ disponible (1 ms)
      Ã”ÃªÃœ debe retornar 409 si ya tiene prâ”œÂ®stamo activo del mismo libro (1 ms)
      Ã”ÃªÃœ debe usar fecha_prestamo del body si se proporciona (2 ms)
      Ã”ÃªÃœ debe hacer rollback en caso de error (5 ms)
    marcarDevolucion - casos edge
      Ã”ÃªÃœ debe retornar 403 si no es el propietario ni admin (2 ms)
      Ã”ÃªÃœ debe permitir a admin devolver cualquier prâ”œÂ®stamo (1 ms)
    renovarPrestamo - casos edge
      Ã”ÃªÃœ debe retornar 403 si no es el propietario (4 ms)
      Ã”ÃªÃœ debe retornar 400 si el prâ”œÂ®stamo estâ”œÃ­ vencido (1 ms)

PASS Biblioteca Xonler tests/unit/utils/preferencias-helpers.additional.test.js
  preferencias-helpers - casos adicionales
    validatePreferences - casos edge
      Ã”ÃªÃœ debe validar todos los idiomas permitidos (2 ms)
      Ã”ÃªÃœ debe validar todos los temas permitidos (1 ms)
      Ã”ÃªÃœ debe validar todos los tamaâ”œâ–’os de fuente permitidos (1 ms)
      Ã”ÃªÃœ debe validar todos los maxResultados permitidos (6 ms)
      Ã”ÃªÃœ debe retornar valid: true si no hay preferencias (1 ms)
    getPreferencesByUserId
      Ã”ÃªÃœ debe retornar null si no hay preferencias (2 ms)
      Ã”ÃªÃœ debe retornar preferencias si existen (1 ms)
    createDefaultPreferences
      Ã”ÃªÃœ debe crear preferencias con valores por defecto (2 ms)
    upsertPreferences - casos edge
      Ã”ÃªÃœ debe crear preferencias si no existen (1 ms)
      Ã”ÃªÃœ debe actualizar preferencias si existen (1 ms)
      Ã”ÃªÃœ debe usar valores por defecto para campos faltantes en insert (1 ms)
      Ã”ÃªÃœ debe usar nullish coalescing para booleanos

PASS Biblioteca Xonler tests/unit/controllers/twofa.controller.complete.test.js
  twofa.controller - cobertura completa
    get2FAStatus - casos edge
      Ã”ÃªÃœ debe usar req.auth.sub si estâ”œÃ­ disponible (2 ms)
      Ã”ÃªÃœ debe usar req.user.id si req.auth no estâ”œÃ­ disponible (2 ms)
    setup2FA - casos edge
      Ã”ÃªÃœ debe manejar error al generar QR (1 ms)
      Ã”ÃªÃœ debe usar nombre si email no estâ”œÃ­ disponible (5 ms)
    verify2FA - casos edge
      Ã”ÃªÃœ debe manejar error al verificar câ”œâ”‚digo (1 ms)
    disable2FA - casos edge
      Ã”ÃªÃœ debe manejar error al desactivar (1 ms)
    verify2FALogin - casos edge
      Ã”ÃªÃœ debe manejar error al obtener rol (2 ms)
    generatePending2FAToken
      Ã”ÃªÃœ debe generar token con sub y twofa (3 ms)

PASS Biblioteca Xonler tests/unit/utils/validation-helpers.test.js
  validation-helpers
    createValidator
      Ã”ÃªÃœ debe crear un validador que retorna valid: true cuando la funciâ”œâ”‚n retorna true (2 ms)
      Ã”ÃªÃœ debe crear un validador que retorna valid: false cuando la funciâ”œâ”‚n retorna false (1 ms)
      Ã”ÃªÃœ debe manejar errores en la funciâ”œâ”‚n validadora (2 ms)
      Ã”ÃªÃœ debe aceptar un objeto con valid como resultado (1 ms)
    validateRequired
      Ã”ÃªÃœ debe retornar valid: true cuando todos los campos estâ”œÃ­n presentes (1 ms)
      Ã”ÃªÃœ debe retornar valid: false cuando faltan campos (1 ms)
      Ã”ÃªÃœ debe retornar error cuando fields no es un array (1 ms)
      Ã”ÃªÃœ debe retornar error cuando data no es un objeto (1 ms)
      Ã”ÃªÃœ debe ignorar campos vacâ”œÂ¡os en la lista de campos
    requireFields
      Ã”ÃªÃœ debe llamar next() cuando todos los campos estâ”œÃ­n presentes (1 ms)
      Ã”ÃªÃœ debe retornar badRequest cuando faltan campos (1 ms)
      Ã”ÃªÃœ debe retornar error cuando req.body no existe (1 ms)
    isValidEmail
      Ã”ÃªÃœ debe validar emails correctos (1 ms)
      Ã”ÃªÃœ debe rechazar emails invâ”œÃ­lidos (3 ms)
      Ã”ÃªÃœ debe rechazar valores no string (2 ms)
    validateEmail
      Ã”ÃªÃœ debe validar email y retornar null si es vâ”œÃ­lido (1 ms)
      Ã”ÃªÃœ debe retornar badRequest si email es invâ”œÃ­lido (1 ms)
      Ã”ÃªÃœ debe lanzar error si res no es vâ”œÃ­lido (28 ms)
    validateEnum
      Ã”ÃªÃœ debe validar valores en enum (2 ms)
      Ã”ÃªÃœ debe rechazar valores fuera del enum
      Ã”ÃªÃœ debe retornar error si allowedValues no es array (1 ms)
    validateRange
      Ã”ÃªÃœ debe validar nâ”œâ•‘meros en rango (1 ms)
      Ã”ÃªÃœ debe rechazar nâ”œâ•‘meros fuera de rango
      Ã”ÃªÃœ debe retornar error si rango es invâ”œÃ­lido (1 ms)
      Ã”ÃªÃœ debe validar strings numâ”œÂ®ricos
    validateId
      Ã”ÃªÃœ debe validar IDs numâ”œÂ®ricos vâ”œÃ­lidos (1 ms)
      Ã”ÃªÃœ debe retornar badRequest para IDs invâ”œÃ­lidos (1 ms)
      Ã”ÃªÃœ debe rechazar IDs negativos o cero

PASS Biblioteca Xonler tests/unit/controllers/libros.controller.test.js
  libros.controller
    obtenerLibros
      Ã”ÃªÃœ debe obtener lista de libros (33 ms)
      Ã”ÃªÃœ debe manejar errores de AppError (2 ms)
      Ã”ÃªÃœ debe manejar errores de PostgreSQL 42P01 (4 ms)
      Ã”ÃªÃœ debe manejar errores de PostgreSQL 42703 (5 ms)
      Ã”ÃªÃœ debe manejar errores genâ”œÂ®ricos (1 ms)
    obtenerLibroPorId
      Ã”ÃªÃœ debe obtener un libro por ID (1 ms)
      Ã”ÃªÃœ debe retornar 404 si el libro no existe (1 ms)
      Ã”ÃªÃœ debe manejar errores (1 ms)
    crearLibro
      Ã”ÃªÃœ debe crear un libro exitosamente (5 ms)
      Ã”ÃªÃœ debe manejar errores de AppError (1 ms)
      Ã”ÃªÃœ debe manejar errores genâ”œÂ®ricos (1 ms)
    actualizarLibro
      Ã”ÃªÃœ debe actualizar un libro exitosamente (1 ms)
      Ã”ÃªÃœ debe manejar errores (1 ms)
    eliminarLibro
      Ã”ÃªÃœ debe eliminar un libro exitosamente (1 ms)
      Ã”ÃªÃœ debe manejar errores
    subirImagenLibro
      Ã”ÃªÃœ debe retornar 400 si no hay archivo (1 ms)
      Ã”ÃªÃœ debe subir imagen exitosamente (1 ms)
      Ã”ÃªÃœ debe manejar errores (1 ms)
    obtenerRecomendaciones
      Ã”ÃªÃœ debe obtener recomendaciones para usuario autenticado (4 ms)
      Ã”ÃªÃœ debe obtener recomendaciones sin usuario (2 ms)
      Ã”ÃªÃœ debe manejar errores (2 ms)

PASS Biblioteca Xonler tests/unit/bootstrap/register-error-handlers.test.js
  register-error-handlers
    registerErrorHandlers
      Ã”ÃªÃœ debe registrar manejadores de error (2 ms)

PASS Biblioteca Xonler tests/unit/middleware/jwt-compatibility.test.js
  jwt-compatibility middleware
    Ã”ÃªÃœ debe continuar si no hay header Authorization (2 ms)
    Ã”ÃªÃœ debe continuar si el header no empieza con Bearer (1 ms)
    Ã”ÃªÃœ debe verificar token con jwt-rotation exitosamente (3 ms)
    Ã”ÃªÃœ debe usar verificaciâ”œâ”‚n directa si jwt-rotation falla (1 ms)
    Ã”ÃªÃœ debe retornar 401 si ambas verificaciones fallan (2 ms)

PASS Biblioteca Xonler tests/unit/utils/preferencias-helpers.test.js
  preferencias-helpers
    DEFAULT_PREFERENCES
      Ã”ÃªÃœ debe tener valores por defecto correctos (2 ms)
    validatePreferences
      Ã”ÃªÃœ debe validar preferencias vâ”œÃ­lidas
      Ã”ÃªÃœ debe rechazar idioma invâ”œÃ­lido (1 ms)
      Ã”ÃªÃœ debe rechazar tema invâ”œÃ­lido (1 ms)
      Ã”ÃªÃœ debe rechazar tamaâ”œâ–’o de fuente invâ”œÃ­lido
      Ã”ÃªÃœ debe rechazar mâ”œÃ­ximo de resultados invâ”œÃ­lido (1 ms)
      Ã”ÃªÃœ debe aceptar preferencias parciales (1 ms)
    getPreferencesByUserId
      Ã”ÃªÃœ debe retornar preferencias si existen (1 ms)
      Ã”ÃªÃœ debe retornar null si no existen preferencias
    createDefaultPreferences
      Ã”ÃªÃœ debe crear preferencias por defecto (1 ms)
    upsertPreferences
      Ã”ÃªÃœ debe crear nuevas preferencias si no existen (1 ms)
      Ã”ÃªÃœ debe actualizar preferencias existentes (1 ms)
      Ã”ÃªÃœ debe usar valores por defecto con nullish coalescing (1 ms)

PASS Biblioteca Xonler tests/unit/middleware/security.test.js
  middleware/security
    authRateLimit
      Ã”ÃªÃœ debe crear un rate limiter para autenticaciâ”œâ”‚n (13 ms)
    apiRateLimit
      Ã”ÃªÃœ debe crear un rate limiter para API general (1 ms)
    sensitiveRateLimit
      Ã”ÃªÃœ debe crear un rate limiter para endpoints sensibles (2 ms)
    helmetConfig
      Ã”ÃªÃœ debe configurar helmet con opciones de seguridad (4 ms)
    securityLogger
      Ã”ÃªÃœ debe continuar sin problemas para requests normales (3 ms)
      Ã”ÃªÃœ debe detectar path traversal (1 ms)
      Ã”ÃªÃœ debe detectar intentos de XSS (1 ms)
      Ã”ÃªÃœ debe detectar SQL injection (1 ms)
      Ã”ÃªÃœ debe detectar JavaScript injection (1 ms)
      Ã”ÃªÃœ debe loggear requests de autenticaciâ”œâ”‚n (1 ms)
    inputValidator
      Ã”ÃªÃœ debe sanitizar strings en el body (4 ms)
      Ã”ÃªÃœ debe sanitizar strings en el query (1 ms)
      Ã”ÃªÃœ debe manejar valores no string sin modificar (1 ms)
      Ã”ÃªÃœ debe hacer trim de espacios (2 ms)
      Ã”ÃªÃœ debe manejar body y query vacâ”œÂ¡os (1 ms)

PASS Biblioteca Xonler tests/unit/db/usuarios.db.test.js
  usuarios.db
    getById
      Ã”ÃªÃœ debe obtener usuario por ID (2 ms)
      Ã”ÃªÃœ debe retornar null si usuario no existe
      Ã”ÃªÃœ debe inicializar preferencias como objeto vacâ”œÂ¡o si es null (2 ms)
      Ã”ÃªÃœ debe manejar errores (13 ms)
    getByEmail
      Ã”ÃªÃœ debe obtener usuario por email (1 ms)
      Ã”ÃªÃœ debe retornar null si usuario no existe (1 ms)
    saveTwoFASecret
      Ã”ÃªÃœ debe guardar secreto 2FA (1 ms)
    enableTwoFA
      Ã”ÃªÃœ debe activar 2FA para usuario (1 ms)
    disableTwoFA
      Ã”ÃªÃœ debe desactivar 2FA para usuario (1 ms)

  console.log
    [dotenv@17.2.3] injecting env (58) from .env -- tip: Ã”ÃœÃ–Â´Â©Ã…  suppress all logs with { quiet: true }

      at _log (node_modules/dotenv/lib/main.js:142:11)

PASS Biblioteca Xonler tests/unit/bootstrap/register-rate-limiters.test.js
  register-rate-limiters
    registerRateLimiters
      Ã”ÃªÃœ debe registrar rate limiters (15 ms)

PASS Biblioteca Xonler tests/unit/controllers/libros.controller.complete.test.js
  libros.controller - cobertura completa
    handleControllerError
      Ã”ÃªÃœ debe manejar AppError con details (2 ms)
      Ã”ÃªÃœ debe manejar error 42P01 (tabla no encontrada) (2 ms)
      Ã”ÃªÃœ debe manejar error 42703 (columna no encontrada) (1 ms)
    obtenerLibros
      Ã”ÃªÃœ debe retornar resultado exitoso
    obtenerLibroPorId
      Ã”ÃªÃœ debe retornar 404 si libro no existe (1 ms)
    subirImagenLibro
      Ã”ÃªÃœ debe retornar 400 si no hay archivo (1 ms)
      Ã”ÃªÃœ debe actualizar imagen si hay archivo (1 ms)
    obtenerRecomendaciones
      Ã”ÃªÃœ debe retornar recomendaciones exitosamente (1 ms)
      Ã”ÃªÃœ debe manejar errores del servicio (2 ms)

PASS Biblioteca Xonler tests/unit/controllers/bibliotecas.controller.additional.test.js
  bibliotecas.controller - casos adicionales
    actualizarBiblioteca - casos edge
      Ã”ÃªÃœ debe manejar error de foreign key (31 ms)
      Ã”ÃªÃœ debe manejar colegio_id null (1 ms)
    eliminarBiblioteca - casos edge
      Ã”ÃªÃœ debe retornar 409 si tiene libros asociados (2 ms)
      Ã”ÃªÃœ debe retornar 404 si la biblioteca no existe (2 ms)
      Ã”ÃªÃœ debe manejar errores en transacciâ”œâ”‚n (1 ms)

PASS Biblioteca Xonler tests/unit/controllers/roles.controller.test.js
  roles.controller
    Ã”ÃªÃœ debe exportar obtenerRoles (3 ms)
    Ã”ÃªÃœ debe exportar obtenerRolPorId (2 ms)
    Ã”ÃªÃœ debe usar getAllRecords para obtenerRoles (1 ms)
    Ã”ÃªÃœ debe usar getRecordById para obtenerRolPorId (1 ms)

PASS Biblioteca Xonler tests/unit/bootstrap/register-error-handlers.complete.test.js
  register-error-handlers - cobertura completa
    Ã”ÃªÃœ debe registrar middleware de errores (1 ms)
    Error handler middleware
      Ã”ÃªÃœ debe manejar SyntaxError de JSON (1 ms)
      Ã”ÃªÃœ debe manejar error 23505 (unique constraint) (2 ms)
      Ã”ÃªÃœ debe manejar error 23503 (foreign key) (1 ms)
      Ã”ÃªÃœ debe manejar error genâ”œÂ®rico (1 ms)
      Ã”ÃªÃœ debe llamar next si headers ya fueron enviados (1 ms)
    404 handler middleware
      Ã”ÃªÃœ debe retornar 404 para rutas no encontradas (1 ms)

PASS Biblioteca Xonler tests/unit/routes/libros.routes.complete.test.js
  libros.routes - cobertura completa
    GET /test-db
      Ã”ÃªÃœ debe retornar timestamp de base de datos (4 ms)
      Ã”ÃªÃœ debe manejar error de conexiâ”œâ”‚n (1 ms)
    GET /test-table
      Ã”ÃªÃœ debe retornar informaciâ”œâ”‚n de tabla (1 ms)
      Ã”ÃªÃœ debe manejar error al verificar tabla (1 ms)
    GET /
      Ã”ÃªÃœ debe retornar lista de libros (23 ms)
      Ã”ÃªÃœ debe manejar error al obtener libros (1 ms)
    GET /:id
      Ã”ÃªÃœ debe retornar libro por ID (2 ms)
      Ã”ÃªÃœ debe retornar 400 si ID es invâ”œÃ­lido (4 ms)
      Ã”ÃªÃœ debe retornar 400 si ID es negativo (1 ms)
      Ã”ÃªÃœ debe retornar 404 si libro no existe (1 ms)
      Ã”ÃªÃœ debe manejar error al obtener libro (1 ms)

  console.log
    Â­Æ’Ã´Ã¨ [MONITORING] Monitoreo en tiempo real iniciado (intervalo: 30000ms)

      at RealtimeMonitoring.log [as startMonitoring] (src/utils/realtime-monitoring.js:58:13)

PASS Biblioteca Xonler tests/unit/config/database-ssl.complete.test.js
  database-ssl - cobertura completa
    createSecurePool
      Ã”ÃªÃœ debe crear pool sin SSL en desarrollo (3 ms)
      Ã”ÃªÃœ debe crear pool con SSL en producciâ”œâ”‚n (3 ms)
      Ã”ÃªÃœ debe crear pool con SSL opcional en desarrollo (4 ms)
      Ã”ÃªÃœ debe registrar event handlers (1 ms)
      Ã”ÃªÃœ debe probar conexiâ”œâ”‚n exitosamente (1 ms)
      Ã”ÃªÃœ debe manejar error en testConnection (1 ms)
      Ã”ÃªÃœ debe retornar estadâ”œÂ¡sticas del pool (2 ms)
      Ã”ÃªÃœ debe cerrar pool correctamente (1 ms)
      Ã”ÃªÃœ debe manejar error al cerrar pool (1 ms)
    getSSLConfig
      Ã”ÃªÃœ debe retornar configuraciâ”œâ”‚n para development (4 ms)
      Ã”ÃªÃœ debe retornar configuraciâ”œâ”‚n para staging (4 ms)
      Ã”ÃªÃœ debe retornar configuraciâ”œâ”‚n para production (1 ms)
      Ã”ÃªÃœ debe usar development como default (1 ms)
    validateSSLConfig
      Ã”ÃªÃœ debe validar configuraciâ”œâ”‚n bâ”œÃ­sica (1 ms)
      Ã”ÃªÃœ debe advertir sobre variables faltantes (4 ms)
      Ã”ÃªÃœ debe requerir SSL vars en producciâ”œâ”‚n (1 ms)
      Ã”ÃªÃœ debe validar SSL vars en producciâ”œâ”‚n (1 ms)

PASS Biblioteca Xonler tests/unit/utils/controller-helpers.test.js
  controller-helpers
    getAllRecords
      Ã”ÃªÃœ debe obtener todos los registros de una tabla (2 ms)
      Ã”ÃªÃœ debe usar campos personalizados (1 ms)
    getRecordById
      Ã”ÃªÃœ debe obtener un registro por ID (1 ms)
      Ã”ÃªÃœ debe retornar notFound si no existe el registro (13 ms)
      Ã”ÃªÃœ debe usar campo ID personalizado (2 ms)
    createCrudController
      Ã”ÃªÃœ debe crear un controlador CRUD con opciones por defecto (5 ms)
      Ã”ÃªÃœ debe usar opciones personalizadas (2 ms)

PASS Biblioteca Xonler tests/unit/controllers/biblioteca-libros.controller.test.js
  biblioteca-libros.controller
    obtenerBibliotecaLibros
      Ã”ÃªÃœ debe obtener biblioteca-libros sin filtros (3 ms)
      Ã”ÃªÃœ debe filtrar por biblioteca_id (1 ms)
      Ã”ÃªÃœ debe filtrar por libro_id (1 ms)
    obtenerBibliotecaLibroPorId
      Ã”ÃªÃœ debe obtener biblioteca-libro por ID (2 ms)
      Ã”ÃªÃœ debe retornar 404 si no existe
    crearBibliotecaLibro
      Ã”ÃªÃœ debe crear biblioteca-libro exitosamente (1 ms)
      Ã”ÃªÃœ debe retornar 400 si faltan campos

PASS Biblioteca Xonler tests/unit/controllers/usuarios.controller.edge.test.js
  usuarios.controller - casos edge
    obtenerUsuarios
      Ã”ÃªÃœ debe filtrar por rol (3 ms)
      Ã”ÃªÃœ debe filtrar por bâ”œâ•‘squeda (1 ms)
      Ã”ÃªÃœ debe filtrar por rol y bâ”œâ•‘squeda (1 ms)
      Ã”ÃªÃœ debe manejar errores (2 ms)
    obtenerUsuarioActual
      Ã”ÃªÃœ debe obtener usuario actual exitosamente (1 ms)
      Ã”ÃªÃœ debe retornar 401 si no estâ”œÃ­ autenticado (38 ms)
      Ã”ÃªÃœ debe retornar 404 si el usuario no existe (1 ms)
      Ã”ÃªÃœ debe manejar errores (2 ms)

  console.error
    Error obteniendo uso de disco: Error: Stat error
        at Object.<anonymous> (C:\Users\MIGUEL\Documents\Proyectos-Cursor\biblioteca-xonler-main\tests\unit\utils\realtime-monitoring.complete.test.js:56:15)
        at C:\Users\MIGUEL\Documents\Proyectos-Cursor\biblioteca-xonler-main\node_modules\jest-mock\build\index.js:397:39
        at Object.<anonymous> (C:\Users\MIGUEL\Documents\Proyectos-Cursor\biblioteca-xonler-main\node_modules\jest-mock\build\index.js:404:13)
        at Object.mockConstructor [as statSync] (C:\Users\MIGUEL\Documents\Proyectos-Cursor\biblioteca-xonler-main\node_modules\jest-mock\build\index.js:148:19)
        at RealtimeMonitoring.statSync [as getDiskUsage] (C:\Users\MIGUEL\Documents\Proyectos-Cursor\biblioteca-xonler-main\src\utils\realtime-monitoring.js:164:10)
        at Object.getDiskUsage (C:\Users\MIGUEL\Documents\Proyectos-Cursor\biblioteca-xonler-main\tests\unit\utils\realtime-monitoring.complete.test.js:59:44)
        at Promise.then.completed (C:\Users\MIGUEL\Documents\Proyectos-Cursor\biblioteca-xonler-main\node_modules\jest-circus\build\utils.js:298:28)
        at new Promise (<anonymous>)
        at callAsyncCircusFn (C:\Users\MIGUEL\Documents\Proyectos-Cursor\biblioteca-xonler-main\node_modules\jest-circus\build\utils.js:231:10)
        at _callCircusTest (C:\Users\MIGUEL\Documents\Proyectos-Cursor\biblioteca-xonler-main\node_modules\jest-circus\build\run.js:316:40)
        at processTicksAndRejections (node:internal/process/task_queues:105:5)
        at _runTest (C:\Users\MIGUEL\Documents\Proyectos-Cursor\biblioteca-xonler-main\node_modules\jest-circus\build\run.js:252:3)
        at _runTestsForDescribeBlock (C:\Users\MIGUEL\Documents\Proyectos-Cursor\biblioteca-xonler-main\node_modules\jest-circus\build\run.js:126:9)
        at _runTestsForDescribeBlock (C:\Users\MIGUEL\Documents\Proyectos-Cursor\biblioteca-xonler-main\node_modules\jest-circus\build\run.js:121:9)
        at _runTestsForDescribeBlock (C:\Users\MIGUEL\Documents\Proyectos-Cursor\biblioteca-xonler-main\node_modules\jest-circus\build\run.js:121:9)
        at run (C:\Users\MIGUEL\Documents\Proyectos-Cursor\biblioteca-xonler-main\node_modules\jest-circus\build\run.js:71:3)
        at runAndTransformResultsToJestFormat (C:\Users\MIGUEL\Documents\Proyectos-Cursor\biblioteca-xonler-main\node_modules\jest-circus\build\legacy-code-todo-rewrite\jestAdapterInit.js:122:21)
        at jestAdapter (C:\Users\MIGUEL\Documents\Proyectos-Cursor\biblioteca-xonler-main\node_modules\jest-circus\build\legacy-code-todo-rewrite\jestAdapter.js:79:19)
        at runTestInternal (C:\Users\MIGUEL\Documents\Proyectos-Cursor\biblioteca-xonler-main\node_modules\jest-runner\build\runTest.js:367:16)
        at runTest (C:\Users\MIGUEL\Documents\Proyectos-Cursor\biblioteca-xonler-main\node_modules\jest-runner\build\runTest.js:444:34)
        at Object.worker (C:\Users\MIGUEL\Documents\Proyectos-Cursor\biblioteca-xonler-main\node_modules\jest-runner\build\testWorker.js:106:12)

    [0m [90m 172 |[39m       }[33m;[39m
     [90m 173 |[39m     } [36mcatch[39m (error) {
    [31m[1m>[22m[39m[90m 174 |[39m       console[33m.[39merror([32m'Error obteniendo uso de disco:'[39m[33m,[39m error)[33m;[39m
     [90m     |[39m               [31m[1m^[22m[39m
     [90m 175 |[39m       [36mreturn[39m {
     [90m 176 |[39m         total[33m:[39m [35m0[39m[33m,[39m
     [90m 177 |[39m         used[33m:[39m [35m0[39m[33m,[39m[0m

      at RealtimeMonitoring.error [as getDiskUsage] (src/utils/realtime-monitoring.js:174:15)
      at Object.getDiskUsage (tests/unit/utils/realtime-monitoring.complete.test.js:59:44)

PASS Biblioteca Xonler tests/unit/controllers/admin-biblioteca.controller.complete.test.js
  admin-biblioteca.controller - cobertura completa
    obtenerBibliotecaAsignada - casos edge
      Ã”ÃªÃœ debe manejar error de base de datos (5 ms)
    obtenerEstadisticasBiblioteca - casos edge
      Ã”ÃªÃœ debe manejar error de base de datos (3 ms)
    obtenerLibrosBiblioteca - casos edge
      Ã”ÃªÃœ debe manejar error de base de datos (2 ms)
    agregarLibroABiblioteca - casos edge
      Ã”ÃªÃœ debe manejar error de base de datos (4 ms)
    removerLibroDeBiblioteca - casos edge
      Ã”ÃªÃœ debe manejar error de base de datos (3 ms)
    crearLibro - casos edge
      Ã”ÃªÃœ debe manejar error de base de datos (2 ms)

PASS Biblioteca Xonler tests/unit/utils/realtime-monitoring.complete.test.js
  realtime-monitoring - cobertura completa
    getDiskUsage - casos edge
      Ã”ÃªÃœ debe retornar valores por defecto si hay error (156 ms)
    calculateAverageResponseTime
      Ã”ÃªÃœ debe retornar 0 si no hay tiempos (2 ms)
      Ã”ÃªÃœ debe calcular promedio correctamente (8 ms)
    recordRequest - casos edge
      Ã”ÃªÃœ debe limitar tamaâ”œâ–’o de responseTimes (3 ms)
    checkThresholds - casos edge
      Ã”ÃªÃœ debe manejar error en alertas (7 ms)

PASS Biblioteca Xonler tests/unit/utils/app-error.test.js
  app-error
    constructor
      Ã”ÃªÃœ debe crear instancia con mensaje y statusCode (2 ms)
      Ã”ÃªÃœ debe crear instancia con details (1 ms)
      Ã”ÃªÃœ debe crear instancia sin details
      Ã”ÃªÃœ debe tener stack trace (9 ms)

PASS Biblioteca Xonler tests/unit/controllers/twofa.controller.test.js
  twofa.controller
    get2FAStatus
      Ã”ÃªÃœ debe obtener estado 2FA del usuario (4 ms)
      Ã”ÃªÃœ debe retornar 404 si el usuario no existe (1 ms)
      Ã”ÃªÃœ debe manejar errores (1 ms)
    setup2FA
      Ã”ÃªÃœ debe configurar 2FA exitosamente (4 ms)
      Ã”ÃªÃœ debe retornar 401 si no hay usuario autenticado
      Ã”ÃªÃœ debe retornar 404 si el usuario no existe
      Ã”ÃªÃœ debe retornar 500 si no se puede guardar el secreto (1 ms)
    verify2FA
      Ã”ÃªÃœ debe verificar y activar 2FA exitosamente (6 ms)
      Ã”ÃªÃœ debe retornar 400 si falta el câ”œâ”‚digo (1 ms)
      Ã”ÃªÃœ debe retornar 400 si el câ”œâ”‚digo es invâ”œÃ­lido (2 ms)
    disable2FA
      Ã”ÃªÃœ debe desactivar 2FA exitosamente (5 ms)
      Ã”ÃªÃœ debe retornar 404 si el usuario no existe (2 ms)
    verify2FALogin
      Ã”ÃªÃœ debe verificar câ”œâ”‚digo 2FA en login exitosamente (4 ms)
      Ã”ÃªÃœ debe retornar 400 si faltan parâ”œÃ­metros
      Ã”ÃªÃœ debe retornar 401 si el token es invâ”œÃ­lido
    generatePending2FAToken
      Ã”ÃªÃœ debe generar token pendiente de 2FA (1 ms)

PASS Biblioteca Xonler tests/unit/middleware/auth.test.js
  middleware/auth
    auth
      Ã”ÃªÃœ debe retornar 401 si no hay token (3 ms)
      Ã”ÃªÃœ debe autenticar correctamente con token vâ”œÃ­lido (1 ms)
      Ã”ÃªÃœ debe manejar errores de token expirado (1 ms)
      Ã”ÃªÃœ debe manejar errores de token invâ”œÃ­lido (1 ms)
      Ã”ÃªÃœ debe manejar errores del servidor (2 ms)
    requireRole
      Ã”ÃªÃœ debe re-exportar requireRole de auth-middleware-helpers (1 ms)
    requireAnyRole
      Ã”ÃªÃœ debe re-exportar requireAnyRole de auth-middleware-helpers (1 ms)
    requireOwnershipOrAdmin
      Ã”ÃªÃœ debe re-exportar requireOwnershipOrAdmin de auth-middleware-helpers (1 ms)
    checkPermission
      Ã”ÃªÃœ debe re-exportar checkPermission de auth-middleware-helpers (1 ms)

PASS Biblioteca Xonler tests/unit/bootstrap/register-security-headers.complete.test.js
  register-security-headers - cobertura completa
    Ã”ÃªÃœ debe registrar middleware de security headers (2 ms)
    Security headers middleware
      Ã”ÃªÃœ debe establecer X-Content-Type-Options (1 ms)
      Ã”ÃªÃœ debe establecer X-Frame-Options (1 ms)
      Ã”ÃªÃœ debe establecer X-XSS-Protection (1 ms)
      Ã”ÃªÃœ debe establecer Referrer-Policy (2 ms)
      Ã”ÃªÃœ debe establecer Permissions-Policy (1 ms)
      Ã”ÃªÃœ debe establecer Content-Security-Policy
      Ã”ÃªÃœ debe llamar next
    buildContentSecurityPolicy
      Ã”ÃªÃœ debe construir CSP con todas las directivas (2 ms)

PASS Biblioteca Xonler tests/unit/utils/simple-jwt.additional.test.js
  simple-jwt - casos adicionales
    generateToken - casos edge
      Ã”ÃªÃœ debe usar variables de entorno si estâ”œÃ­n configuradas (3 ms)
      Ã”ÃªÃœ debe sobrescribir opciones por defecto (1 ms)
    verifyToken - casos edge
      Ã”ÃªÃœ debe usar variables de entorno para verificaciâ”œâ”‚n (1 ms)
      Ã”ÃªÃœ debe lanzar error genâ”œÂ®rico si la verificaciâ”œâ”‚n falla (16 ms)
    decodeToken
      Ã”ÃªÃœ debe decodificar token sin verificar (2 ms)

PASS Biblioteca Xonler tests/unit/controllers/usuarios.controller.complete.test.js
  usuarios.controller - casos completos
    eliminarUsuarioCompleto - casos de error
      Ã”ÃªÃœ debe manejar error de foreign key constraint (3 ms)
      Ã”ÃªÃœ debe manejar error de not null constraint (41 ms)
      Ã”ÃªÃœ debe manejar error de unique constraint (11 ms)
      Ã”ÃªÃœ debe manejar error general (2 ms)

PASS Biblioteca Xonler tests/unit/bootstrap/register-security-headers.test.js
  register-security-headers
    registerSecurityHeaders
      Ã”ÃªÃœ debe registrar headers de seguridad (7 ms)

PASS Biblioteca Xonler tests/unit/controllers/libros.controller.additional.test.js
  libros.controller - casos adicionales
    handleControllerError - casos edge
      Ã”ÃªÃœ debe manejar AppError con details (2 ms)
      Ã”ÃªÃœ debe manejar error genâ”œÂ®rico en obtenerLibroPorId (1 ms)
      Ã”ÃªÃœ debe manejar error 42P01 en crearLibro (1 ms)
      Ã”ÃªÃœ debe manejar error 42703 en actualizarLibro (1 ms)
      Ã”ÃªÃœ debe manejar error genâ”œÂ®rico en eliminarLibro (2 ms)

PASS Biblioteca Xonler tests/unit/controllers/usuarios.controller.more.test.js
  usuarios.controller - funciones adicionales 2
    actualizarUsuario
      Ã”ÃªÃœ debe actualizar usuario exitosamente (3 ms)
      Ã”ÃªÃœ debe retornar 404 si el usuario no existe (1 ms)
    eliminarUsuario
      Ã”ÃªÃœ debe eliminar usuario exitosamente (1 ms)
      Ã”ÃªÃœ debe retornar 404 si el usuario no existe
      Ã”ÃªÃœ debe retornar 400 si tiene prâ”œÂ®stamos activos

PASS Biblioteca Xonler tests/unit/routes/prestamos.routes.complete.test.js
  prestamos.routes - cobertura completa
    GET /test
      Ã”ÃªÃœ debe retornar mensaje de test (2 ms)
    GET /test-db
      Ã”ÃªÃœ debe retornar informaciâ”œâ”‚n de base de datos (2 ms)
      Ã”ÃªÃœ debe manejar error en test-db (2 ms)

FAIL Biblioteca Xonler tests/unit/public/services/component-loader.services.test.js
  Ã”Ã¹Ã… Test suite failed to run

    Cannot find module '../../../public/services/component-loader.services.js' from 'tests/unit/public/services/component-loader.services.test.js'

      21 |
      22 | jest.resetModules();
    > 23 | const componentLoaderModule = require('../../../public/services/component-loader.services.js');
         |                               ^
      24 | // El mâ”œâ”‚dulo exporta componentLoader como propiedad nombrada
      25 | // Babel transforma: export { componentLoader } -> module.exports.componentLoader
      26 | const componentLoader = componentLoaderModule.componentLoader;

      at Resolver._throwModNotFoundError (node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.require (tests/unit/public/services/component-loader.services.test.js:23:31)

FAIL Biblioteca Xonler tests/unit/public/services/contacto.services.test.js
  Ã”Ã¹Ã… Test suite failed to run

    Cannot find module '../../../public/services/common/form-handler.js' from 'tests/unit/public/services/contacto.services.test.js'

      41 |
      42 | // Mock de form-handler y api-client
    > 43 | jest.mock('../../../public/services/common/form-handler.js', () => ({
         |      ^
      44 |   handleFormSubmit: jest.fn((form, handler, options) => handler({})),
      45 |   showError: jest.fn(),
      46 |   showSuccess: jest.fn(),

      at Resolver._throwModNotFoundError (node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.mock (tests/unit/public/services/contacto.services.test.js:43:6)

FAIL Biblioteca Xonler tests/unit/public/js/admin-functions.test.js
  Ã”Ã¹Ã… Test suite failed to run

    ENOENT: no such file or directory, open 'C:\Users\MIGUEL\Documents\Proyectos-Cursor\biblioteca-xonler-main\tests\public\js\admin-functions.js'

      91 | const path = require('path');
      92 |
    > 93 | const adminFunctionsCode = fs.readFileSync(
         |                               ^
      94 |   path.join(__dirname, '../../../public/js/admin-functions.js'),
      95 |   'utf8'
      96 | );

      at Object.readFileSync (tests/unit/public/js/admin-functions.test.js:93:31)

FAIL Biblioteca Xonler tests/unit/public/services/common/api-client.test.js
  Ã”Ã¹Ã… Test suite failed to run

    Cannot find module '../../../../public/services/common/api-client.js' from 'tests/unit/public/services/common/api-client.test.js'

      45 |
      46 | jest.resetModules();
    > 47 | const apiClient = require('../../../../public/services/common/api-client.js');
         |                   ^
      48 |
      49 | // ============================================================================
      50 | // TESTS

      at Resolver._throwModNotFoundError (node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.require (tests/unit/public/services/common/api-client.test.js:47:19)

FAIL Biblioteca Xonler tests/unit/public/services/bibliotecas.services.test.js
  Ã”Ã¹Ã… Test suite failed to run

    Cannot find module '../../../public/services/bibliotecas.services.js' from 'tests/unit/public/services/bibliotecas.services.test.js'

      21 |
      22 | jest.resetModules();
    > 23 | const bibliotecasService = require('../../../public/services/bibliotecas.services.js');
         |                            ^
      24 |
      25 | // ============================================================================
      26 | // TESTS

      at Resolver._throwModNotFoundError (node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.require (tests/unit/public/services/bibliotecas.services.test.js:23:28)

FAIL Biblioteca Xonler tests/unit/public/services/libros.services.test.js
  Ã”Ã¹Ã… Test suite failed to run

    Cannot find module '../../../public/services/libros.services.js' from 'tests/unit/public/services/libros.services.test.js'

      127 | const loadLibrosService = () => {
      128 |   jest.resetModules(); // Limpia el cache de mâ”œâ”‚dulos
    > 129 |   const mod = require('../../../public/services/libros.services.js');
          |               ^
      130 |   librosService = {
      131 |     default: mod.default || mod,
      132 |     authHeaders: mod.authHeaders,

      at Resolver._throwModNotFoundError (node_modules/jest-resolve/build/resolver.js:427:11)
      at require (tests/unit/public/services/libros.services.test.js:129:15)
      at Object.loadLibrosService (tests/unit/public/services/libros.services.test.js:145:1)

FAIL Biblioteca Xonler tests/unit/app.test.js
  Ã”Ã¹Ã… Test suite failed to run

    Cannot find module '../src/bootstrap/register-base-middleware' from 'tests/unit/app.test.js'

      1 | // Mock de todas las dependencias (estas se pueden hacer con jest.mock normal)
    > 2 | jest.mock('../src/bootstrap/register-base-middleware', () => ({
        |      ^
      3 |   registerBaseMiddleware: jest.fn()
      4 | }));
      5 |

      at Resolver._throwModNotFoundError (node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.mock (tests/unit/app.test.js:2:6)

FAIL Biblioteca Xonler tests/unit/public/services/admin-biblioteca.services.test.js
  Ã”Ã¹Ã… Test suite failed to run

    TypeError: Cannot assign to read only property 'replace' of object '[object Location]'

      at node_modules/@jest/environment-jsdom-abstract/node_modules/jest-mock/build/index.js:622:31

FAIL Biblioteca Xonler tests/unit/public/services/auth.services.test.js
  Ã”Ã¹Ã… Test suite failed to run

    Cannot find module '../../../public/services/auth.services.js' from 'tests/unit/public/services/auth.services.test.js'

      75 | // Usar jest.resetModules() para asegurar que el mâ”œâ”‚dulo se carga limpio
      76 | jest.resetModules();
    > 77 | require('../../../public/services/auth.services.js');
         | ^
      78 |
      79 | // La clase AuthService estâ”œÃ­ definida en el mâ”œâ”‚dulo pero no exportada
      80 | // El mâ”œâ”‚dulo crea una instancia en globalThis.authService

      at Resolver._throwModNotFoundError (node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.require (tests/unit/public/services/auth.services.test.js:77:1)

FAIL Biblioteca Xonler tests/unit/public/services/common/form-handler.test.js
  Ã”Ã¹Ã… Test suite failed to run

    Cannot find module '../../../../public/services/common/form-handler.js' from 'tests/unit/public/services/common/form-handler.test.js'

      19 |
      20 | jest.resetModules();
    > 21 | const formHandler = require('../../../../public/services/common/form-handler.js');
         |                     ^
      22 |
      23 | // ============================================================================
      24 | // TESTS

      at Resolver._throwModNotFoundError (node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.require (tests/unit/public/services/common/form-handler.test.js:21:21)

A worker process has failed to exit gracefully and has been force exited. This is likely caused by tests leaking due to improper teardown. Try running with --detectOpenHandles to find leaks. Active timers can also cause this, ensure that .unref() was called on them.
Summary of all failing tests
FAIL tests/unit/public/services/component-loader.services.test.js
  Ã”Ã¹Ã… Test suite failed to run

    Cannot find module '../../../public/services/component-loader.services.js' from 'tests/unit/public/services/component-loader.services.test.js'

      21 |
      22 | jest.resetModules();
    > 23 | const componentLoaderModule = require('../../../public/services/component-loader.services.js');
         |                               ^
      24 | // El mâ”œâ”‚dulo exporta componentLoader como propiedad nombrada
      25 | // Babel transforma: export { componentLoader } -> module.exports.componentLoader
      26 | const componentLoader = componentLoaderModule.componentLoader;

      at Resolver._throwModNotFoundError (node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.require (tests/unit/public/services/component-loader.services.test.js:23:31)

FAIL tests/unit/public/services/contacto.services.test.js
  Ã”Ã¹Ã… Test suite failed to run

    Cannot find module '../../../public/services/common/form-handler.js' from 'tests/unit/public/services/contacto.services.test.js'

      41 |
      42 | // Mock de form-handler y api-client
    > 43 | jest.mock('../../../public/services/common/form-handler.js', () => ({
         |      ^
      44 |   handleFormSubmit: jest.fn((form, handler, options) => handler({})),
      45 |   showError: jest.fn(),
      46 |   showSuccess: jest.fn(),

      at Resolver._throwModNotFoundError (node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.mock (tests/unit/public/services/contacto.services.test.js:43:6)

FAIL tests/unit/public/js/admin-functions.test.js
  Ã”Ã¹Ã… Test suite failed to run

    ENOENT: no such file or directory, open 'C:\Users\MIGUEL\Documents\Proyectos-Cursor\biblioteca-xonler-main\tests\public\js\admin-functions.js'

      91 | const path = require('path');
      92 |
    > 93 | const adminFunctionsCode = fs.readFileSync(
         |                               ^
      94 |   path.join(__dirname, '../../../public/js/admin-functions.js'),
      95 |   'utf8'
      96 | );

      at Object.readFileSync (tests/unit/public/js/admin-functions.test.js:93:31)

FAIL tests/unit/public/services/common/api-client.test.js
  Ã”Ã¹Ã… Test suite failed to run

    Cannot find module '../../../../public/services/common/api-client.js' from 'tests/unit/public/services/common/api-client.test.js'

      45 |
      46 | jest.resetModules();
    > 47 | const apiClient = require('../../../../public/services/common/api-client.js');
         |                   ^
      48 |
      49 | // ============================================================================
      50 | // TESTS

      at Resolver._throwModNotFoundError (node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.require (tests/unit/public/services/common/api-client.test.js:47:19)

FAIL tests/unit/public/services/bibliotecas.services.test.js
  Ã”Ã¹Ã… Test suite failed to run

    Cannot find module '../../../public/services/bibliotecas.services.js' from 'tests/unit/public/services/bibliotecas.services.test.js'

      21 |
      22 | jest.resetModules();
    > 23 | const bibliotecasService = require('../../../public/services/bibliotecas.services.js');
         |                            ^
      24 |
      25 | // ============================================================================
      26 | // TESTS

      at Resolver._throwModNotFoundError (node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.require (tests/unit/public/services/bibliotecas.services.test.js:23:28)

FAIL tests/unit/public/services/libros.services.test.js
  Ã”Ã¹Ã… Test suite failed to run

    Cannot find module '../../../public/services/libros.services.js' from 'tests/unit/public/services/libros.services.test.js'

      127 | const loadLibrosService = () => {
      128 |   jest.resetModules(); // Limpia el cache de mâ”œâ”‚dulos
    > 129 |   const mod = require('../../../public/services/libros.services.js');
          |               ^
      130 |   librosService = {
      131 |     default: mod.default || mod,
      132 |     authHeaders: mod.authHeaders,

      at Resolver._throwModNotFoundError (node_modules/jest-resolve/build/resolver.js:427:11)
      at require (tests/unit/public/services/libros.services.test.js:129:15)
      at Object.loadLibrosService (tests/unit/public/services/libros.services.test.js:145:1)

FAIL tests/unit/app.test.js
  Ã”Ã¹Ã… Test suite failed to run

    Cannot find module '../src/bootstrap/register-base-middleware' from 'tests/unit/app.test.js'

      1 | // Mock de todas las dependencias (estas se pueden hacer con jest.mock normal)
    > 2 | jest.mock('../src/bootstrap/register-base-middleware', () => ({
        |      ^
      3 |   registerBaseMiddleware: jest.fn()
      4 | }));
      5 |

      at Resolver._throwModNotFoundError (node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.mock (tests/unit/app.test.js:2:6)

FAIL tests/unit/public/services/admin-biblioteca.services.test.js
  Ã”Ã¹Ã… Test suite failed to run

    TypeError: Cannot assign to read only property 'replace' of object '[object Location]'

      at node_modules/@jest/environment-jsdom-abstract/node_modules/jest-mock/build/index.js:622:31

FAIL tests/unit/public/services/auth.services.test.js
  Ã”Ã¹Ã… Test suite failed to run

    Cannot find module '../../../public/services/auth.services.js' from 'tests/unit/public/services/auth.services.test.js'

      75 | // Usar jest.resetModules() para asegurar que el mâ”œâ”‚dulo se carga limpio
      76 | jest.resetModules();
    > 77 | require('../../../public/services/auth.services.js');
         | ^
      78 |
      79 | // La clase AuthService estâ”œÃ­ definida en el mâ”œâ”‚dulo pero no exportada
      80 | // El mâ”œâ”‚dulo crea una instancia en globalThis.authService

      at Resolver._throwModNotFoundError (node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.require (tests/unit/public/services/auth.services.test.js:77:1)

FAIL tests/unit/public/services/common/form-handler.test.js
  Ã”Ã¹Ã… Test suite failed to run

    Cannot find module '../../../../public/services/common/form-handler.js' from 'tests/unit/public/services/common/form-handler.test.js'

      19 |
      20 | jest.resetModules();
    > 21 | const formHandler = require('../../../../public/services/common/form-handler.js');
         |                     ^
      22 |
      23 | // ============================================================================
      24 | // TESTS

      at Resolver._throwModNotFoundError (node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.require (tests/unit/public/services/common/form-handler.test.js:21:21)


Test Suites: 10 failed, 87 passed, 97 total
Tests:       862 passed, 862 total
Snapshots:   0 total
Time:        17.82 s
Ran all test suites.
Force exiting Jest: Have you considered using `--detectOpenHandles` to detect async operations that kept running after all tests finished?
