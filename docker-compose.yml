version: "3.9"

services:
  db:
    image: postgres:15-alpine
    container_name: pg-main
    restart: unless-stopped
    environment:
      POSTGRES_DB: ${DB_NAME:-xonler}
      POSTGRES_USER: ${DB_USER:-postgres}
      POSTGRES_PASSWORD: ${DB_PASSWORD:-postgres}
    ports:
      - "${DB_PORT:-5432}:5432"
    volumes:
      - db-data:/var/lib/postgresql/data
      # Script SQL inicial
      - ./db.sql:/docker-entrypoint-initdb.d/init.sql:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER:-postgres} -d ${DB_NAME:-xonler}"]
      interval: 5s
      timeout: 3s
      retries: 20

  # Init job para crear base de datos sonarqube automáticamente
  db-init-sonar:
    image: postgres:15-alpine
    container_name: db-init-sonar
    restart: "no"
    depends_on:
      db:
        condition: service_healthy
    environment:
      POSTGRES_USER: ${DB_USER:-postgres}
      POSTGRES_PASSWORD: ${DB_PASSWORD:-postgres}
      PGPASSWORD: ${DB_PASSWORD:-postgres}
      SONAR_DB_PASSWORD: ${SONAR_DB_PASSWORD:-sonar}
      PGHOST: db
      PGPORT: 5432
    command: >
      sh -c "
        export PGPASSWORD=$${POSTGRES_PASSWORD} &&
        until pg_isready -h db -p 5432 -U $${POSTGRES_USER} -d postgres; do
          echo '⏳ Esperando a que PostgreSQL esté listo...'
          sleep 2
        done &&
        psql -h db -p 5432 -U $${POSTGRES_USER} -d postgres -c \"
          DO \\$\\$
          BEGIN
            IF NOT EXISTS (SELECT FROM pg_catalog.pg_roles WHERE rolname = 'sonar') THEN
              CREATE ROLE sonar WITH LOGIN ENCRYPTED PASSWORD '$${SONAR_DB_PASSWORD}';
            ELSE
              ALTER ROLE sonar WITH PASSWORD '$${SONAR_DB_PASSWORD}';
            END IF;
          END
          \\$\\$;
        \" &&
        psql -h db -p 5432 -U $${POSTGRES_USER} -d postgres -tc \"SELECT 1 FROM pg_database WHERE datname = 'sonarqube'\" | grep -q 1 ||
        psql -h db -p 5432 -U $${POSTGRES_USER} -d postgres -c \"CREATE DATABASE sonarqube OWNER sonar;\" &&
        psql -h db -p 5432 -U $${POSTGRES_USER} -d postgres -c \"GRANT ALL PRIVILEGES ON DATABASE sonarqube TO sonar;\" &&
        echo '✅ Configuración de SonarQube completada'
      "
    networks:
      - default

  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: web-app
    restart: unless-stopped
    depends_on:
      db:
        condition: service_healthy
    environment:
      NODE_ENV: ${NODE_ENV}
      PORT: ${PORT}
      HOST: ${HOST}
      # Variables de base de datos (conecta usando el nombre del servicio 'db')
      DB_HOST: db
      DB_PORT: ${DB_PORT:-5432}
      DB_NAME: ${DB_NAME:-xonler}
      DB_USER: ${DB_USER:-postgres}
      DB_PASSWORD: ${DB_PASSWORD:-postgres}
      # Configuración del Pool de Conexiones
      DB_POOL_MAX: ${DB_POOL_MAX}
      DB_POOL_IDLE_TIMEOUT: ${DB_POOL_IDLE_TIMEOUT}
      DB_POOL_CONNECTION_TIMEOUT: ${DB_POOL_CONNECTION_TIMEOUT}
      # Seguridad y Autenticación
      JWT_SECRET: ${JWT_SECRET}
      JWT_EXPIRES_IN: ${JWT_EXPIRES_IN}
      JWT_ISSUER: ${JWT_ISSUER}
      JWT_AUDIENCE: ${JWT_AUDIENCE}
      BCRYPT_ROUNDS: ${BCRYPT_ROUNDS}
      CORS_ORIGIN: ${CORS_ORIGIN}
      # Configuración de logs
      LOG_LEVEL: ${LOG_LEVEL}
      LOG_ENCRYPTION: ${LOG_ENCRYPTION}
      LOG_RETENTION_DAYS: ${LOG_RETENTION_DAYS}
      LOG_COMPRESSION: ${LOG_COMPRESSION}
      # Configuración de encriptación
      ENCRYPTION_KEY_DIR: ${ENCRYPTION_KEY_DIR}
      ENCRYPTION_PASSWORD: ${ENCRYPTION_PASSWORD}
      ENCRYPTION_SALT: ${ENCRYPTION_SALT}
      # Monitoreo y alertas
      MONITORING_INTERVAL: ${MONITORING_INTERVAL}
      MONITORING_THRESHOLD_CPU: ${MONITORING_THRESHOLD_CPU}
      MONITORING_THRESHOLD_MEMORY: ${MONITORING_THRESHOLD_MEMORY}
      MONITORING_THRESHOLD_DISK: ${MONITORING_THRESHOLD_DISK}
      MONITORING_THRESHOLD_RESPONSE_TIME: ${MONITORING_THRESHOLD_RESPONSE_TIME}
      MONITORING_THRESHOLD_ERROR_RATE: ${MONITORING_THRESHOLD_ERROR_RATE}
      MONITORING_MAX_RESPONSE_TIMES: ${MONITORING_MAX_RESPONSE_TIMES}
      ALERT_THRESHOLD_FAILED_LOGINS: ${ALERT_THRESHOLD_FAILED_LOGINS}
      ALERT_THRESHOLD_SUSPICIOUS: ${ALERT_THRESHOLD_SUSPICIOUS}
      ALERT_THRESHOLD_BLOCKED_IPS: ${ALERT_THRESHOLD_BLOCKED_IPS}
      ALERT_THRESHOLD_ERROR_RATE: ${ALERT_THRESHOLD_ERROR_RATE}
      ALERT_THRESHOLD_MEMORY: ${ALERT_THRESHOLD_MEMORY}
      ALERT_THRESHOLD_DISK: ${ALERT_THRESHOLD_DISK}
      ALERT_COOLDOWN_PERIOD: ${ALERT_COOLDOWN_PERIOD}
      SERVER_NAME: ${SERVER_NAME}
      # Otras variables
      FRONTEND_URL: ${FRONTEND_URL}
      COOKIE_DOMAIN: ${COOKIE_DOMAIN}
    ports:
      - "${PORT}:${PORT}"
    volumes:
      # Montar logs si quieres persistirlos
      - ./logs:/app/logs
    healthcheck:
      test: ["CMD-SHELL", "node -e \"require('http').get('http://localhost:${PORT}/api/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})\""]
      interval: 30s
      timeout: 3s
      start_period: 40s
      retries: 3
    command: >
      sh -c "
        echo '✅ Base de datos lista. Iniciando aplicación...' &&
        node --enable-source-maps src/server.js
      "

  # pgAdmin - Web UI para administración de PostgreSQL
  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: pgadmin
    restart: unless-stopped
    depends_on:
      db:
        condition: service_healthy
    ports:
      - "${PGADMIN_PORT:-30978}:80"
    environment:
      PGADMIN_DEFAULT_EMAIL: ${PGADMIN_DEFAULT_EMAIL:-admin@biblioteca-xonler.com}
      PGADMIN_DEFAULT_PASSWORD: ${PGADMIN_DEFAULT_PASSWORD:-admin}
      PGADMIN_CONFIG_SERVER_MODE: "False"
      PGADMIN_CONFIG_MASTER_PASSWORD_REQUIRED: "False"
    volumes:
      - pgadmin-data:/var/lib/pgadmin

  # Prometheus - Recolector de métricas
  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    restart: unless-stopped
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.console.templates=/etc/prometheus/consoles'
      - '--storage.tsdb.retention.time=200h'
      - '--web.enable-lifecycle'
    ports:
      - "${PROMETHEUS_PORT:-9090}:9090"
    volumes:
      - ./prometheus:/etc/prometheus
      - prometheus-data:/prometheus
    depends_on:
      - db
      - app
      - postgres-exporter
      - cadvisor

  # PostgreSQL Exporter - Métricas de PostgreSQL
  postgres-exporter:
    image: prometheuscommunity/postgres-exporter:latest
    container_name: postgres-exporter
    restart: unless-stopped
    environment:
      DATA_SOURCE_NAME: "postgresql://${DB_USER:-postgres}:${DB_PASSWORD:-postgres}@db:5432/${DB_NAME:-xonler}?sslmode=disable"
    ports:
      - "${POSTGRES_EXPORTER_PORT:-9187}:9187"
    depends_on:
      db:
        condition: service_healthy

  # cAdvisor - Métricas de contenedores Docker
  cadvisor:
    image: gcr.io/cadvisor/cadvisor:latest
    container_name: cadvisor
    restart: unless-stopped
    ports:
      - "8081:8080"
    volumes:
      - /:/rootfs:ro
      - /var/run:/var/run:ro
      - /sys:/sys:ro
      - /var/lib/docker/:/var/lib/docker:ro
      - /dev/disk/:/dev/disk:ro
    privileged: true
    devices:
      - /dev/kmsg

  # Grafana - Visualización de métricas
  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    restart: unless-stopped
    ports:
      - "${GRAFANA_PORT:-3001}:3000"
    environment:
      GF_USERS_ALLOW_SIGN_UP: "false"
      GF_SERVER_ROOT_URL: "http://localhost:${GRAFANA_PORT:-3001}"
    volumes:
      - grafana-data:/var/lib/grafana
      - ./grafana/provisioning:/etc/grafana/provisioning
    depends_on:
      - prometheus

  # Jenkins - CI/CD
  jenkins:
    image: jenkins/jenkins:lts
    container_name: jenkins
    restart: unless-stopped
    ports:
      - "${JENKINS_PORT:-18080}:8080"
      - "${JENKINS_AGENT_PORT:-50000}:50000"
    volumes:
      - jenkins_home:/var/jenkins_home
    environment:
      JENKINS_OPTS: "--httpPort=8080"
    user: root
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8080/login || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  sonarqube:
    image: sonarqube:community
    container_name: sonarqube
    restart: unless-stopped
    ports:
      - "9000:9000"
    environment:
      - SONAR_ES_BOOTSTRAP_CHECKS_DISABLE=true
      - SONAR_JDBC_URL=jdbc:postgresql://db:5432/sonarqube
      - SONAR_JDBC_USERNAME=sonar
      - SONAR_JDBC_PASSWORD=${SONAR_DB_PASSWORD:-sonar}
    volumes:
      - sonarqube_data:/opt/sonarqube/data
      - sonarqube_extensions:/opt/sonarqube/extensions
      - sonarqube_logs:/opt/sonarqube/logs
    depends_on:
      db:
        condition: service_healthy
      db-init-sonar:
        condition: service_started
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:9000/api/system/status || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5

volumes:
  db-data:
    driver: local
  pgadmin-data:
    driver: local
  prometheus-data:
    driver: local
  grafana-data:
    driver: local
  jenkins_home:
    driver: local
  sonarqube_data:
    driver: local
  sonarqube_extensions:
    driver: local
  sonarqube_logs:
    driver: local

